<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Analysis - StockMaster</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        :root {
            --orange:#FF7A00; --bg:#F9FAFB; --card:#FFFFFF; --topbar:#FFFFFF;
            --text:#111827; --sub:#6B7280; --border:#E5E7EB; --hover:#F3F4F6;
            --success:#10B981; --danger:#EF4444;
        }
        [data-theme="dark"] {
            --bg:#0F172A; --card:#1E293B; --topbar:#1E293B;
            --text:#F1F5F9; --sub:#94A3B8; --border:#334155; --hover:#334155;
        }
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s,color .3s;}

        /* TOPBAR */
        .topbar{background:var(--topbar);border-bottom:1px solid var(--border);padding:0 30px;height:70px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;}
        .logo{display:flex;align-items:center;gap:12px;font-weight:800;font-size:1.4rem;color:var(--text);text-decoration:none;}
        .logo img{height:45px;}
        .nav{display:flex;gap:10px;flex:1;justify-content:center;}
        .nav-btn{padding:10px 20px;border-radius:10px;font-weight:600;font-size:.95rem;cursor:pointer;border:2px solid var(--border);background:var(--topbar);color:var(--sub);text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:all .2s;}
        .nav-btn:hover{background:var(--hover);color:var(--text);transform:translateY(-2px);}
        .nav-btn.active{background:var(--orange);color:white;border-color:var(--orange);}
        .nav-btn svg{width:18px;height:18px;}
        .actions{display:flex;align-items:center;gap:12px;}
        .icon-btn{background:var(--hover);border:1px solid var(--border);border-radius:10px;padding:9px 11px;cursor:pointer;display:flex;align-items:center;}
        .icon-btn svg{width:20px;height:20px;color:var(--text);}
        .avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--orange),#ff9f40);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;cursor:pointer;}
        .user-menu{position:relative;}
        .dropdown{position:absolute;top:55px;right:0;background:var(--topbar);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.15);min-width:220px;opacity:0;visibility:hidden;transition:all .2s;z-index:999;}
        .dropdown.open{opacity:1;visibility:visible;}
        .dd-item{padding:13px 18px;cursor:pointer;color:var(--text);display:flex;align-items:center;gap:12px;text-decoration:none;transition:background .15s;font-size:.9rem;}
        .dd-item:hover{background:var(--hover);}
        .dd-item.red{color:var(--danger);border-top:1px solid var(--border);}
        .dd-item svg{width:17px;height:17px;}

        .main{padding:30px;}

        /* WELCOME */
        .welcome{max-width:900px;margin:0 auto;text-align:center;padding:60px 20px;}
        .w-icon{width:120px;height:120px;margin:0 auto 28px;background:linear-gradient(135deg,var(--orange),#ff9f40);border-radius:30px;display:flex;align-items:center;justify-content:center;box-shadow:0 15px 40px rgba(255,122,0,.25);}
        .w-icon svg{width:60px;height:60px;color:white;}
        .welcome h2{font-size:2.5rem;font-weight:800;margin-bottom:14px;background:linear-gradient(135deg,var(--text) 0%,var(--orange) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .welcome p{font-size:1.15rem;color:var(--sub);margin-bottom:40px;line-height:1.6;max-width:560px;margin-left:auto;margin-right:auto;}
        .search-box{max-width:680px;margin:0 auto;}
        .search-wrap{position:relative;}
        .search-inp{width:100%;padding:17px 60px;border:2px solid var(--border);border-radius:16px;font-size:1.05rem;font-family:'Inter',sans-serif;background:var(--card);color:var(--text);transition:all .3s;box-shadow:0 1px 3px rgba(0,0,0,.08);}
        .search-inp:focus{outline:none;border-color:var(--orange);box-shadow:0 0 0 4px rgba(255,122,0,.1);transform:translateY(-2px);}
        .s-icon{position:absolute;left:20px;top:50%;transform:translateY(-50%);color:var(--sub);}
        .s-icon svg{width:22px;height:22px;}
        .s-results{position:absolute;top:calc(100% + 8px);left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.12);max-height:290px;overflow-y:auto;z-index:100;display:none;}
        .s-results.open{display:block;}
        .s-item{padding:13px 18px;cursor:pointer;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;transition:background .15s;}
        .s-item:last-child{border-bottom:none;}
        .s-item:hover{background:var(--hover);}
        .s-sym{font-weight:700;font-size:.95rem;}
        .s-name{color:var(--sub);font-size:.85rem;}
        .s-arr{color:var(--orange);opacity:0;transition:all .2s;}
        .s-item:hover .s-arr{opacity:1;transform:translateX(4px);}
        .s-arr svg{width:17px;height:17px;}

        /* ANALYSIS VIEW */
        .analysis-view{display:none;}

        /* TOP CONTROLS */
        .top-bar{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;margin-bottom:20px;}
        .back-btn{display:inline-flex;align-items:center;gap:7px;padding:8px 16px;border-radius:8px;font-size:.875rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--sub);transition:all .2s;}
        .back-btn:hover{border-color:var(--orange);color:var(--orange);}
        .back-btn svg{width:15px;height:15px;}

        /* CONTROL ROW */
        .ctrl-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 18px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px;}

        /* Ticker chips */
        .t-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:8px;font-size:.83rem;font-weight:700;border:1.5px solid;cursor:default;}
        .t-chip-x{width:15px;height:15px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:.6;background:rgba(255,255,255,.2);font-size:.65rem;transition:opacity .2s;}
        .t-chip-x:hover{opacity:1;}
        .ci-wrap{position:relative;}
        .ci{background:var(--bg);border:1.5px solid var(--border);border-radius:8px;padding:6px 12px;color:var(--text);font-family:'Inter',sans-serif;font-weight:600;font-size:.85rem;width:118px;text-transform:uppercase;transition:border-color .2s;}
        .ci:focus{outline:none;border-color:var(--orange);}
        .ci::placeholder{text-transform:none;font-weight:400;color:var(--sub);}
        .ci-ac{position:absolute;top:calc(100% + 5px);left:0;background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 10px 25px rgba(0,0,0,.15);min-width:230px;max-height:190px;overflow-y:auto;z-index:300;display:none;}
        .ci-ac.open{display:block;}
        .ac-i{padding:10px 15px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);font-size:.85rem;transition:background .15s;}
        .ac-i:last-child{border-bottom:none;}
        .ac-i:hover{background:var(--hover);}
        .ac-s{font-weight:700;}.ac-n{color:var(--sub);font-size:.78rem;}
        .btn-add{background:var(--orange);color:white;border:none;border-radius:8px;padding:7px 14px;font-weight:700;font-size:.83rem;cursor:pointer;transition:all .2s;white-space:nowrap;}
        .btn-add:hover{background:#ff9f40;transform:translateY(-1px);}


        /* Period pills */
        .ppill{padding:5px 13px;border-radius:20px;font-size:.78rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--sub);transition:all .2s;}
        .ppill:hover{border-color:var(--orange);color:var(--orange);}
        .ppill.active{background:var(--orange);color:white;border-color:var(--orange);}
        .clabel{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--sub);white-space:nowrap;}

        /* SINGLE CONTROL ROW */
        .ctrl-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px 18px;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:14px;margin-bottom:14px;}
        .ctrl-left{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
        .ctrl-center{display:flex;justify-content:center;}
        .ctrl-right{display:flex;align-items:center;gap:8px;white-space:nowrap;}

        /* TIME RANGE SLIDER */
        .time-range-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 22px;margin-bottom:14px;}
        .time-range-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:12px;}
        .time-range-dates{display:flex;align-items:center;gap:10px;font-size:.82rem;font-weight:700;}
        .time-date-badge{background:var(--hover);border:1px solid var(--border);border-radius:8px;padding:5px 12px;color:var(--text);white-space:nowrap;}
        .time-range-presets{display:flex;gap:6px;}
        .tpill{padding:4px 11px;border-radius:20px;font-size:.75rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--sub);transition:all .2s;}
        .tpill:hover{border-color:var(--orange);color:var(--orange);}
        .tpill.active{background:var(--orange);color:white;border-color:var(--orange);}
        .slider-track{position:relative;height:36px;display:flex;align-items:center;}
        .slider-rail{position:absolute;left:0;right:0;height:4px;background:var(--border);border-radius:2px;}
        .slider-fill{position:absolute;height:4px;background:var(--orange);border-radius:2px;}
        .slider-thumb{position:absolute;width:18px;height:18px;border-radius:50%;background:white;border:2.5px solid var(--orange);cursor:grab;box-shadow:0 2px 8px rgba(0,0,0,.2);transform:translateX(-50%);top:50%;margin-top:-9px;transition:box-shadow .15s;z-index:2;}
        .slider-thumb:hover,.slider-thumb.dragging{box-shadow:0 0 0 6px rgba(255,122,0,.2);cursor:grabbing;}
        .slider-ticks{display:flex;justify-content:space-between;padding:0 2px;margin-top:4px;}
        .slider-tick{font-size:.7rem;color:var(--sub);font-weight:500;}

        /* METRIC DROPDOWN */
        .metric-dropdown-wrap{position:relative;width:100%;max-width:460px;}
        .metric-dropdown-btn{width:100%;padding:9px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'Inter',sans-serif;font-size:.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;transition:border-color .2s;}
        .metric-dropdown-btn:hover,.metric-dropdown-btn.open{border-color:var(--orange);}
        .metric-dropdown-btn svg{width:16px;height:16px;color:var(--sub);flex-shrink:0;transition:transform .2s;}
        .metric-dropdown-btn.open svg{transform:rotate(180deg);}
        .metric-menu{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.18);z-index:400;max-height:340px;overflow-y:auto;display:none;}
        .metric-menu.open{display:block;}
        .metric-section-label{padding:10px 16px 6px;font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--sub);background:var(--hover);border-bottom:1px solid var(--border);position:sticky;top:0;}
        .metric-opt{padding:10px 16px;cursor:pointer;font-size:.875rem;font-weight:500;color:var(--text);display:flex;align-items:center;gap:10px;transition:background .15s;border-bottom:1px solid var(--border);}
        .metric-opt:last-child{border-bottom:none;}
        .metric-opt:hover{background:var(--hover);}
        .metric-opt.selected{font-weight:700;color:var(--orange);}
        .metric-opt .mo-dot{width:8px;height:8px;border-radius:50%;background:var(--border);flex-shrink:0;transition:background .2s;}
        .metric-opt.selected .mo-dot{background:var(--orange);}

        /* SELECTED METRICS CHIPS */
        .selected-metrics{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;}
        .sm-chip{display:inline-flex;align-items:center;gap:6px;padding:5px 11px;border-radius:8px;font-size:.78rem;font-weight:700;cursor:pointer;border:1.5px solid;transition:all .2s;}
        .sm-chip-x{opacity:.6;font-size:.65rem;transition:opacity .2s;}
        .sm-chip:hover .sm-chip-x{opacity:1;}

        /* CHART */
        .chart-card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px;}
        .chart-hd{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
        .chart-ttl{font-size:1.05rem;font-weight:700;}
        .chart-sub{font-size:.8rem;color:var(--sub);margin-top:3px;}
        .chart-leg{display:flex;gap:14px;flex-wrap:wrap;}
        .leg-i{display:flex;align-items:center;gap:6px;font-size:.78rem;font-weight:600;color:var(--sub);}
        .leg-dot{width:10px;height:10px;border-radius:3px;}
        .chart-bd{padding:22px;position:relative;min-height:300px;}
        .loading-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.45);backdrop-filter:blur(3px);z-index:5;border-radius:0 0 16px 16px;}
        [data-theme="light"] .loading-overlay{background:rgba(249,250,251,.65);}
        .spin{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--orange);border-radius:50%;animation:spin .7s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
        #noDataMsg{position:absolute;inset:0;display:none;flex-direction:column;align-items:center;justify-content:center;color:var(--sub);font-size:.9rem;gap:8px;}

        /* SUMMARY TABLE */
        .summary-card{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
        .sum-hd{padding:16px 22px;border-bottom:1px solid var(--border);font-size:1rem;font-weight:700;display:flex;align-items:center;gap:8px;}
        .sum-hd svg{width:17px;height:17px;color:var(--orange);}
        .table-wrap{overflow-x:auto;}
        table{width:100%;border-collapse:collapse;font-size:.82rem;}
        thead tr{background:var(--hover);}
        th{padding:10px 16px;text-align:left;font-weight:700;font-size:.72rem;text-transform:uppercase;letter-spacing:.06em;color:var(--sub);white-space:nowrap;}
        th:not(:first-child){text-align:right;}
        tbody tr{border-bottom:1px solid var(--border);transition:background .15s;}
        tbody tr:last-child{border-bottom:none;}
        tbody tr:hover{background:var(--hover);}
        td{padding:11px 16px;white-space:nowrap;}
        td:not(:first-child){text-align:right;font-weight:600;}
        .td-series{display:flex;align-items:center;gap:9px;}
        .td-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
        .td-sym{font-weight:700;font-size:.85rem;}
        .td-metric{font-size:.75rem;color:var(--sub);}
        .td-chg{display:inline-flex;align-items:center;gap:3px;font-size:.78rem;font-weight:600;padding:2px 7px;border-radius:6px;}
        .td-chg.up{color:#10B981;background:rgba(16,185,129,.12);}
        .td-chg.dn{color:#EF4444;background:rgba(239,68,68,.12);}
        .td-na{color:var(--sub);font-weight:400;}

        /* GLOBAL LOADER */
        .global-load{position:fixed;inset:0;background:rgba(15,23,42,.6);z-index:500;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
        [data-theme="light"] .global-load{background:rgba(249,250,251,.7);}
        .global-load.show{display:flex;}
        .gl-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px 36px;display:flex;flex-direction:column;align-items:center;gap:14px;}
        .gl-spin{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--orange);border-radius:50%;animation:spin .7s linear infinite;}
        .gl-txt{font-size:.9rem;font-weight:600;color:var(--sub);}

        /* TOAST */
        .toast{position:fixed;bottom:26px;right:26px;background:var(--card);border:1px solid var(--border);border-left:4px solid var(--danger);border-radius:10px;padding:13px 17px;font-size:.875rem;box-shadow:0 10px 28px rgba(0,0,0,.18);z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;max-width:330px;}
        .toast.show{transform:translateY(0);opacity:1;}
        .toast-t{font-weight:700;color:var(--danger);margin-bottom:3px;}
        .toast-m{color:var(--sub);}

        @media(max-width:968px){.nav{display:none;}.main{padding:14px;}}
    </style>
</head>
<body>

<header class="topbar">
    <a href="webapp.html" class="logo"><img src="logo.png" alt="Logo"> StockMaster</a>
    <nav class="nav">
        <a href="webapp.html" class="nav-btn"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>Home</a>
        <a href="stock-screener.html" class="nav-btn"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>Stock Screener</a>
        <a href="valorisation-analysis.html" class="nav-btn active"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>Valuation Analysis</a>
        <a href="dcf-calculator.html" class="nav-btn"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>DCF Calculator</a>
    </nav>
    <div class="actions">
        <button class="icon-btn" id="themeBtn">
            <svg id="sunIco" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <svg id="moonIco" style="display:none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
        </button>
        <div class="user-menu">
            <div class="avatar" id="avatarBtn">U</div>
            <div class="dropdown" id="dropdown">
                <a href="settings.html" class="dd-item"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>Settings</a>
                <a href="billings-plans.html" class="dd-item"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>Billings & Plans</a>
                <div class="dd-item red" id="signOutBtn"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>Sign Out</div>
            </div>
        </div>
    </div>
</header>

<main class="main">

    <!-- WELCOME -->
    <div class="welcome" id="welcomeSection">
        <div class="w-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></div>
        <h2>Valuation Analysis</h2>
        <p>Select metrics from the dropdown, compare multiple stocks side-by-side with a single updating chart and summary table.</p>
        <div class="search-box">
            <div class="search-wrap">
                <div class="s-icon"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></div>
                <input class="search-inp" id="stockSearch" type="text" placeholder="Search a stock to get started (e.g. AAPL, MSFT, NVDA...)" autocomplete="off">
                <div class="s-results" id="searchResults"></div>
            </div>
        </div>
    </div>

    <!-- ANALYSIS VIEW -->
    <div class="analysis-view" id="analysisView">

        <div class="top-bar">
            <button class="back-btn" id="backBtn">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                New search
            </button>
        </div>

        <!-- Single control row: stocks left | metrics center | period right -->
        <div class="ctrl-card">
            <!-- LEFT: tickers -->
            <div class="ctrl-left">
                <span class="clabel">Stocks</span>
                <div id="chips" style="display:flex;gap:8px;flex-wrap:wrap;"></div>
                <div class="ci-wrap">
                    <input class="ci" id="ci" type="text" placeholder="Add ticker..." maxlength="10" autocomplete="off">
                    <div class="ci-ac" id="ciAc"></div>
                </div>
                <button class="btn-add" id="addBtn">+ Add</button>
            </div>
            <!-- CENTER: metric dropdown -->
            <div class="ctrl-center">
                <div class="metric-dropdown-wrap" id="metricDropdownWrap">
                    <button class="metric-dropdown-btn" id="metricDropdownBtn">
                        <span id="metricDropdownLabel">Select metrics to graph...</span>
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div class="metric-menu" id="metricMenu"></div>
                </div>
            </div>
            <!-- RIGHT: period -->
            <div class="ctrl-right">
                <span class="clabel">Period</span>
                <button class="ppill active" data-p="A">Annual</button>
                <button class="ppill" data-p="Q">Quarterly</button>
            </div>
        </div>

        <!-- TIME RANGE SLIDER -->
        <div class="time-range-card" id="timeRangeCard" style="display:none;">
            <div class="time-range-top">
                <div class="time-range-dates">
                    <div class="time-date-badge" id="dateFrom">—</div>
                    <svg style="width:14px;height:14px;color:var(--sub)" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                    <div class="time-date-badge" id="dateTo">—</div>
                </div>
                <div class="time-range-presets" id="timePresets">
                    <button class="tpill" data-n="1">1Y</button>
                    <button class="tpill" data-n="2">2Y</button>
                    <button class="tpill active" data-n="5">5Y</button>
                    <button class="tpill" data-n="99">Max</button>
                </div>
            </div>
            <div class="slider-track" id="sliderTrack">
                <div class="slider-rail"></div>
                <div class="slider-fill" id="sliderFill"></div>
                <div class="slider-thumb" id="thumbFrom" data-side="from"></div>
                <div class="slider-thumb" id="thumbTo" data-side="to"></div>
            </div>
            <div class="slider-ticks" id="sliderTicks"></div>
        </div>

        <!-- Selected metric chips -->
        <div class="selected-metrics" id="selectedMetrics"></div>

        <!-- Single chart -->
        <div class="chart-card" id="chartCard" style="display:none;">
            <div class="chart-hd">
                <div>
                    <div class="chart-ttl" id="chartTtl">—</div>
                    <div class="chart-sub" id="chartSub">Annual · last 5 years</div>
                </div>
                <div class="chart-leg" id="chartLeg"></div>
            </div>
            <div class="chart-bd">
                <div class="loading-overlay" id="chartLoader" style="display:none;"><div class="spin"></div></div>
                <div id="noDataMsg">
                    <svg style="width:36px;height:36px;opacity:.35" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span>No data available for this selection</span>
                </div>
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Summary table -->
        <div class="summary-card" id="summaryCard" style="display:none;">
            <div class="sum-hd">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M3 14h18M3 6h18M3 18h18"/></svg>
                Summary
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr>
                        <th>Series</th>
                        <th>Latest</th>
                        <th>vs Previous</th>
                        <th>Average</th>
                        <th>Low</th>
                        <th>High</th>
                    </tr></thead>
                    <tbody id="summaryBody"></tbody>
                </table>
            </div>
        </div>

    </div>
</main>

<!-- Global loader -->
<div class="global-load" id="globalLoad">
    <div class="gl-box">
        <div class="gl-spin"></div>
        <div class="gl-txt" id="glTxt">Loading…</div>
    </div>
</div>

<div class="toast" id="toast">
    <div class="toast-t" id="toastT">Error</div>
    <div class="toast-m" id="toastM"></div>
</div>

<!-- Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    const auth = getAuth(initializeApp({
        apiKey:"AIzaSyD4dkPbO1C-bZiSokalUnwNqOTpeAyrOU0",authDomain:"stockmaster-30835.firebaseapp.com",
        projectId:"stockmaster-30835",storageBucket:"stockmaster-30835.firebasestorage.app",
        messagingSenderId:"506097874613",appId:"1:506097874613:web:0d15d2bd1575a55c8ab0fc"
    }));
    onAuthStateChanged(auth,u=>{if(!u){window.location.href="login.html";return;}document.getElementById('avatarBtn').textContent=u.email.charAt(0).toUpperCase();});
    document.getElementById('signOutBtn').addEventListener('click',async()=>{await signOut(auth);window.location.href="index.html";});
</script>

<script type="module">
import fmpAPI from './fmp-api.js';

// ── METRIC DEFINITIONS ───────────────────────────────────────────────────────
// Organised by category matching FMP endpoints
const METRIC_CATEGORIES = [
    {
        label: 'Income Statement',
        metrics: [
            { key:'revenue',      label:'Revenue',       fmt: v=>'$'+fmtBig(v) },
            { key:'grossProfit',  label:'Gross Profit',  fmt: v=>'$'+fmtBig(v) },
            { key:'grossMargin',  label:'Gross Margin',  fmt: v=>(v*100).toFixed(1)+'%' },
            { key:'netIncome',    label:'Net Income',    fmt: v=>'$'+fmtBig(v) },
            { key:'eps',          label:'EPS (Diluted)', fmt: v=>'$'+v.toFixed(2) },
            { key:'ebitda',       label:'EBITDA',        fmt: v=>'$'+fmtBig(v) },
            { key:'pe',           label:'P/E Ratio',     fmt: v=>v.toFixed(1)+'x' },
            { key:'pb',           label:'P/B Ratio',     fmt: v=>v.toFixed(2)+'x' },
            { key:'evEbitda',     label:'EV/EBITDA',     fmt: v=>v.toFixed(1)+'x' },
        ]
    },
    {
        label: 'Cash Flow Statement',
        metrics: [
            { key:'fcf',          label:'Free Cash Flow',  fmt: v=>'$'+fmtBig(v) },
            { key:'operatingCF',  label:'Operating Cash Flow', fmt: v=>'$'+fmtBig(v) },
            { key:'capex',        label:'Capex',           fmt: v=>'$'+fmtBig(v) },
        ]
    },
    {
        label: 'Balance Sheet',
        metrics: [
            { key:'totalAssets',  label:'Total Assets',    fmt: v=>'$'+fmtBig(v) },
            { key:'totalDebt',    label:'Total Debt',      fmt: v=>'$'+fmtBig(v) },
            { key:'cash',         label:'Cash & Equivalents', fmt: v=>'$'+fmtBig(v) },
            { key:'equity',       label:'Shareholders Equity', fmt: v=>'$'+fmtBig(v) },
        ]
    },
];

// Flat lookup
const METRIC_MAP = {};
METRIC_CATEGORIES.forEach(cat => cat.metrics.forEach(m => { METRIC_MAP[m.key] = m; }));

// ── TICKER COLOR PALETTES (tints per ticker index) ────────────────────────────
// Each ticker gets a hue family. Metrics for that ticker use different shades.
const TICKER_PALETTES = [
    // Orange family (ticker 0)
    ['#FF7A00','#FF9933','#FFB366','#CC6200','#E87000','#FFAD7A'],
    // Blue family (ticker 1)
    ['#3B82F6','#60A5FA','#93C5FD','#1D4ED8','#2563EB','#6BAEF7'],
    // Green family (ticker 2)
    ['#10B981','#34D399','#6EE7B7','#059669','#047857','#5ECFA4'],
    // Purple family (ticker 3)
    ['#8B5CF6','#A78BFA','#C4B5FD','#6D28D9','#7C3AED','#B195FA'],
    // Pink family (ticker 4)
    ['#EC4899','#F472B6','#F9A8D4','#BE185D','#DB2777','#EF87C3'],
    // Teal family (ticker 5)
    ['#06B6D4','#22D3EE','#67E8F9','#0E7490','#0891B2','#45CEEC'],
];

function getSeriesColor(tickerIdx, metricIdx) {
    const palette = TICKER_PALETTES[tickerIdx % TICKER_PALETTES.length];
    return palette[metricIdx % palette.length];
}

// ── STATE ─────────────────────────────────────────────────────────────────────
let tickers     = [];
let cache       = {};
let selMetrics  = [];      // ordered array of metric keys
let period      = 'A';
let chart       = null;
let allDates    = [];      // sorted union of all dates across loaded tickers
let fromIdx     = 0;       // index into allDates for range start
let toIdx       = 0;       // index into allDates for range end (inclusive)

// ── UTILS ─────────────────────────────────────────────────────────────────────
function fmtBig(v){if(v==null)return'N/A';const a=Math.abs(v);if(a>=1e12)return(v/1e12).toFixed(2)+'T';if(a>=1e9)return(v/1e9).toFixed(2)+'B';if(a>=1e6)return(v/1e6).toFixed(2)+'M';return v.toFixed(0);}
function safeN(v){const n=Number(v);return(v!=null&&v!==''&&isFinite(n))?n:null;}
function fmtVal(key,v){if(v==null||!isFinite(v))return'N/A';try{return METRIC_MAP[key].fmt(v);}catch{return'N/A';}}
function setGlobalLoad(show,txt='Loading…'){document.getElementById('glTxt').textContent=txt;document.getElementById('globalLoad').classList.toggle('show',show);}
function showToast(t,m){document.getElementById('toastT').textContent=t;document.getElementById('toastM').textContent=m;const el=document.getElementById('toast');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),4500);}

// ── DATA ──────────────────────────────────────────────────────────────────────
function buildRows(incs, cass, bals) {
    const cMap = Object.fromEntries((cass||[]).map(r=>[r.date,r]));
    const bMap = Object.fromEntries((bals||[]).map(r=>[r.date,r]));
    return [...incs].reverse().map(row=>{
        const c = cMap[row.date]||{}, b = bMap[row.date]||{};
        const revenue    = safeN(row.revenue);
        const grossProfit= safeN(row.grossProfit);
        const netIncome  = safeN(row.netIncome);
        const eps        = safeN(row.epsdiluted)??safeN(row.eps);
        const ebitda     = safeN(row.ebitda);
        const fcf        = safeN(c.freeCashFlow);
        const operatingCF= safeN(c.operatingCashFlow);
        const capex      = safeN(c.capitalExpenditure);
        const totalAssets= safeN(b.totalAssets);
        const totalDebt  = safeN(b.totalDebt);
        const cash       = safeN(b.cashAndCashEquivalents)??safeN(b.cash);
        const equity     = safeN(b.totalStockholdersEquity)??safeN(b.stockholdersEquity);
        return {
            date:row.date,
            revenue, grossProfit, netIncome, eps, ebitda, fcf, operatingCF, capex,
            totalAssets, totalDebt, cash, equity,
            grossMargin:(grossProfit!=null&&revenue!=null&&revenue>0)?grossProfit/revenue:null,
            pe:null, pb:null, evEbitda:null,
        };
    });
}

async function load(sym){
    if(cache[sym])return cache[sym];
    const [incA,casA,balA,incQ,casQ,balQ,quoteRaw,ratTTM,kmTTM]=await Promise.all([
        fmpAPI.makeRequest('/income-statement',       {symbol:sym,limit:5}),
        fmpAPI.makeRequest('/cash-flow-statement',    {symbol:sym,limit:5}),
        fmpAPI.makeRequest('/balance-sheet-statement',{symbol:sym,limit:5}),
        fmpAPI.makeRequest('/income-statement',       {symbol:sym,period:'quarter',limit:5}),
        fmpAPI.makeRequest('/cash-flow-statement',    {symbol:sym,period:'quarter',limit:5}),
        fmpAPI.makeRequest('/balance-sheet-statement',{symbol:sym,period:'quarter',limit:5}),
        fmpAPI.makeRequest('/quote',                  {symbol:sym}),
        fmpAPI.makeRequest('/ratios-ttm',             {symbol:sym}),
        fmpAPI.makeRequest('/key-metrics-ttm',        {symbol:sym}),
    ]);
    const ai=Array.isArray(incA)?incA:[], ac=Array.isArray(casA)?casA:[], ab=Array.isArray(balA)?balA:[];
    const qi=Array.isArray(incQ)?incQ:[], qc=Array.isArray(casQ)?casQ:[], qb=Array.isArray(balQ)?balQ:[];
    if(!ai.length&&!qi.length) throw new Error(`No data found for "${sym}". Check the ticker.`);
    const qd=Array.isArray(quoteRaw)?(quoteRaw[0]||{}):(quoteRaw||{});
    const rttm=Array.isArray(ratTTM)?(ratTTM[0]||{}):(ratTTM||{});
    const kmttm=Array.isArray(kmTTM)?(kmTTM[0]||{}):(kmTTM||{});
    const annual=buildRows(ai,ac,ab);
    const quarter=buildRows(qi,qc,qb);
    const injectRatios=rows=>{
        if(!rows.length)return;
        const last=rows[rows.length-1];
        last.pe      =safeN(rttm.peRatioTTM)??safeN(rttm.priceEarningsRatioTTM);
        last.pb      =safeN(rttm.pbRatioTTM)??safeN(rttm.priceToBookRatioTTM);
        last.evEbitda=safeN(kmttm.enterpriseValueOverEBITDATTM)??safeN(kmttm.evToEbitdaTTM);
    };
    injectRatios(annual); injectRatios(quarter);
    cache[sym]={annual,quarter,info:{companyName:qd.name||qd.companyName||sym,...qd}};
    return cache[sym];
}

function rowsFor(sym){const d=cache[sym];if(!d)return[];return period==='Q'?d.quarter:d.annual;}

// Returns rows within the selected time range
function filteredRowsFor(sym){
    const rows=rowsFor(sym);
    if(!allDates.length)return rows;
    const from=allDates[fromIdx], to=allDates[toIdx];
    return rows.filter(r=>r.date>=from&&r.date<=to);
}

// Rebuild allDates from all loaded tickers for current period, then refresh slider
function updateAllDates(){
    const s=new Set();
    tickers.forEach(sym=>rowsFor(sym).forEach(r=>s.add(r.date)));
    allDates=[...s].sort();
    if(allDates.length){
        // Keep existing range if possible, else default to full range
        fromIdx=Math.max(0,Math.min(fromIdx,allDates.length-1));
        toIdx=allDates.length-1;
    }
    renderSlider();
}

// ── METRIC DROPDOWN ───────────────────────────────────────────────────────────
function buildMetricMenu(){
    const menu=document.getElementById('metricMenu');
    menu.innerHTML='';
    METRIC_CATEGORIES.forEach(cat=>{
        const sec=document.createElement('div');
        sec.className='metric-section-label';
        sec.textContent=cat.label;
        menu.appendChild(sec);
        cat.metrics.forEach(m=>{
            const opt=document.createElement('div');
            opt.className='metric-opt'+(selMetrics.includes(m.key)?' selected':'');
            opt.dataset.key=m.key;
            opt.innerHTML=`<span class="mo-dot"></span>${m.label}`;
            opt.addEventListener('click',()=>{
                if(selMetrics.includes(m.key)){
                    selMetrics=selMetrics.filter(k=>k!==m.key);
                }else{
                    selMetrics.push(m.key);
                }
                buildMetricMenu();
                renderSelectedChips();
                renderChart();
                renderSummary();
            });
            menu.appendChild(opt);
        });
    });
}

// Dropdown open/close
document.getElementById('metricDropdownBtn').addEventListener('click',e=>{
    e.stopPropagation();
    const btn=document.getElementById('metricDropdownBtn');
    const menu=document.getElementById('metricMenu');
    btn.classList.toggle('open');
    menu.classList.toggle('open');
});
document.addEventListener('click',e=>{
    const wrap=document.getElementById('metricDropdownWrap');
    if(!wrap.contains(e.target)){
        document.getElementById('metricDropdownBtn').classList.remove('open');
        document.getElementById('metricMenu').classList.remove('open');
    }
});

// ── SELECTED METRIC CHIPS ─────────────────────────────────────────────────────
function renderSelectedChips(){
    const container=document.getElementById('selectedMetrics');
    container.innerHTML='';
    // Update dropdown label
    const lbl=document.getElementById('metricDropdownLabel');
    lbl.textContent=selMetrics.length===0?'Select metrics to graph...':`${selMetrics.length} metric${selMetrics.length>1?'s':''} selected`;

    selMetrics.forEach((key,mIdx)=>{
        const m=METRIC_MAP[key];
        // Use a neutral color for chips (first ticker's shade for that metric index)
        const col=getSeriesColor(0,mIdx);
        const chip=document.createElement('div');
        chip.className='sm-chip';
        chip.style.cssText=`color:${col};border-color:${col};background:${col}18`;
        chip.innerHTML=`${m.label} <span class="sm-chip-x" data-key="${key}">✕</span>`;
        chip.querySelector('.sm-chip-x').addEventListener('click',()=>{
            selMetrics=selMetrics.filter(k=>k!==key);
            buildMetricMenu(); renderSelectedChips(); renderChart(); renderSummary();
        });
        container.appendChild(chip);
    });
}

// ── CHART (single, updates on every change) ────────────────────────────────────
function renderChart(){
    const chartCard=document.getElementById('chartCard');
    const nodata=document.getElementById('noDataMsg');
    const canvas=document.getElementById('mainChart');

    if(!selMetrics.length||!tickers.length){
        chartCard.style.display='none';
        if(chart){chart.destroy();chart=null;}
        return;
    }
    chartCard.style.display='block';

    // Build labels = filtered dates within selected time range
    const allD=new Set();
    tickers.forEach(s=>filteredRowsFor(s).forEach(r=>allD.add(r.date)));
    const labels=[...allD].sort();

    // Each dataset = one (ticker × metric) combination
    // Colors: same ticker = same hue family, different metrics = different shades
    const datasets=[];
    const legendItems=[];

    tickers.forEach((sym,tIdx)=>{
        const r=filteredRowsFor(sym);
        const map=Object.fromEntries(r.map(x=>[x.date,x]));
        selMetrics.forEach((mKey,mIdx)=>{
            const color=getSeriesColor(tIdx,mIdx);
            const data=labels.map(d=>{
                const row=map[d];
                if(!row)return null;
                const v=row[mKey];
                return(v!=null&&isFinite(v))?v:null;
            });
            const seriesLabel=tickers.length>1?`${sym} – ${METRIC_MAP[mKey].label}`:METRIC_MAP[mKey].label;
            datasets.push({
                label:seriesLabel,
                data,
                backgroundColor:color+'CC',
                borderColor:color,
                borderWidth:1.5,
                borderRadius:5,
                _mKey:mKey,
            });
            legendItems.push({label:seriesLabel,color});
        });
    });

    const hasData=datasets.some(ds=>ds.data.some(v=>v!==null));
    nodata.style.display=hasData?'none':'flex';
    canvas.style.display=hasData?'block':'none';

    // Title: single metric name if only one metric, else "Multiple Metrics"
    const ttl=selMetrics.length===1?METRIC_MAP[selMetrics[0]].label:'Multiple Metrics';
    document.getElementById('chartTtl').textContent=ttl;
    document.getElementById('chartSub').textContent=
        (period==='Q'?'Quarterly · last 5 quarters':'Annual · last 5 years')+
        (tickers.length>1?` · ${tickers.length} stocks`:'');

    // Legend
    document.getElementById('chartLeg').innerHTML=legendItems
        .map(l=>`<div class="leg-i"><div class="leg-dot" style="background:${l.color}"></div>${l.label}</div>`)
        .join('');

    if(!hasData){if(chart){chart.destroy();chart=null;}return;}

    const dk=document.documentElement.getAttribute('data-theme')!=='light';
    const gc=dk?'rgba(255,255,255,.05)':'rgba(0,0,0,.06)';
    const tc=dk?'#64748B':'#94A3B8';

    // Determine if we need multiple Y axes (mixing % with $ etc.)
    // Simple heuristic: if grossMargin is selected alongside others, add a right axis
    const hasRatioMetric=selMetrics.some(k=>['grossMargin','pe','pb','evEbitda'].includes(k));
    const hasBigMetric=selMetrics.some(k=>['revenue','netIncome','grossProfit','ebitda','fcf','operatingCF','capex','totalAssets','totalDebt','cash','equity','eps'].includes(k));
    const dualAxis=hasRatioMetric&&hasBigMetric;

    datasets.forEach(ds=>{
        const isRatio=['grossMargin','pe','pb','evEbitda'].includes(ds._mKey);
        ds.yAxisID=dualAxis?(isRatio?'yRight':'yLeft'):'y';
    });

    const scales={
        x:{grid:{color:gc},ticks:{color:tc,font:{size:11},maxTicksLimit:10,maxRotation:30}},
    };
    if(dualAxis){
        scales.yLeft={type:'linear',position:'left',grid:{color:gc},ticks:{color:tc,font:{size:11},callback:v=>fmtBig(v)}};
        scales.yRight={type:'linear',position:'right',grid:{drawOnChartArea:false},ticks:{color:tc,font:{size:11},callback:v=>{
            // Pick the right formatter for the right-axis metric
            const rmKey=selMetrics.find(k=>['grossMargin','pe','pb','evEbitda'].includes(k));
            return rmKey?fmtVal(rmKey,v):v;
        }}};
    }else{
        // Determine which formatter to use for single-axis
        const sampleKey=selMetrics[0];
        scales.y={grid:{color:gc},ticks:{color:tc,font:{size:11},callback:v=>fmtVal(sampleKey,v)}};
    }

    if(chart)chart.destroy();
    chart=new Chart(canvas.getContext('2d'),{
        type:'bar',
        data:{labels,datasets},
        options:{
            responsive:true,maintainAspectRatio:true,
            aspectRatio:window.innerWidth<600?1.5:3,
            interaction:{mode:'index',intersect:false},
            plugins:{
                legend:{display:false},
                tooltip:{
                    backgroundColor:dk?'#1E293B':'#fff',
                    borderColor:dk?'#334155':'#E2E8F0',
                    borderWidth:1,titleColor:dk?'#F1F5F9':'#111827',
                    bodyColor:dk?'#94A3B8':'#6B7280',padding:12,
                    callbacks:{label:c=>` ${c.dataset.label}: ${fmtVal(c.dataset._mKey||selMetrics[0],c.parsed.y)}`}
                }
            },
            scales,
        }
    });
}

// ── SUMMARY TABLE ──────────────────────────────────────────────────────────────
function renderSummary(){
    const card=document.getElementById('summaryCard');
    const tbody=document.getElementById('summaryBody');
    if(!selMetrics.length||!tickers.length){card.style.display='none';return;}
    card.style.display='block';
    tbody.innerHTML='';

    selMetrics.forEach((mKey,mIdx)=>{
        const m=METRIC_MAP[mKey];
        tickers.forEach((sym,tIdx)=>{
            const color=getSeriesColor(tIdx,mIdx);
            const rows=filteredRowsFor(sym);
            const vals=rows.map(r=>r[mKey]).filter(v=>v!=null&&isFinite(v));
            if(!vals.length){
                const tr=document.createElement('tr');
                tr.innerHTML=`<td><div class="td-series"><div class="td-dot" style="background:${color}"></div><div><div class="td-sym">${sym}</div><div class="td-metric">${m.label}</div></div></div></td><td colspan="5" class="td-na" style="text-align:center">No data</td>`;
                tbody.appendChild(tr);
                return;
            }
            const latest=vals[vals.length-1];
            const prev=vals.length>1?vals[vals.length-2]:null;
            const avg=vals.reduce((s,v)=>s+v,0)/vals.length;
            const low=Math.min(...vals);
            const high=Math.max(...vals);
            const chgPct=(prev!=null&&prev!==0)?((latest-prev)/Math.abs(prev))*100:null;
            const tr=document.createElement('tr');
            tr.innerHTML=`
                <td><div class="td-series"><div class="td-dot" style="background:${color}"></div><div><div class="td-sym">${sym}</div><div class="td-metric">${m.label}</div></div></div></td>
                <td>${fmtVal(mKey,latest)}</td>
                <td>${chgPct!=null?`<span class="td-chg ${chgPct>=0?'up':'dn'}">${chgPct>=0?'▲':'▼'} ${Math.abs(chgPct).toFixed(1)}%</span>`:'<span class="td-na">—</span>'}</td>
                <td>${fmtVal(mKey,avg)}</td>
                <td>${fmtVal(mKey,low)}</td>
                <td>${fmtVal(mKey,high)}</td>`;
            tbody.appendChild(tr);
        });
    });
}

// ── TICKERS ────────────────────────────────────────────────────────────────────
function renderTickers(){
    const c=document.getElementById('chips'); c.innerHTML='';
    tickers.forEach((sym,i)=>{
        const base=TICKER_PALETTES[i%TICKER_PALETTES.length][0];
        const chip=document.createElement('div');
        chip.className='t-chip';
        chip.style.cssText=`color:${base};border-color:${base};background:${base}18`;
        chip.innerHTML=sym+(tickers.length>1?`<span class="t-chip-x" data-s="${sym}">✕</span>`:'');
        c.appendChild(chip);
    });
    document.querySelectorAll('.t-chip-x').forEach(x=>x.addEventListener('click',()=>{
        tickers=tickers.filter(t=>t!==x.dataset.s);
        updateAllDates();
        renderTickers(); renderChart(); renderSummary();
    }));
}

async function initStock(sym,name){
    sym=sym.toUpperCase().trim();
    setGlobalLoad(true,`Loading ${sym}…`);
    document.getElementById('welcomeSection').style.display='none';
    document.getElementById('analysisView').style.display='block';
    try{
        await load(sym);
        tickers=[sym];
        fromIdx=0; toIdx=0;
        updateAllDates();
        buildMetricMenu();
        renderSelectedChips();
        renderTickers();
        renderChart();
        renderSummary();
    }catch(e){
        showToast('Not found',e.message);
        document.getElementById('welcomeSection').style.display='block';
        document.getElementById('analysisView').style.display='none';
    }finally{setGlobalLoad(false);}
}

async function addTicker(sym){
    sym=sym.toUpperCase().trim();if(!sym)return;
    if(tickers.includes(sym)){showToast('Already added',`${sym} is already displayed.`);return;}
    if(tickers.length>=6){showToast('Max reached','Up to 6 tickers at once.');return;}
    setGlobalLoad(true,`Loading ${sym}…`);
    try{
        await load(sym);
        tickers.push(sym);
        updateAllDates();
        renderTickers(); renderChart(); renderSummary();
    }catch(e){showToast('Not found',e.message);}
    finally{setGlobalLoad(false);}
}

// ── SEARCH ────────────────────────────────────────────────────────────────────
const sInp=document.getElementById('stockSearch'),sRes=document.getElementById('searchResults');
let st=null;

function renderSugg(results,inp,res,cb){
    if(!results.length){res.classList.remove('open');return;}
    res.innerHTML=results.map(x=>`<div class="s-item" data-s="${x.s}" data-n="${x.n}"><div style="display:flex;align-items:center;gap:11px"><span class="s-sym">${x.s}</span><span class="s-name">${x.n}</span></div><span class="s-arr"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></span></div>`).join('');
    res.classList.add('open');
    res.querySelectorAll('.s-item').forEach(el=>el.addEventListener('click',()=>{res.classList.remove('open');inp.value='';cb(el.dataset.s,el.dataset.n);}));
}

async function doSearch(q,inp,res,cb){
    if(!q){res.classList.remove('open');return;}
    try{
        const raw=await fmpAPI.searchStocks(q);
        const results=(Array.isArray(raw)?raw:[]).slice(0,8).map(x=>({s:x.symbol||x.s,n:x.name||x.companyName||x.n||''})).filter(x=>x.s);
        renderSugg(results,inp,res,cb);
    }catch(e){res.classList.remove('open');}
}

sInp.addEventListener('input',()=>{clearTimeout(st);const q=sInp.value.trim();if(!q){sRes.classList.remove('open');return;}st=setTimeout(()=>doSearch(q,sInp,sRes,initStock),300);});
sInp.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=sInp.value.trim();if(v){sRes.classList.remove('open');sInp.value='';initStock(v,'');}}});
document.addEventListener('click',e=>{if(!sInp.contains(e.target)&&!sRes.contains(e.target))sRes.classList.remove('open');});

// ── COMPARE SEARCH ─────────────────────────────────────────────────────────────
const ci=document.getElementById('ci'),ciAc=document.getElementById('ciAc');
let ct=null;
ci.addEventListener('input',()=>{
    clearTimeout(ct);const q=ci.value.trim();if(!q){ciAc.classList.remove('open');return;}
    ct=setTimeout(async()=>{
        try{
            const raw=await fmpAPI.searchStocks(q);
            const results=(Array.isArray(raw)?raw:[]).slice(0,6).map(x=>({s:x.symbol||x.s,n:x.name||x.companyName||''})).filter(x=>x.s);
            if(!results.length){ciAc.classList.remove('open');return;}
            ciAc.innerHTML=results.map(x=>`<div class="ac-i" data-s="${x.s}"><span class="ac-s">${x.s}</span><span class="ac-n">${x.n}</span></div>`).join('');
            ciAc.classList.add('open');
            ciAc.querySelectorAll('.ac-i').forEach(el=>el.addEventListener('click',()=>{ci.value='';ciAc.classList.remove('open');addTicker(el.dataset.s);}));
        }catch(e){ciAc.classList.remove('open');}
    },300);
});
ci.addEventListener('keydown',e=>{if(e.key==='Enter'){const v=ci.value.trim();if(v){ci.value='';ciAc.classList.remove('open');addTicker(v);}}});
document.getElementById('addBtn').addEventListener('click',()=>{const v=ci.value.trim();if(v){ci.value='';ciAc.classList.remove('open');addTicker(v);}});
document.addEventListener('click',e=>{if(!ci.contains(e.target)&&!ciAc.contains(e.target))ciAc.classList.remove('open');});

// ── PERIOD PILLS ───────────────────────────────────────────────────────────────
document.querySelectorAll('.ppill').forEach(btn=>{
    btn.addEventListener('click',()=>{
        document.querySelectorAll('.ppill').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        period=btn.dataset.p;
        fromIdx=0;
        if(tickers.length){updateAllDates();renderChart();renderSummary();}
    });
});

// ── BACK ───────────────────────────────────────────────────────────────────────
document.getElementById('backBtn').addEventListener('click',()=>{
    tickers=[];cache={};selMetrics=[];allDates=[];fromIdx=0;toIdx=0;
    if(chart){chart.destroy();chart=null;}
    document.getElementById('chips').innerHTML='';
    document.getElementById('selectedMetrics').innerHTML='';
    document.getElementById('chartCard').style.display='none';
    document.getElementById('summaryCard').style.display='none';
    document.getElementById('timeRangeCard').style.display='none';
    document.getElementById('analysisView').style.display='none';
    document.getElementById('welcomeSection').style.display='block';
    document.getElementById('stockSearch').value='';
    buildMetricMenu();
    renderSelectedChips();
});

// ── TIME RANGE SLIDER ──────────────────────────────────────────────────────────
function fmtDate(d){
    if(!d)return'—';
    // d is like "2024-03-31"
    const dt=new Date(d+'T00:00:00');
    return dt.toLocaleDateString('en-US',{month:'short',year:'numeric'});
}

function renderSlider(){
    const card=document.getElementById('timeRangeCard');
    if(!allDates.length){card.style.display='none';return;}
    card.style.display='block';

    // Ensure valid indices
    if(toIdx===0||toIdx<fromIdx)toIdx=allDates.length-1;
    fromIdx=Math.max(0,Math.min(fromIdx,allDates.length-1));
    toIdx=Math.max(fromIdx,Math.min(toIdx,allDates.length-1));

    document.getElementById('dateFrom').textContent=fmtDate(allDates[fromIdx]);
    document.getElementById('dateTo').textContent=fmtDate(allDates[toIdx]);

    const pctFrom=(allDates.length>1?fromIdx/(allDates.length-1):0)*100;
    const pctTo=(allDates.length>1?toIdx/(allDates.length-1):1)*100;
    document.getElementById('sliderFill').style.left=pctFrom+'%';
    document.getElementById('sliderFill').style.width=(pctTo-pctFrom)+'%';
    document.getElementById('thumbFrom').style.left=pctFrom+'%';
    document.getElementById('thumbTo').style.left=pctTo+'%';

    // Ticks: show year labels evenly
    const ticksEl=document.getElementById('sliderTicks');
    const years=[...new Set(allDates.map(d=>d.slice(0,4)))];
    ticksEl.innerHTML=years.map(y=>`<span class="slider-tick">${y}</span>`).join('');

    // Update preset active state
    const rangeCount=toIdx-fromIdx+1;
    document.querySelectorAll('.tpill').forEach(btn=>{
        const n=parseInt(btn.dataset.n);
        btn.classList.toggle('active',n===99?fromIdx===0&&toIdx===allDates.length-1:rangeCount===n);
    });
}

// Drag logic
let dragging=null, dragStartX=0, dragStartIdx=0;

function initSliderDrag(){
    ['thumbFrom','thumbTo'].forEach(id=>{
        const thumb=document.getElementById(id);
        thumb.addEventListener('mousedown',e=>{
            e.preventDefault();
            dragging=id==='thumbFrom'?'from':'to';
            dragStartX=e.clientX;
            dragStartIdx=dragging==='from'?fromIdx:toIdx;
            thumb.classList.add('dragging');
        });
        thumb.addEventListener('touchstart',e=>{
            e.preventDefault();
            dragging=id==='thumbFrom'?'from':'to';
            dragStartX=e.touches[0].clientX;
            dragStartIdx=dragging==='from'?fromIdx:toIdx;
            thumb.classList.add('dragging');
        },{passive:false});
    });

    document.addEventListener('mousemove',e=>{if(dragging)onDragMove(e.clientX);});
    document.addEventListener('touchmove',e=>{if(dragging)onDragMove(e.touches[0].clientX);},{passive:true});
    document.addEventListener('mouseup',()=>{if(dragging){stopDrag();}});
    document.addEventListener('touchend',()=>{if(dragging){stopDrag();}});
}

function onDragMove(clientX){
    const track=document.getElementById('sliderTrack');
    const rect=track.getBoundingClientRect();
    const pct=Math.max(0,Math.min(1,(clientX-rect.left)/rect.width));
    const idx=Math.round(pct*(allDates.length-1));
    if(dragging==='from'){
        fromIdx=Math.min(idx,toIdx);
    }else{
        toIdx=Math.max(idx,fromIdx);
    }
    // Clear preset active
    document.querySelectorAll('.tpill').forEach(b=>b.classList.remove('active'));
    renderSlider();
    renderChart();
    renderSummary();
}

function stopDrag(){
    document.querySelectorAll('.slider-thumb').forEach(t=>t.classList.remove('dragging'));
    dragging=null;
}

// Preset buttons
document.querySelectorAll('.tpill').forEach(btn=>{
    btn.addEventListener('click',()=>{
        const n=parseInt(btn.dataset.n);
        toIdx=allDates.length-1;
        if(n===99){
            fromIdx=0;
        }else{
            fromIdx=Math.max(0,toIdx-n+1);
        }
        renderSlider();
        renderChart();
        renderSummary();
    });
});

initSliderDrag();

// ── THEME ──────────────────────────────────────────────────────────────────────
const html=document.documentElement,stored=localStorage.getItem('theme')||'dark';
html.setAttribute('data-theme',stored);
if(stored==='light'){document.getElementById('sunIco').style.display='none';document.getElementById('moonIco').style.display='block';}
document.getElementById('themeBtn').addEventListener('click',()=>{
    const n=html.getAttribute('data-theme')==='dark'?'light':'dark';
    html.setAttribute('data-theme',n);localStorage.setItem('theme',n);
    document.getElementById('sunIco').style.display=n==='dark'?'block':'none';
    document.getElementById('moonIco').style.display=n==='light'?'block':'none';
    if(chart&&tickers.length){chart.destroy();chart=null;renderChart();}
});

// ── DROPDOWN ───────────────────────────────────────────────────────────────────
document.getElementById('avatarBtn').addEventListener('click',e=>{e.stopPropagation();document.getElementById('dropdown').classList.toggle('open');});
document.addEventListener('click',()=>document.getElementById('dropdown').classList.remove('open'));

// Init
buildMetricMenu();
</script>
</body>
</html>
