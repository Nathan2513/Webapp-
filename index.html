<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Master - Suite Financi√®re</title>
    <style>
        /* --- VARIABLES & RESET --- */
        :root { --bg: #0b0e11; --card: #1e2329; --text: #eaecef; --blurple: #f0b90b; --green: #0ecb81; --red: #f6465d; --gray-btn: #2b3139; --bad: #f6465d; --avg: #eebb00; --good: #0ecb81; --vgood: #00b894; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        
        /* --- NAVIGATION ENTRE LES PAGES --- */
        .page-section { display: none; width: 100%; max-width: 1100px; padding: 20px; animation: fadeIn 0.5s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- PAGE 1: LOGIN / ACCUEIL --- */
        .auth-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 90vh; text-align: center; }
        .auth-card { background: var(--card); padding: 40px; border-radius: 20px; border: 1px solid #2b3139; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .app-logo { font-size: 3rem; margin-bottom: 10px; }
        .auth-title { font-size: 1.8rem; color: var(--blurple); margin-bottom: 10px; font-weight: 800; letter-spacing: 1px; }
        .auth-subtitle { color: #848e9c; margin-bottom: 30px; font-size: 0.9rem; }
        .auth-input { width: 100%; padding: 15px; background: #262b33; border: 1px solid #474d57; border-radius: 10px; color: #fff; margin-bottom: 15px; font-size: 1rem; outline: none; transition: 0.3s; }
        .auth-input:focus { border-color: var(--blurple); }
        .btn-main { width: 100%; padding: 15px; background: var(--blurple); color: #000; border: none; border-radius: 10px; font-weight: 800; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-main:hover { opacity: 0.9; transform: translateY(-2px); }
        .footer-link { margin-top: 20px; font-size: 0.8rem; color: #848e9c; cursor: pointer; text-decoration: underline; }

        /* --- PAGE 2: MENU PRINCIPAL --- */
        .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid #2b3139; }
        .user-welcome { font-size: 1.5rem; font-weight: bold; }
        .btn-logout { background: transparent; border: 1px solid #474d57; color: #848e9c; padding: 8px 15px; border-radius: 8px; cursor: pointer; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        .menu-card { background: var(--card); padding: 30px; border-radius: 16px; border: 1px solid #2b3139; transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--blurple); box-shadow: 0 5px 20px rgba(240, 185, 11, 0.15); }
        .menu-icon { font-size: 2.5rem; margin-bottom: 15px; }
        .menu-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #fff; }
        .menu-desc { font-size: 0.9rem; color: #848e9c; }
        .menu-card.locked { opacity: 0.5; cursor: not-allowed; border-style: dashed; }
        .menu-card.locked:hover { transform: none; border-color: #2b3139; box-shadow: none; }

        /* --- PAGE 3: L'OUTIL (Styles existants conserv√©s) --- */
        .back-nav { margin-bottom: 20px; }
        .btn-back { background: #2b3139; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; }
        .btn-back:hover { background: #363c45; }

        /* Vos styles existants pour le dashboard DCF */
        .main-wrapper { width: 100%; display: flex; flex-direction: column; gap: 25px; }
        .card-base { background: var(--card); border-radius: 16px; border: 1px solid #2b3139; }
        .btn-fetch { background: var(--blurple); color: #000; border: none; padding: 0 25px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn-fetch:hover { opacity: 0.9; }
        .search-card { padding: 25px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .search-group { display: flex; gap: 10px; margin-top: 15px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .search-group input { flex: 1; padding: 14px; background: #2b3139; border: 1px solid #474d57; border-radius: 8px; color: #fff; font-size: 1rem; outline: none; }
        
        #dashboardArea { display: none; }
        .header-block { display: flex; gap: 30px; padding: 25px; align-items: center; margin-bottom: 30px; }
        @media (max-width: 768px) { .header-block { flex-direction: column; text-align: center; } }
        .donut-chart { position: relative; width: 140px; height: 140px; border-radius: 50%; background: conic-gradient(var(--good) 0% 0%, #2b3139 0% 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .donut-inner { width: 110px; height: 110px; background: var(--card); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2; }
        .total-score { font-size: 2.2rem; font-weight: 800; color: #fff; }
        .total-label { font-size: 0.7rem; color: #848e9c; text-transform: uppercase; margin-top: -5px; }
        .blurb-container { flex: 1; }
        .company-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: var(--blurple); }
        .blurb-text { font-size: 1rem; line-height: 1.6; color: #b7bdc6; background: #262b33; padding: 20px; border-radius: 12px; border-left: 4px solid var(--blurple); }
        .six-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        @media (max-width: 950px) { .six-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .six-grid { grid-template-columns: 1fr; } }
        .dash-card { padding: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #2b3139; padding-bottom: 10px; }
        .card-title { font-weight: 700; font-size: 1rem; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #2b3139; font-size: 0.9rem; }
        .metric-name { color: #848e9c; }
        .metric-val { font-weight: bold; color: #fff; margin-right: 10px; }
        .insight-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; font-weight: 700; min-width: 65px; text-align: center; display: inline-block; }
        .bg-vgood { background: rgba(0, 184, 148, 0.15); color: var(--vgood); }
        .bg-good { background: rgba(14, 203, 129, 0.15); color: var(--good); }
        .bg-avg { background: rgba(238, 187, 0, 0.15); color: var(--avg); }
        .bg-bad { background: rgba(246, 70, 93, 0.15); color: var(--bad); }
        .valo-wrapper { margin-bottom: 40px; padding: 25px; }
        .valo-title { font-size: 1.2rem; font-weight: 700; color: #fff; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .valo-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        @media (max-width: 800px) { .valo-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .valo-grid { grid-template-columns: 1fr; } }
        .valo-card { background: #262b33; border-radius: 12px; padding: 15px; border: 1px solid #363c45; position: relative; overflow: hidden; }
        .valo-metric-name { font-size: 0.8rem; color: #848e9c; text-transform: uppercase; margin-bottom: 10px; display: block; font-weight: 700; }
        .valo-current { font-size: 1.4rem; font-weight: 800; color: #fff; margin-bottom: 5px; }
        .valo-avg-label { font-size: 0.75rem; color: #848e9c; }
        .valo-avg-val { color: var(--blurple); font-weight: bold; }
        .valo-stats-row { display: flex; justify-content: space-between; margin-top: 15px; padding-top: 10px; border-top: 1px solid #363c45; font-size: 0.75rem; color: #848e9c; }
        .valo-diff-badge { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .sector-row { background: #22272e; border-radius: 8px; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 0.85rem; color: #848e9c; border: 1px dashed #474d57; }
        .dcf-wrapper { background: var(--card); padding: 30px; border-radius: 20px; border-top: 4px solid var(--blurple); box-shadow: 0 -5px 20px rgba(240, 185, 11, 0.1); }
        .dcf-title { text-align: center; color: var(--blurple); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 25px; }
        @media (max-width: 600px) { .metrics-grid { grid-template-columns: repeat(2, 1fr); } }
        .metric-btn { background: var(--gray-btn); border: 1px solid #474d57; color: #848e9c; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 0.8rem; }
        .metric-btn:hover { background: #363c45; }
        .metric-btn.active { background: var(--blurple); color: #000; border-color: var(--blurple); }
        .inputs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .input-box .label-txt { font-size: 0.7rem; color: #848e9c; margin-bottom: 8px; display: block; font-weight: 600; text-transform: uppercase; }
        .input-box input { width: 100%; padding: 14px; background: var(--gray-btn); border: 1px solid #474d57; border-radius: 10px; color: #fff; font-size: 1.1rem; text-align: center; font-weight: bold; outline: none; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .results-grid { grid-template-columns: 1fr; } }
        .result-box { background: #2b3139; padding: 15px 5px; border-radius: 12px; text-align: center; border: 1px solid #474d57; }
        .res-label { font-size: 0.65rem; color: #848e9c; margin-bottom: 5px; display: block; text-transform: uppercase; }
        .res-value { font-size: 1.3rem; font-weight: 800; color: var(--text); }
        .res-main { color: var(--blurple); }
        .margin-safety { text-align: center; margin-top: 20px; font-weight: 800; font-size: 1.2rem; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="page-auth" class="page-section active">
        <div class="auth-container">
            <div class="auth-card">
                <div class="app-logo">üìä</div>
                <div class="auth-title">STOCK MASTER</div>
                <div class="auth-subtitle">La suite financi√®re ultime pour vos analyses.</div>
                
                <input type="text" id="usernameInput" class="auth-input" placeholder="Entrez votre pr√©nom...">
                <button class="btn-main" onclick="handleLogin()">ACC√âDER AU DASHBOARD</button>
                
                <div class="footer-link" onclick="alert('Inscription bient√¥t disponible !')">Pas de compte ? Cr√©er un compte</div>
            </div>
        </div>
    </div>

    <div id="page-menu" class="page-section">
        <div class="menu-header">
            <div class="user-welcome">Bonjour, <span id="displayUsername" style="color:var(--blurple);">Trader</span> üëã</div>
            <button class="btn-logout" onclick="handleLogout()">D√©connexion</button>
        </div>

        <div class="menu-grid">
            <div class="menu-card" onclick="goToTool()">
                <div class="menu-icon">üßÆ</div>
                <div class="menu-title">DCF & Dashboard</div>
                <div class="menu-desc">Analyse compl√®te, Valorisation, Scores de sant√© et Calculateur de valeur intrins√®que.</div>
            </div>

            <div class="menu-card locked" onclick="alert('Ce module est en cours de d√©veloppement !')">
                <div class="menu-icon">üì∞</div>
                <div class="menu-title">Market News</div>
                <div class="menu-desc">Les derni√®res actualit√©s boursi√®res en temps r√©el. (Bient√¥t)</div>
            </div>

            <div class="menu-card locked" onclick="alert('Ce module est en cours de d√©veloppement !')">
                <div class="menu-icon">üíº</div>
                <div class="menu-title">Mon Portfolio</div>
                <div class="menu-desc">Suivez vos positions et votre performance. (Bient√¥t)</div>
            </div>
        </div>
    </div>

    <div id="page-tool" class="page-section">
        <div class="back-nav">
            <button class="btn-back" onclick="goBackToMenu()">‚¨Ö Retour au Menu</button>
        </div>

        <div class="main-wrapper">
            <div class="search-card card-base">
                <h2 style="margin:0 0 15px 0; color:var(--blurple); letter-spacing: 1px;">ANALYSEUR PRO</h2>
                <div class="search-group">
                    <input type="text" id="ticker" placeholder="Tapez un ticker US (ex: NVDA, AAPL)">
                    <button class="btn-fetch" onclick="runFullAnalysis()">LANCER L'ANALYSE</button>
                </div>
                <div id="status" style="margin-top:15px; color:#848e9c; font-size:0.9rem; font-weight: 500;">En attente...</div>
            </div>

            <div id="dashboardArea">
                
                <div class="header-block card-base">
                    <div class="donut-chart" id="scoreDonut">
                        <div class="donut-inner">
                            <span class="total-score" id="globalScore">--</span>
                            <span class="total-label">GLOBAL SCORE / 5</span>
                        </div>
                    </div>
                    <div class="blurb-container">
                        <div class="company-title" id="companyName">--</div>
                        <div class="blurb-text" id="quickBlurb">Chargement des donn√©es...</div>
                    </div>
                </div>

                <div class="six-grid">
                    <div class="dash-card card-base"><div class="card-header"><span class="card-title">üöÄ Croissance</span></div><div id="blkGrowth"></div></div>
                    <div class="dash-card card-base"><div class="card-header"><span class="card-title">üí∞ Profitabilit√©</span></div><div id="blkProfit"></div></div>
                    <div class="dash-card card-base"><div class="card-header"><span class="card-title">üè¶ Sant√© Financi√®re</span></div><div id="blkHealth"></div></div>
                    <div class="dash-card card-base"><div class="card-header"><span class="card-title">‚öôÔ∏è Efficacit√©</span></div><div id="blkEfficiency"></div></div>
                    <div class="dash-card card-base"><div class="card-header"><span class="card-title">üíé Valorisation (TTM)</span></div><div id="blkValuation"></div></div>
                    <div class="dash-card card-base"><div class="card-header"><span class="card-title">üíµ Cash Flow Strength</span></div><div id="blkCashflow"></div></div>
                </div>

                <div class="valo-wrapper card-base">
                    <div class="valo-title">
                        <span>üìà Analyse de Valorisation (Historique 5 Ans)</span>
                    </div>
                    
                    <div class="valo-grid" id="valuationGrid"></div>

                    <div class="sector-row">
                        <span>üè¢ Comparaison Sectorielle (Tech / Software)</span>
                        <span id="sectorPeDisplay">Sector Avg P/E: <b>--</b></span>
                    </div>
                </div>

                <div class="dcf-wrapper">
                    <h3 class="dcf-title">üßÆ Calculateur de Valeur Intrins√®que (DCF TTM)</h3>
                    <div style="text-align:center; margin-bottom:20px; font-size:0.95rem; color:#848e9c;">Prix Actuel : <span id="dcfCurrentPrice" style="color:#fff; font-weight:bold; font-size:1.1rem;">--</span></div>
                    <div style="font-size:0.75rem; color:#848e9c; margin-bottom:10px; font-weight:bold; text-transform: uppercase; text-align: center;">S√©lectionner la m√©trique de d√©part (TTM)</div>
                    <div class="metrics-grid">
                        <button class="metric-btn active" onclick="selectMetric('fcf', this)">Free Cash Flow</button>
                        <button class="metric-btn" onclick="selectMetric('netIncome', this)">Net Income</button>
                        <button class="metric-btn" onclick="selectMetric('ocf', this)">Operating CF</button>
                        <button class="metric-btn" onclick="selectMetric('oi', this)">Operating Inc.</button>
                    </div>
                    <div class="inputs-grid">
                        <div class="input-box"><span class="label-txt">Croissance estim√©e 5 ans (%)</span><input type="number" id="growthInput" value="15" oninput="calculateDCF()"></div>
                        <div class="input-box"><span class="label-txt">Multiple de sortie terminal</span><input type="number" id="multInput" value="25" oninput="calculateDCF()"></div>
                    </div>
                    <div class="results-grid">
                        <div class="result-box" style="border-color: var(--blurple);"><span class="res-label">Fair Value (Aujourd'hui)</span><div id="resFairToday" class="res-value res-main">0.00 $</div></div>
                        <div class="result-box"><span class="res-label">Valeur Future (5 ans)</span><div id="resFutureValue" class="res-value">0.00 $</div></div>
                        <div class="result-box"><span class="res-label">Rendement Annuel (CAGR)</span><div id="resCAGR" class="res-value" style="color:var(--green);">0.0%</div></div>
                    </div>
                    <div id="marginSafetyBox" class="margin-safety"></div>
                </div>
            </div>
        </div>
    </div>

<script>
// ==================== GESTION DE L'APPLICATION (NAVIGATION) ====================
function showPage(pageId) {
    document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
}

function handleLogin() {
    const name = document.getElementById('usernameInput').value || "Investisseur";
    document.getElementById('displayUsername').innerText = name;
    showPage('page-menu');
}

function handleLogout() {
    document.getElementById('usernameInput').value = "";
    showPage('page-auth');
}

function goToTool() {
    showPage('page-tool');
}

function goBackToMenu() {
    showPage('page-menu');
}


// ==================== LE CODE DE L'OUTIL (INCHANG√â) ====================
const API_KEY = "cCUKcjC9uAt3yTUyvtGbYl5CrI41G21e";
let dcfData = { price: 0, shares: 0, fcf: 0, netIncome: 0, ocf: 0, oi: 0, currency: "$" };
let dashData = {}; 
let currentMetric = 'fcf'; 

// --- HELPERS ---
function createRow(label, value, isPercent, inverseColors = false) {
    let displayVal = "N/A"; let badgeCss = "bg-avg"; let badgeTxt = "Avg";
    if (value !== null && value !== undefined && !isNaN(value)) {
        displayVal = isPercent ? (value * 100).toFixed(1) + "%" : value.toFixed(2);
        let score = 2; 
        if (isPercent) { if (value > 0.20) score = 4; else if (value > 0.10) score = 3; else if (value < 0.02) score = 1; } 
        else { if (value > 2) score = 4; else if (value > 1.2) score = 3; else if (value < 1) score = 1; }
        if(inverseColors) { if (score === 4) score = 1; else if (score === 3) score = 2; else if (score === 1) score = 4; }
        switch(score) { case 4: badgeCss = "bg-vgood"; badgeTxt = "Very Good"; break; case 3: badgeCss = "bg-good"; badgeTxt = "Good"; break; case 1: badgeCss = "bg-bad"; badgeTxt = "Bad"; break; }
    }
    return `<div class="metric-row"><span class="metric-name">${label}</span><div style="display:flex; align-items:center;"><span class="metric-val">${displayVal}</span><span class="insight-badge ${badgeCss}">${badgeTxt}</span></div></div>`;
}
const sumTTM = (data, key) => { if (!data || data.length < 4) return 0; return data.slice(0, 4).reduce((acc, curr) => acc + (curr[key] || 0), 0); };

// --- HELPER VALUATION CARD ---
function createValoCard(title, current, history) {
    let vals = history.map(h => h).filter(v => v > 0);
    if(vals.length === 0) return "";
    let max = Math.max(...vals); let min = Math.min(...vals);
    let avg = vals.reduce((a,b)=>a+b,0) / vals.length;
    let diff = ((current - avg) / avg) * 100;
    let diffColor = (diff > 0) ? "var(--red)" : "var(--green)"; 
    let diffTxt = (diff > 0) ? "+" + diff.toFixed(0) + "% (Chaud)" : diff.toFixed(0) + "% (Sold√©)";
    
    return `
    <div class="valo-card">
        <span class="valo-diff-badge" style="background:${diffColor}20; color:${diffColor}">${diffTxt}</span>
        <span class="valo-metric-name">${title}</span>
        <div class="valo-current">${current.toFixed(1)}x</div>
        <div style="margin-bottom:5px;"><span class="valo-avg-label">Moyenne 5 ans:</span> <span class="valo-avg-val">${avg.toFixed(1)}x</span></div>
        <div class="valo-stats-row"><div>High: <b>${max.toFixed(1)}</b></div><div>Low: <b>${min.toFixed(1)}</b></div></div>
    </div>`;
}

// ========== MAIN FUNCTION ==========
async function runFullAnalysis() {
    let t = document.getElementById('ticker').value.trim().toUpperCase();
    if(!t) return;
    if(t === "APPAL") t = "AAPL"; 
    const status = document.getElementById('status');
    status.innerText = "‚åõ Analyse compl√®te en cours...";
    status.style.color = "#f0b90b";
    document.getElementById('dashboardArea').style.display = "none";

    try {
        const pRes = fetch(`https://financialmodelingprep.com/stable/profile?symbol=${t}&apikey=${API_KEY}`);
        const cfAnnRes = fetch(`https://financialmodelingprep.com/stable/cash-flow-statement?symbol=${t}&period=annual&limit=2&apikey=${API_KEY}`);
        const incAnnRes = fetch(`https://financialmodelingprep.com/stable/income-statement?symbol=${t}&period=annual&limit=2&apikey=${API_KEY}`);
        const balAnnRes = fetch(`https://financialmodelingprep.com/stable/balance-sheet-statement?symbol=${t}&period=annual&limit=1&apikey=${API_KEY}`);
        const cfQtrRes = fetch(`https://financialmodelingprep.com/stable/cash-flow-statement?symbol=${t}&period=quarter&limit=4&apikey=${API_KEY}`);
        const incQtrRes = fetch(`https://financialmodelingprep.com/stable/income-statement?symbol=${t}&period=quarter&limit=4&apikey=${API_KEY}`);
        const ratioRes = fetch(`https://financialmodelingprep.com/stable/ratios?symbol=${t}&period=annual&limit=5&apikey=${API_KEY}`);

        const [profD, cfAnn, incAnn, balAnn, cfQtr, incQtr, ratiosHist] = await Promise.all([
            pRes.then(r=>r.json()), cfAnnRes.then(r=>r.json()), incAnnRes.then(r=>r.json()), balAnnRes.then(r=>r.json()),
            cfQtrRes.then(r=>r.json()), incQtrRes.then(r=>r.json()), ratioRes.then(r=>r.json())
        ]);

        if (!profD[0]) throw new Error("Action introuvable.");
        const prof = profD[0];
        
        const lastInc = incAnn[0] || {}; const prevInc = incAnn[1] || {};
        const lastBal = balAnn[0] || {}; const lastCF = cfAnn[0] || {};
        dashData = {
            revGrowth: prevInc.revenue ? (lastInc.revenue - prevInc.revenue) / prevInc.revenue : 0,
            netGrowth: prevInc.netIncome ? (lastInc.netIncome - prevInc.netIncome) / prevInc.netIncome : 0,
            grossMargin: lastInc.revenue ? lastInc.grossProfit / lastInc.revenue : 0,
            netMargin: lastInc.revenue ? lastInc.netIncome / lastInc.revenue : 0,
            currentRatio: lastBal.totalCurrentLiabilities ? lastBal.totalCurrentAssets / lastBal.totalCurrentLiabilities : 0,
            debtEquity: lastBal.totalStockholdersEquity ? lastBal.totalDebt / lastBal.totalStockholdersEquity : 0,
            roe: lastBal.totalStockholdersEquity ? lastInc.netIncome / lastBal.totalStockholdersEquity : 0,
            fcfMargin: lastInc.revenue ? lastCF.freeCashFlow / lastInc.revenue : 0,
            peRatio: (lastInc.eps) ? prof.price / lastInc.eps : 0
        };

        document.getElementById('blkGrowth').innerHTML = createRow("Croissance CA", dashData.revGrowth, true) + createRow("Croissance Net", dashData.netGrowth, true);
        document.getElementById('blkProfit').innerHTML = createRow("Marge Brute", dashData.grossMargin, true) + createRow("Marge Nette", dashData.netMargin, true);
        document.getElementById('blkHealth').innerHTML = createRow("Current Ratio", dashData.currentRatio, false) + createRow("Debt / Equity", dashData.debtEquity, false, true);
        document.getElementById('blkEfficiency').innerHTML = createRow("ROE", dashData.roe, true);
        document.getElementById('blkValuation').innerHTML = createRow("P/E (Annuel)", dashData.peRatio, false, true);
        document.getElementById('blkCashflow').innerHTML = createRow("Marge FCF", dashData.fcfMargin, true);

        document.getElementById('companyName').innerText = prof.companyName;
        let s1 = (dashData.revGrowth > 0.15) ? 5 : 3; let s2 = (dashData.netMargin > 0.20) ? 5 : 3; let s3 = (dashData.currentRatio > 1.2) ? 5 : 3;
        let gScore = ((s1+s2+s3)/3).toFixed(1);
        document.getElementById('globalScore').innerText = gScore;
        let dColor = (gScore>=4)?"var(--vgood)":(gScore>=2.5)?"var(--avg)":"var(--bad)";
        document.getElementById('scoreDonut').style.background = `conic-gradient(${dColor} 0% ${gScore*20}%, #2b3139 ${gScore*20}% 100%)`;
        document.getElementById('quickBlurb').innerText = `${prof.companyName} (${prof.exchangeShortName}) est cot√©e √† ${prof.price}$. Marge nette de ${(dashData.netMargin*100).toFixed(1)}%.`;

        if(ratiosHist && ratiosHist.length > 0) {
            const peHist = ratiosHist.map(r => r.priceEarningsRatio);
            const pfcfHist = ratiosHist.map(r => r.priceToFreeCashFlowRatio);
            const pocfHist = ratiosHist.map(r => r.priceToOperatingCashFlowRatio);
            const psHist = ratiosHist.map(r => r.priceToSalesRatio); 
            const curPE = prof.price / (incQtr.slice(0,4).reduce((a,b)=>a+b.eps,0) || lastInc.eps);
            
            let gridHTML = "";
            gridHTML += createValoCard("Price / Earnings", curPE || ratiosHist[0].priceEarningsRatio, peHist);
            gridHTML += createValoCard("Price / Free Cash Flow", ratiosHist[0].priceToFreeCashFlowRatio, pfcfHist); 
            gridHTML += createValoCard("Price / Operating CF", ratiosHist[0].priceToOperatingCashFlowRatio, pocfHist);
            gridHTML += createValoCard("Price / Sales", ratiosHist[0].priceToSalesRatio, psHist);
            document.getElementById('valuationGrid').innerHTML = gridHTML;
            document.getElementById('sectorPeDisplay').innerHTML = `Sector Avg P/E: <b>${(curPE * 0.8).toFixed(1)}</b> (Est.)`; 
        }

        const mktCap = prof.mktCap || prof.marketCap || 0;
        const price = prof.price || 0;
        const shares = (mktCap && price) ? (mktCap / price) : 1;
        dashData.shares = shares; 

        dcfData = {
            price: price, shares: shares,
            fcf: sumTTM(cfQtr, 'freeCashFlow'), ocf: sumTTM(cfQtr, 'operatingCashFlow'),
            netIncome: sumTTM(incQtr, 'netIncome'), oi: sumTTM(incQtr, 'operatingIncome'),
            symbol: prof.symbol, currency: prof.currency || "$"
        };
        document.getElementById('dcfCurrentPrice').innerText = dcfData.price.toFixed(2) + " " + dcfData.currency;
        
        status.innerText = `‚úÖ Analyse termin√©e pour ${prof.symbol}`;
        status.style.color = "#0ecb81";
        document.getElementById('dashboardArea').style.display = "block";
        calculateDCF();

    } catch (e) {
        console.error(e);
        status.innerText = "‚ùå Erreur: " + e.message;
        status.style.color = "#f6465d";
    }
}

function selectMetric(k, b) { currentMetric = k; document.querySelectorAll('.metric-btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); calculateDCF(); }
function calculateDCF() {
    if(!dcfData.price) return;
    const base = dcfData[currentMetric];
    if (base <= 0) { document.getElementById('marginSafetyBox').innerHTML = "Flux n√©gatif. DCF Impossible."; return; }
    const gr = parseFloat(document.getElementById('growthInput').value)/100;
    const mu = parseFloat(document.getElementById('multInput').value);
    const fut = ((base * Math.pow(1+gr, 5)) * mu) / dcfData.shares;
    const fair = fut / Math.pow(1.10, 5);
    const cagr = (Math.pow(fut/dcfData.price, 1/5)-1)*100;
    const up = ((fair - dcfData.price)/dcfData.price)*100;
    document.getElementById('resFairToday').innerText = fair.toFixed(2) + " " + dcfData.currency;
    document.getElementById('resFutureValue').innerText = fut.toFixed(2) + " " + dcfData.currency;
    document.getElementById('resCAGR').innerText = cagr.toFixed(1) + "%";
    const box = document.getElementById('marginSafetyBox');
    if(up>0) { box.innerHTML = `SOUS-√âVALU√âE de <span style="color:var(--vgood)">${up.toFixed(1)}%</span> üöÄ`; box.style.background = "rgba(0,184,148,0.1)"; }
    else { box.innerHTML = `SUR-√âVALU√âE de <span style="color:var(--red)">${Math.abs(up).toFixed(1)}%</span> ‚ö†Ô∏è`; box.style.background = "rgba(246,70,93,0.1)"; }
}
</script>
</body>
</html>
