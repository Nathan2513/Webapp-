<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Master - Ultimate Dashboard</title>
    <style>
        /* --- VARIABLES & RESET --- */
        :root { --bg: #0b0e11; --card: #1e2329; --text: #eaecef; --blurple: #f0b90b; --green: #0ecb81; --red: #f6465d; --gray-btn: #2b3139; --bad: #f6465d; --avg: #eebb00; --good: #0ecb81; --vgood: #00b894; }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .main-wrapper { width: 100%; max-width: 1100px; display: flex; flex-direction: column; gap: 25px; }
        
        /* --- COMMON COMPONENTS --- */
        .card-base { background: var(--card); border-radius: 16px; border: 1px solid #2b3139; }
        .btn-fetch { background: var(--blurple); color: #000; border: none; padding: 0 25px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; }
        .btn-fetch:hover { opacity: 0.9; }
        input[type="text"] { flex: 1; padding: 14px; background: #2b3139; border: 1px solid #474d57; border-radius: 8px; color: #fff; font-size: 1rem; outline: none; }

        /* --- SEARCH Header --- */
        .search-card { padding: 25px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .search-group { display: flex; gap: 10px; margin-top: 15px; max-width: 600px; margin-left: auto; margin-right: auto; }

        /* --- DASHBOARD CONTAINER --- */
        #dashboardArea { display: none; }

        /* --- HEADER BLOCK (Score + Blurb) - Full Width --- */
        .header-block { display: flex; gap: 30px; padding: 25px; align-items: center; margin-bottom: 30px; }
        @media (max-width: 768px) { .header-block { flex-direction: column; text-align: center; } }
        
        /* Score Donut Chart */
        .donut-chart { position: relative; width: 140px; height: 140px; border-radius: 50%; background: conic-gradient(var(--good) 0% 0%, #2b3139 0% 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .donut-inner { width: 110px; height: 110px; background: var(--card); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2; }
        .total-score { font-size: 2.2rem; font-weight: 800; color: #fff; }
        .total-label { font-size: 0.7rem; color: #848e9c; text-transform: uppercase; margin-top: -5px; }

        /* Text Blurb */
        .blurb-container { flex: 1; }
        .company-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; color: var(--blurple); }
        .blurb-text { font-size: 1rem; line-height: 1.6; color: #b7bdc6; background: #262b33; padding: 20px; border-radius: 12px; border-left: 4px solid var(--blurple); }

        /* --- 6-BLOCK GRID SYSTEM --- */
        .six-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        @media (max-width: 950px) { .six-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .six-grid { grid-template-columns: 1fr; } }
        
        .dash-card { padding: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #2b3139; padding-bottom: 10px; }
        .card-title { font-weight: 700; font-size: 1rem; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Metrics Rows & Badges */
        .metric-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #2b3139; font-size: 0.9rem; }
        .metric-name { color: #848e9c; }
        .metric-val { font-weight: bold; color: #fff; margin-right: 10px; }
        .insight-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; font-weight: 700; min-width: 65px; text-align: center; display: inline-block; }
        .bg-vgood { background: rgba(0, 184, 148, 0.15); color: var(--vgood); }
        .bg-good { background: rgba(14, 203, 129, 0.15); color: var(--good); }
        .bg-avg { background: rgba(238, 187, 0, 0.15); color: var(--avg); }
        .bg-bad { background: rgba(246, 70, 93, 0.15); color: var(--bad); }

        /* --- DCF SECTION (FIG√â) --- */
        .dcf-wrapper { background: var(--card); padding: 30px; border-radius: 20px; border-top: 4px solid var(--blurple); box-shadow: 0 -5px 20px rgba(240, 185, 11, 0.1); }
        .dcf-title { text-align: center; color: var(--blurple); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 25px; }
        @media (max-width: 600px) { .metrics-grid { grid-template-columns: repeat(2, 1fr); } }
        .metric-btn { background: var(--gray-btn); border: 1px solid #474d57; color: #848e9c; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 0.8rem; }
        .metric-btn:hover { background: #363c45; }
        .metric-btn.active { background: var(--blurple); color: #000; border-color: var(--blurple); }

        .inputs-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .input-box .label-txt { font-size: 0.7rem; color: #848e9c; margin-bottom: 8px; display: block; font-weight: 600; text-transform: uppercase; }
        .input-box input { width: 100%; padding: 14px; background: var(--gray-btn); border: 1px solid #474d57; border-radius: 10px; color: #fff; font-size: 1.1rem; text-align: center; font-weight: bold; outline: none; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .results-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        @media (max-width: 600px) { .results-grid { grid-template-columns: 1fr; } }
        .result-box { background: #2b3139; padding: 15px 5px; border-radius: 12px; text-align: center; border: 1px solid #474d57; }
        .res-label { font-size: 0.65rem; color: #848e9c; margin-bottom: 5px; display: block; text-transform: uppercase; }
        .res-value { font-size: 1.3rem; font-weight: 800; color: var(--text); }
        .res-main { color: var(--blurple); }
        
        .margin-safety { text-align: center; margin-top: 20px; font-weight: 800; font-size: 1.2rem; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; }
    </style>
</head>
<body>

<div class="main-wrapper">
    
    <div class="search-card card-base">
        <h2 style="margin:0 0 15px 0; color:var(--blurple); letter-spacing: 1px;">STOCK MASTER PRO</h2>
        <div class="search-group">
            <input type="text" id="ticker" placeholder="Tapez un ticker US (ex: NVDA, AAPL)">
            <button class="btn-fetch" onclick="runFullAnalysis()">LANCER L'ANALYSE</button>
        </div>
        <div id="status" style="margin-top:15px; color:#848e9c; font-size:0.9rem; font-weight: 500;">En attente...</div>
    </div>

    <div id="dashboardArea">
        
        <div class="header-block card-base">
            <div class="donut-chart" id="scoreDonut">
                <div class="donut-inner">
                    <span class="total-score" id="globalScore">--</span>
                    <span class="total-label">GLOBAL SCORE / 5</span>
                </div>
            </div>
            <div class="blurb-container">
                <div class="company-title" id="companyName">--</div>
                <div class="blurb-text" id="quickBlurb">Chargement des donn√©es...</div>
            </div>
        </div>

        <div class="six-grid">
            <div class="dash-card card-base">
                <div class="card-header"><span class="card-title">üöÄ Croissance</span></div>
                <div id="blkGrowth"></div>
            </div>
            <div class="dash-card card-base">
                <div class="card-header"><span class="card-title">üí∞ Profitabilit√©</span></div>
                <div id="blkProfit"></div>
            </div>
             <div class="dash-card card-base">
                <div class="card-header"><span class="card-title">üè¶ Sant√© Financi√®re</span></div>
                <div id="blkHealth"></div>
            </div>
             <div class="dash-card card-base">
                <div class="card-header"><span class="card-title">‚öôÔ∏è Efficacit√©</span></div>
                <div id="blkEfficiency"></div>
            </div>
             <div class="dash-card card-base">
                <div class="card-header"><span class="card-title">üíé Valorisation (TTM)</span></div>
                <div id="blkValuation"></div>
            </div>
             <div class="dash-card card-base">
                <div class="card-header"><span class="card-title">üíµ Cash Flow Strength</span></div>
                <div id="blkCashflow"></div>
            </div>
        </div>

        <div class="dcf-wrapper">
            <h3 class="dcf-title">üßÆ Calculateur de Valeur Intrins√®que (DCF TTM)</h3>
            
            <div style="text-align:center; margin-bottom:20px; font-size:0.95rem; color:#848e9c;">
                Prix Actuel du march√© : <span id="dcfCurrentPrice" style="color:#fff; font-weight:bold; font-size:1.1rem;">--</span>
            </div>

            <div style="font-size:0.75rem; color:#848e9c; margin-bottom:10px; font-weight:bold; text-transform: uppercase; text-align: center;">S√©lectionner la m√©trique de d√©part (TTM)</div>
            <div class="metrics-grid">
                <button class="metric-btn active" onclick="selectMetric('fcf', this)">Free Cash Flow</button>
                <button class="metric-btn" onclick="selectMetric('netIncome', this)">Net Income</button>
                <button class="metric-btn" onclick="selectMetric('ocf', this)">Operating CF</button>
                <button class="metric-btn" onclick="selectMetric('oi', this)">Operating Inc.</button>
            </div>

            <div class="inputs-grid">
                <div class="input-box">
                    <span class="label-txt">Croissance estim√©e 5 ans (%)</span>
                    <input type="number" id="growthInput" value="15" oninput="calculateDCF()">
                </div>
                <div class="input-box">
                    <span class="label-txt">Multiple de sortie terminal</span>
                    <input type="number" id="multInput" value="25" oninput="calculateDCF()">
                </div>
            </div>
            
            <div class="results-grid">
                <div class="result-box" style="border-color: var(--blurple);">
                    <span class="res-label">Fair Value (Aujourd'hui)</span>
                    <div id="resFairToday" class="res-value res-main">0.00 $</div>
                </div>
                <div class="result-box">
                    <span class="res-label">Valeur Future (5 ans)</span>
                    <div id="resFutureValue" class="res-value">0.00 $</div>
                </div>
                <div class="result-box">
                    <span class="res-label">Rendement Annuel (CAGR)</span>
                    <div id="resCAGR" class="res-value" style="color:var(--green);">0.0%</div>
                </div>
            </div>
            
            <div id="marginSafetyBox" class="margin-safety"></div>
        </div>
    </div>
</div>

<script>
const API_KEY = "cCUKcjC9uAt3yTUyvtGbYl5CrI41G21e";

// --- VARIABLES GLOBALES (Stockage des donn√©es) ---
// dcfData : Contient les donn√©es TTM (somme 4 trimestres) pour le calculateur DCF
let dcfData = { price: 0, shares: 0, fcf: 0, netIncome: 0, ocf: 0, oi: 0, currency: "$" };
// dashData : Contient les ratios annuels pour les 6 blocs du dashboard
let dashData = {}; 
let currentMetric = 'fcf'; // M√©trique DCF par d√©faut

// --- HELPER: G√©n√®re une ligne avec badge ---
function createRow(label, value, isPercent, inverseColors = false) {
    let displayVal = "N/A";
    let badgeCss = "bg-avg"; let badgeTxt = "Avg";

    if (value !== null && value !== undefined && !isNaN(value)) {
        displayVal = isPercent ? (value * 100).toFixed(1) + "%" : value.toFixed(2);
        
        // Logique de scoring simplifi√©e
        let score = 2; // 1=Bad, 2=Avg, 3=Good, 4=VeryGood
        if (isPercent) {
            if (value > 0.20) score = 4; else if (value > 0.10) score = 3; else if (value < 0.02) score = 1;
        } else {
            // Ratios type Current Ratio
             if (value > 2) score = 4; else if (value > 1.2) score = 3; else if (value < 1) score = 1;
        }

        if(inverseColors) { // Pour les ratios o√π "bas" est mieux (ex: Dette)
             if (score === 4) score = 1; else if (score === 3) score = 2; else if (score === 1) score = 4;
        }

        switch(score) {
            case 4: badgeCss = "bg-vgood"; badgeTxt = "Very Good"; break;
            case 3: badgeCss = "bg-good"; badgeTxt = "Good"; break;
            case 1: badgeCss = "bg-bad"; badgeTxt = "Bad"; break;
        }
    }

    return `
    <div class="metric-row">
        <span class="metric-name">${label}</span>
        <div style="display:flex; align-items:center;">
            <span class="metric-val">${displayVal}</span>
            <span class="insight-badge ${badgeCss}">${badgeTxt}</span>
        </div>
    </div>`;
}

// --- HELPER: Somme des 4 derniers trimestres (TTM) ---
const sumTTM = (data, key) => {
    if (!data || data.length < 4) return 0;
    return data.slice(0, 4).reduce((acc, curr) => acc + (curr[key] || 0), 0);
};


// ========== FONCTION PRINCIPALE : LANCE TOUT ==========
async function runFullAnalysis() {
    let t = document.getElementById('ticker').value.trim().toUpperCase();
    if(!t) return;
    if(t === "APPAL") t = "AAPL"; 

    const status = document.getElementById('status');
    status.innerText = "‚åõ Analyse approfondie en cours (6 requ√™tes API)...";
    status.style.color = "#f0b90b";
    document.getElementById('dashboardArea').style.display = "none";

    try {
        // --- APPELS API (6 au total) ---
        // 1. Donn√©es Annuelles pour le Dashboard (Ratios)
        const pRes = fetch(`https://financialmodelingprep.com/stable/profile?symbol=${t}&apikey=${API_KEY}`);
        const cfAnnRes = fetch(`https://financialmodelingprep.com/stable/cash-flow-statement?symbol=${t}&period=annual&limit=2&apikey=${API_KEY}`);
        const incAnnRes = fetch(`https://financialmodelingprep.com/stable/income-statement?symbol=${t}&period=annual&limit=2&apikey=${API_KEY}`);
        const balAnnRes = fetch(`https://financialmodelingprep.com/stable/balance-sheet-statement?symbol=${t}&period=annual&limit=1&apikey=${API_KEY}`);
        
        // 2. Donn√©es Trimestrielles pour le DCF TTM
        const cfQtrRes = fetch(`https://financialmodelingprep.com/stable/cash-flow-statement?symbol=${t}&period=quarter&limit=4&apikey=${API_KEY}`);
        const incQtrRes = fetch(`https://financialmodelingprep.com/stable/income-statement?symbol=${t}&period=quarter&limit=4&apikey=${API_KEY}`);

        const [profileData, cfAnn, incAnn, balAnn, cfQtr, incQtr] = await Promise.all([
            pRes.then(r => r.json()), cfAnnRes.then(r => r.json()), incAnnRes.then(r => r.json()), balAnnRes.then(r => r.json()),
            cfQtrRes.then(r => r.json()), incQtrRes.then(r => r.json())
        ]);

        if (!profileData[0]) throw new Error("Action introuvable ou hors abonnement US.");
        const prof = profileData[0];

        // ========== PARTIE 1 : POPULATION DU DASHBOARD (ANNUEL) ==========
        const lastInc = incAnn[0] || {}; const prevInc = incAnn[1] || {};
        const lastBal = balAnn[0] || {}; const lastCF = cfAnn[0] || {};

        // Calcul des Ratios
        dashData = {
            revGrowth: prevInc.revenue ? (lastInc.revenue - prevInc.revenue) / prevInc.revenue : null,
            netGrowth: prevInc.netIncome ? (lastInc.netIncome - prevInc.netIncome) / prevInc.netIncome : null,
            grossMargin: lastInc.revenue ? lastInc.grossProfit / lastInc.revenue : null,
            netMargin: lastInc.revenue ? lastInc.netIncome / lastInc.revenue : null,
            currentRatio: lastBal.totalCurrentLiabilities ? lastBal.totalCurrentAssets / lastBal.totalCurrentLiabilities : null,
            debtEquity: lastBal.totalStockholdersEquity ? lastBal.totalDebt / lastBal.totalStockholdersEquity : null,
            roe: lastBal.totalStockholdersEquity ? lastInc.netIncome / lastBal.totalStockholdersEquity : null,
            fcfMargin: lastInc.revenue ? lastCF.freeCashFlow / lastInc.revenue : null,
            peRatio: (lastInc.eps) ? prof.price / lastInc.eps : null
        };

        // Remplissage des 6 Blocs
        document.getElementById('blkGrowth').innerHTML = 
            createRow("Croissance CA (1an)", dashData.revGrowth, true) +
            createRow("Croissance R√©sultat Net", dashData.netGrowth, true);
            
        document.getElementById('blkProfit').innerHTML = 
            createRow("Marge Brute", dashData.grossMargin, true) +
            createRow("Marge Nette", dashData.netMargin, true);

        document.getElementById('blkHealth').innerHTML = 
            createRow("Current Ratio", dashData.currentRatio, false) +
            createRow("Dette / Capitaux Propres", dashData.debtEquity, false, true); // Inverse colors

        document.getElementById('blkEfficiency').innerHTML = 
            createRow("ROE (Retour s/ Capitaux)", dashData.roe, true);

        document.getElementById('blkValuation').innerHTML = 
            createRow("P/E Ratio (Annuel)", dashData.peRatio, false, true) + // Lower P/E often better
            `<div style="font-size:0.7rem; color:#666; margin-top:5px;">*Bas√© sur le dernier rapport annuel</div>`;

        document.getElementById('blkCashflow').innerHTML = 
            createRow("Marge FCF", dashData.fcfMargin, true);

        // Header & Score Global / 5
        document.getElementById('companyName').innerText = prof.companyName;
        
        // Calcul Score Global Simplifi√© sur 5 (Moyenne de 3 indicateurs cl√©s)
        let s1 = (dashData.revGrowth > 0.15) ? 5 : (dashData.revGrowth > 0.05) ? 3 : 1;
        let s2 = (dashData.netMargin > 0.20) ? 5 : (dashData.netMargin > 0.10) ? 3 : 1;
        let s3 = (dashData.currentRatio > 1.5) ? 5 : (dashData.currentRatio > 1) ? 3 : 1;
        let globalScore = ((s1 + s2 + s3) / 3).toFixed(1);
        
        document.getElementById('globalScore').innerText = globalScore;
        // Update Donut Color
        let donutColor = (globalScore >= 4) ? "var(--vgood)" : (globalScore >= 2.5) ? "var(--avg)" : "var(--bad)";
        document.getElementById('scoreDonut').style.background = `conic-gradient(${donutColor} 0% ${globalScore*20}%, #2b3139 ${globalScore*20}% 100%)`;

        document.getElementById('quickBlurb').innerText = 
            `${prof.companyName} (${prof.symbol}) se n√©gocie √† ${prof.price} $. ` +
            `Le chiffre d'affaires annuel est de ${(lastInc.revenue/1e9).toFixed(1)} Mrd$. ` +
            `La marge nette est de ${(dashData.netMargin*100).toFixed(1)}%. ` +
            `L'entreprise affiche une sant√© financi√®re not√©e ${s3}/5 selon nos crit√®res de liquidit√©.`;


        // ========== PARTIE 2 : PREPARATION DU DCF TTM (FIG√â) ==========
        const mktCap = prof.mktCap || prof.marketCap || 0;
        const price = prof.price || 0;
        const shares = (mktCap && price) ? (mktCap / price) : 1;

        // Utilisation des donn√©es TRIMESTRIELLES pour le TTM
        dcfData = {
            price: price,
            shares: shares,
            fcf: sumTTM(cfQtr, 'freeCashFlow'),
            ocf: sumTTM(cfQtr, 'operatingCashFlow'),
            netIncome: sumTTM(incQtr, 'netIncome'),
            oi: sumTTM(incQtr, 'operatingIncome'),
            symbol: prof.symbol,
            currency: prof.currency || "$"
        };

        document.getElementById('dcfCurrentPrice').innerText = dcfData.price.toFixed(2) + " " + dcfData.currency;

        // Finalisation
        status.innerText = `‚úÖ Analyse compl√®te termin√©e pour ${prof.symbol}`;
        status.style.color = "#0ecb81";
        document.getElementById('dashboardArea').style.display = "block";
        
        // Lance le calcul DCF par d√©faut
        calculateDCF();

    } catch (e) {
        console.error(e);
        status.innerText = "‚ùå Erreur : " + e.message;
        status.style.color = "#f6465d";
    }
}

// ========== FONCTIONS DCF (NE PLUS TOUCHER) ==========
function selectMetric(metricKey, btnElement) {
    currentMetric = metricKey;
    document.querySelectorAll('.metric-btn').forEach(btn => btn.classList.remove('active'));
    btnElement.classList.add('active');
    calculateDCF();
}

function calculateDCF() {
    if(!dcfData.price || !dcfData.shares || dcfData.shares === 0) return;

    const baseValue = dcfData[currentMetric];
    // S√©curit√© si la m√©trique TTM est 0 ou n√©gative (√©vite les bugs de calcul)
    if (baseValue <= 0) {
         document.getElementById('resFairToday').innerText = "Impossible";
         document.getElementById('resFutureValue').innerText = "Flux n√©gatif";
         document.getElementById('resCAGR').innerText = "--";
         document.getElementById('marginSafetyBox').innerHTML = "M√©trique de base n√©gative ou nulle. DCF impossible.";
         return;
    }

    const growth = parseFloat(document.getElementById('growthInput').value) / 100;
    const mult = parseFloat(document.getElementById('multInput').value);
    
    // 1. Valeur Future (dans 5 ans) = (Flux Actuel * (1+croissance)^5) * Multiple / Actions
    const futureTotalValue = baseValue * Math.pow(1 + growth, 5);
    const futurePrice = (futureTotalValue * mult) / dcfData.shares;

    // 2. Fair Value (Aujourd'hui) = Valeur Future actualis√©e √† 10%
    const fairToday = futurePrice / Math.pow(1.10, 5);
    
    // 3. CAGR (Rendement annuel si achet√© au prix actuel et vendu au prix futur)
    let cagr = 0;
    if (dcfData.price > 0 && futurePrice > 0) {
        cagr = (Math.pow(futurePrice / dcfData.price, 1/5) - 1) * 100;
    }

    // 4. Marge de s√©curit√© (Upside)
    const upside = ((fairToday - dcfData.price) / dcfData.price) * 100;

    // --- AFFICHAGE ---
    document.getElementById('resFairToday').innerText = fairToday.toFixed(2) + " " + dcfData.currency;
    document.getElementById('resFutureValue').innerText = futurePrice.toFixed(2) + " " + dcfData.currency;
    
    const cagrEl = document.getElementById('resCAGR');
    cagrEl.innerText = cagr.toFixed(1) + "% / an";
    cagrEl.style.color = cagr >= 10 ? "var(--vgood)" : (cagr > 0 ? "var(--good)" : "var(--red)");

    const safetyBox = document.getElementById('marginSafetyBox');
    if (upside > 0) {
        safetyBox.innerHTML = `Action SOUS-√âVALU√âE de <span style="color:var(--vgood)">${upside.toFixed(1)}%</span> üöÄ`;
        safetyBox.style.background = "rgba(0, 184, 148, 0.1)";
    } else {
        safetyBox.innerHTML = `Action SUR-√âVALU√âE de <span style="color:var(--red)">${Math.abs(upside).toFixed(1)}%</span> ‚ö†Ô∏è`;
        safetyBox.style.background = "rgba(246, 70, 93, 0.1)";
    }
}
</script>
</body>
</html>
