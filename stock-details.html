<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Details ‚Äî StockMaster</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-orange:#FF7A00; --bg-main:#F9FAFB; --bg-topbar:#FFFFFF; --text-primary:#111827; --text-secondary:#6B7280; --border-color:#E5E7EB; --hover-bg:#F3F4F6; --shadow-lg:0 10px 25px -5px rgba(0,0,0,0.1); --success-color:#10B981; --danger-color:#EF4444; }
        [data-theme="dark"] { --bg-main:#0F172A; --bg-topbar:#1E293B; --text-primary:#F1F5F9; --text-secondary:#94A3B8; --border-color:#334155; --hover-bg:#334155; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:var(--bg-main); color:var(--text-primary); }
        .app-container { display:flex; flex-direction:column; min-height:100vh; }
        .main-content { flex:1; padding:30px; }

        /* TOPBAR */
        .topbar { background:var(--bg-topbar); border-bottom:1px solid var(--border-color); padding:0 30px; height:70px; display:flex; align-items:center; justify-content:space-between; }
        .topbar-logo { display:flex; align-items:center; gap:12px; font-weight:800; font-size:1.4rem; color:var(--text-primary); text-decoration:none; }
        .topbar-logo img { height:45px; }
        .topbar-nav { display:flex; gap:10px; flex:1; justify-content:center; }
        .nav-btn { padding:10px 20px; border-radius:10px; font-weight:600; font-size:0.95rem; cursor:pointer; border:2px solid var(--border-color); background:var(--bg-topbar); color:var(--text-secondary); text-decoration:none; display:inline-flex; align-items:center; gap:8px; transition:all 0.2s; }
        .nav-btn:hover { background:var(--hover-bg); color:var(--text-primary); }
        .nav-btn.active { background:var(--primary-orange); color:white; border-color:var(--primary-orange); }
        .nav-btn svg { width:18px; height:18px; }
        .topbar-actions { display:flex; align-items:center; gap:15px; }
        .theme-toggle { background:var(--hover-bg); border:1px solid var(--border-color); border-radius:10px; padding:10px 12px; cursor:pointer; display:flex; align-items:center; }
        .theme-toggle svg { width:20px; height:20px; color:var(--text-primary); }
        .user-menu { position:relative; }
        .user-avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,var(--primary-orange),#ff9f40); display:flex; align-items:center; justify-content:center; color:white; font-weight:700; cursor:pointer; }
        .dropdown-menu { position:absolute; top:55px; right:0; background:var(--bg-topbar); border:1px solid var(--border-color); border-radius:12px; box-shadow:var(--shadow-lg); min-width:220px; opacity:0; visibility:hidden; z-index:1000; transition:all 0.2s; }
        .dropdown-menu.active { opacity:1; visibility:visible; }
        .dropdown-item { padding:14px 20px; cursor:pointer; color:var(--text-primary); display:flex; align-items:center; gap:12px; text-decoration:none; }
        .dropdown-item:hover { background:var(--hover-bg); }
        .dropdown-item:last-child { color:#ef4444; border-top:1px solid var(--border-color); }
        .dropdown-item svg { width:18px; height:18px; }

        /* LAYOUT */
        .back-bar { display:flex; align-items:center; gap:14px; margin-bottom:24px; }
        .back-btn { display:inline-flex; align-items:center; gap:8px; padding:9px 18px; background:var(--bg-topbar); border:1.5px solid var(--border-color); border-radius:10px; color:var(--text-secondary); font-weight:600; font-size:0.9rem; cursor:pointer; transition:all 0.2s; font-family:inherit; }
        .back-btn:hover { border-color:var(--primary-orange); color:var(--primary-orange); }
        .back-btn svg { width:16px; height:16px; }
        .breadcrumb { font-size:0.85rem; color:var(--text-secondary); }
        .breadcrumb a { color:var(--primary-orange); text-decoration:none; }

        .page-loading { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:120px 20px; gap:16px; color:var(--text-secondary); }
        .spinner { width:40px; height:40px; border:3px solid var(--border-color); border-top-color:var(--primary-orange); border-radius:50%; animation:spin 0.7s linear infinite; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* STOCK HEADER */
        .stock-header { background:var(--bg-topbar); border:1px solid var(--border-color); border-radius:16px; padding:28px 32px; margin-bottom:24px; }
        .stock-title-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
        .stock-title { display:flex; align-items:center; gap:16px; }
        .stock-logo { width:56px; height:56px; border-radius:14px; background:linear-gradient(135deg,var(--primary-orange),#ff9f40); display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:1rem; }
        .stock-name h1 { font-size:1.6rem; font-weight:800; letter-spacing:-0.03em; }
        .stock-name p { color:var(--text-secondary); font-size:0.9rem; margin-top:4px; }
        .stock-price-row { display:flex; align-items:center; gap:16px; flex-wrap:wrap; }
        .current-price { font-size:2rem; font-weight:800; letter-spacing:-0.04em; }
        .price-change { font-size:1rem; font-weight:600; padding:4px 12px; border-radius:8px; }
        .price-change.positive { color:var(--success-color); background:rgba(16,185,129,0.1); }
        .price-change.negative { color:var(--danger-color); background:rgba(239,68,68,0.1); }
        .score-badge { margin-left:auto; display:flex; align-items:center; gap:10px; background:var(--hover-bg); border:1px solid var(--border-color); border-radius:12px; padding:10px 20px; }
        .score-label { font-size:0.8rem; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.05em; }
        .score-value { font-size:1.4rem; font-weight:800; }

        /* TABS */
        .tabs-nav { display:flex; gap:4px; border-bottom:2px solid var(--border-color); margin-bottom:24px; overflow-x:auto; }
        .tab-btn { padding:12px 24px; background:none; border:none; font-family:inherit; font-size:0.95rem; font-weight:600; color:var(--text-secondary); cursor:pointer; border-bottom:2px solid transparent; margin-bottom:-2px; transition:all 0.2s; white-space:nowrap; }
        .tab-btn:hover { color:var(--text-primary); }
        .tab-btn.active { color:var(--primary-orange); border-bottom-color:var(--primary-orange); }
        .tab-content { display:none; }
        .tab-content.active { display:block; }

        /* METRICS */
        .metrics-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(180px,1fr)); gap:16px; margin-bottom:32px; }
        .metric-card { background:var(--bg-topbar); border:1px solid var(--border-color); border-radius:12px; padding:20px; }
        .metric-label { font-size:0.8rem; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:10px; }
        .metric-value { font-size:1.6rem; font-weight:800; letter-spacing:-0.03em; }

        /* FINANCIALS */
        .fin-toolbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; gap:16px; flex-wrap:wrap; }
        .fin-tabs { display:flex; gap:4px; flex-wrap:wrap; }
        .fin-btn { padding:8px 18px; background:var(--hover-bg); border:1px solid var(--border-color); border-radius:8px; font-family:inherit; font-size:0.88rem; font-weight:600; color:var(--text-secondary); cursor:pointer; transition:all 0.2s; }
        .fin-btn:hover { color:var(--text-primary); }
        .fin-btn.active { background:var(--primary-orange); color:white; border-color:var(--primary-orange); }
        .period-toggle { display:flex; gap:4px; }
        .period-btn { padding:8px 16px; background:var(--hover-bg); border:1px solid var(--border-color); border-radius:8px; font-family:inherit; font-size:0.85rem; font-weight:600; color:var(--text-secondary); cursor:pointer; transition:all 0.2s; }
        .period-btn.active { background:var(--text-primary); color:var(--bg-topbar); border-color:var(--text-primary); }
        .fin-panel { display:none; }
        .fin-panel.active { display:block; }

        /* TABLES */
        .table-wrap { overflow-x:auto; border-radius:12px; border:1px solid var(--border-color); }
        .data-table { width:100%; border-collapse:collapse; font-size:0.88rem; min-width:600px; }
        .data-table th { padding:12px 16px; text-align:right; font-size:0.78rem; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.05em; border-bottom:1px solid var(--border-color); background:var(--hover-bg); white-space:nowrap; }
        .data-table th:first-child { text-align:left; }
        .data-table td { padding:12px 16px; border-bottom:1px solid var(--border-color); text-align:right; white-space:nowrap; }
        .data-table td:first-child { text-align:left; font-weight:600; color:var(--text-secondary); font-size:0.82rem; }
        .data-table tr:last-child td { border-bottom:none; }
        .data-table tr:hover td { background:var(--hover-bg); }
        .pos { color:var(--success-color); } .neg { color:var(--danger-color); }
        .row-sep td { padding:8px 16px; font-weight:700; color:var(--text-primary); background:var(--hover-bg); font-size:0.78rem; text-transform:uppercase; letter-spacing:0.05em; }

        .chart-placeholder { background:var(--bg-topbar); border:1px solid var(--border-color); border-radius:12px; padding:40px; text-align:center; color:var(--text-secondary); margin-bottom:24px; }
    </style>
</head>
<body>
<div class="app-container">
        <header class="topbar">
            <a href="webapp.html" class="topbar-logo">
                <img src="logo.png" alt="Logo">
                StockMaster
            </a>
            <nav class="topbar-nav">
                <a href="webapp.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Home
                </a>
                <a href="stock-screener.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Stock Screener
                </a>
                <a href="valorisation-analysis.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Valorisation Analysis
                </a>
                <a href="dcf-calculator.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    DCF Calculator
                </a>
            </nav>
            <div class="topbar-actions">
                <button class="theme-toggle" id="themeToggle">
                    <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="moonIcon" style="display:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="settings.html" class="dropdown-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Settings
                        </a>
                        <a href="billings-plans.html" class="dropdown-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                            </svg>
                            Billings & Plans
                        </a>
                        <div class="dropdown-item" id="signOutBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Sign Out
                        </div>
                    </div>
                </div>
            </div>
        </header>
    <main class="main-content">
        <div class="back-bar">
            <button class="back-btn" id="backBtn">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                Back
            </button>
            <span class="breadcrumb">
                <a href="stock-screener.html">Stock Screener</a> / <span id="breadcrumb">‚Äî</span>
            </span>
        </div>

        <div id="loadingDiv" class="page-loading">
            <div class="spinner"></div>
            Loading stock data...
        </div>

        <div id="pageContent" style="display:none"></div>
    </main>
</div>

<script>


// score-engine.js
// Syst√®me de scoring StockUnlock ‚Äî 6 cat√©gories, 26 m√©triques
// Import dans stock-screener.html via: import { computeAllScores, renderScoresTab } from './score-engine.js';

// ============================================================
// SCORE ENGINE ‚Äî Full StockUnlock-style scoring system
// ============================================================

const SCORE_LABELS = {
    5: { label: 'Tr√®s bien',    color: '#22c55e', bg: 'rgba(34,197,94,0.15)' },
    4: { label: 'Bien',         color: '#86efac', bg: 'rgba(134,239,172,0.15)' },
    3: { label: 'Moyenne',      color: '#f59e0b', bg: 'rgba(245,158,11,0.15)' },
    2: { label: 'Mauvais',      color: '#f97316', bg: 'rgba(249,115,22,0.15)' },
    1: { label: 'Tr√®s mauvais', color: '#ef4444', bg: 'rgba(239,68,68,0.15)' },
};

function getScoreLabel(score) {
    if (score == null) return { label: 'N/A', color: 'var(--text-secondary)', bg: 'var(--hover-bg)' };
    return SCORE_LABELS[Math.round(Math.max(1, Math.min(5, score)))];
}

function scoreByThreshold(value, [t1, t2, t3, t4], higherIsBetter = true) {
    if (value == null || isNaN(value)) return null;
    if (higherIsBetter) {
        if (value >= t4) return 5;
        if (value >= t3) return 4;
        if (value >= t2) return 3;
        if (value >= t1) return 2;
        return 1;
    } else {
        if (value <= t1) return 5;
        if (value <= t2) return 4;
        if (value <= t3) return 3;
        if (value <= t4) return 2;
        return 1;
    }
}

function pctVal(v) { return v != null ? v * 100 : null; }

function growthPct(curr, prev) {
    if (curr == null || prev == null || prev === 0) return null;
    return ((curr - prev) / Math.abs(prev)) * 100;
}

function avgArr(arr) {
    const v = arr.filter(x => x != null);
    return v.length ? v.reduce((a, b) => a + b, 0) / v.length : null;
}

// ‚îÄ‚îÄ Category: Rentabilit√© ‚îÄ‚îÄ
function scoreRentabilite(data) {
    const r   = data.ratios   || {};
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const rev = inc[0]?.revenue;
    const gp  = inc[0]?.grossProfit;
    const op  = inc[0]?.operatingIncome;
    const ni  = inc[0]?.netIncome;
    const fcf = cf[0]?.freeCashFlow;
    const ocf = cf[0]?.operatingCashFlow;

    const grossM = rev ? (gp  / rev) * 100 : pctVal(r.grossProfitMarginTTM);
    const opM    = rev ? (op  / rev) * 100 : pctVal(r.operatingProfitMarginTTM);
    const netM   = rev ? (ni  / rev) * 100 : pctVal(r.netProfitMarginTTM);
    const fcfM   = (fcf != null && rev) ? (fcf / rev) * 100 : null;
    const cashConv = (fcf != null && ni && ni !== 0) ? (fcf / ni) * 100 : null;

    const metrics = [
        { label: 'Marge brute',           value: grossM,   format: 'pct', score: scoreByThreshold(grossM,   [20, 35, 50, 65]) },
        { label: 'Marge op√©rationnelle',   value: opM,      format: 'pct', score: scoreByThreshold(opM,      [5, 10, 15, 25]) },
        { label: 'Marge nette',            value: netM,     format: 'pct', score: scoreByThreshold(netM,     [3, 7, 12, 20]) },
        { label: 'Marge FCF',              value: fcfM,     format: 'pct', score: scoreByThreshold(fcfM,     [2, 5, 10, 18]) },
        { label: 'Conversion tr√©sorerie',  value: cashConv, format: 'pct', score: scoreByThreshold(cashConv, [20, 40, 60, 80]) },
    ];

    return buildCategory('Rentabilit√©', 'üìà', metrics);
}

// ‚îÄ‚îÄ Category: Gestion ‚îÄ‚îÄ
function scoreGestion(data) {
    const r   = data.ratios   || {};
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const rev = inc[0]?.revenue;
    const ocf = cf[0]?.operatingCashFlow;
    const fcf = cf[0]?.freeCashFlow;
    const sbc = cf[0]?.stockBasedCompensation;

    const sbcRev = (sbc != null && rev) ? (sbc / rev) * 100 : null;
    const sbcOcf = (sbc != null && ocf && ocf > 0) ? (sbc / ocf) * 100 : null;
    const sbcFcf = (sbc != null && fcf && fcf > 0) ? (sbc / fcf) * 100 : null;
    const roic   = pctVal(r.roicTTM);
    const roce   = pctVal(r.returnOnCapitalEmployedTTM);

    const metrics = [
        { label: "SBC en % du chiffre d'affaires",                   value: sbcRev, format: 'pct', score: scoreByThreshold(sbcRev, [1, 3, 5, 10],   false) },
        { label: "SBC en % du flux de tr√©sorerie d'exploitation",    value: sbcOcf, format: 'pct', score: scoreByThreshold(sbcOcf, [5, 10, 20, 35],  false) },
        { label: "SBC en % du flux de tr√©sorerie disponible",        value: sbcFcf, format: 'pct', score: scoreByThreshold(sbcFcf, [10, 25, 50, 100], false) },
        { label: 'ROIC',                                              value: roic,   format: 'pct', score: scoreByThreshold(roic,   [5, 10, 15, 25]) },
        { label: 'ROCE',                                              value: roce,   format: 'pct', score: scoreByThreshold(roce,   [5, 10, 15, 25]) },
    ];

    return buildCategory('Gestion', '‚öôÔ∏è', metrics);
}

// ‚îÄ‚îÄ Category: Croissance ‚îÄ‚îÄ
function scoreCroissance(data) {
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const revG  = growthPct(inc[0]?.revenue,        inc[1]?.revenue);
    const gpG   = growthPct(inc[0]?.grossProfit,    inc[1]?.grossProfit);
    const opG   = growthPct(inc[0]?.operatingIncome,inc[1]?.operatingIncome);
    const niG   = growthPct(inc[0]?.netIncome,      inc[1]?.netIncome);
    const ocfG  = growthPct(cf[0]?.operatingCashFlow, cf[1]?.operatingCashFlow);

    const metrics = [
        { label: 'Augmentation des revenus',                           value: revG, format: 'pct', score: scoreByThreshold(revG, [0, 5, 10, 20]) },
        { label: 'Augmentation du b√©n√©fice brut',                      value: gpG,  format: 'pct', score: scoreByThreshold(gpG,  [0, 5, 10, 20]) },
        { label: "Augmentation du r√©sultat d'exploitation",            value: opG,  format: 'pct', score: scoreByThreshold(opG,  [0, 5, 15, 30]) },
        { label: 'Augmentation du revenu net',                         value: niG,  format: 'pct', score: scoreByThreshold(niG,  [0, 5, 15, 30]) },
        { label: "Augmentation des flux de tr√©sorerie d'exploitation", value: ocfG, format: 'pct', score: scoreByThreshold(ocfG, [-5, 0, 10, 25]) },
    ];

    return buildCategory('Croissance', 'üöÄ', metrics);
}

// ‚îÄ‚îÄ Category: Sant√© financi√®re ‚îÄ‚îÄ
function scoreSanteFinanciere(data) {
    const r   = data.ratios   || {};
    const b   = data.balance  || [];
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const curRatio = r.currentRatioTTM ?? (b[0] ? (b[0].totalCurrentAssets || 0) / Math.max(b[0].totalCurrentLiabilities || 1, 1) : null);
    const intang   = b[0] ? ((b[0].goodwill || 0) + (b[0].intangibleAssets || 0)) : null;
    const totA     = b[0]?.totalAssets;
    const intangPct = (intang != null && totA) ? (intang / totA) * 100 : null;
    const shareG   = growthPct(inc[0]?.weightedAverageSharesOutDil, inc[1]?.weightedAverageSharesOutDil);
    const ebitda   = inc[0]?.ebitda;
    const debt     = b[0]?.totalDebt;
    const debtEbitda = (debt != null && ebitda && ebitda > 0) ? debt / ebitda : null;

    const metrics = [
        { label: 'Ratio actuel',                              value: curRatio,   format: 'ratio', score: scoreByThreshold(curRatio,   [0.5, 0.8, 1.2, 2.0]) },
        { label: 'Actifs incorporels en % du total des actifs', value: intangPct, format: 'pct',   score: scoreByThreshold(intangPct,  [5, 15, 30, 50], false) },
        { label: 'Les actions augmentent',                    value: shareG,     format: 'pct',   score: scoreByThreshold(shareG,     [-2, 0, 1, 3], false) },
        { label: 'Ratio dette/EBITDA',                        value: debtEbitda, format: 'ratio', score: scoreByThreshold(debtEbitda, [0.5, 1.0, 2.0, 4.0], false) },
    ];

    return buildCategory('Sant√© financi√®re', 'üè¶', metrics);
}

// ‚îÄ‚îÄ Category: Analyste (proxy via croissance historique) ‚îÄ‚îÄ
function scoreAnalyste(data) {
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const epsG    = growthPct(inc[0]?.epsdiluted,  inc[1]?.epsdiluted);
    const revG    = growthPct(inc[0]?.revenue,     inc[1]?.revenue);
    const ebitdaG = growthPct(inc[0]?.ebitda,      inc[1]?.ebitda);

    const metrics = [
        { label: "BPA projet√© pour l'ann√©e prochaine",    value: epsG,    format: 'pct', score: scoreByThreshold(epsG,    [0, 5, 15, 30]) },
        { label: "Revenus projet√©s pour l'ann√©e prochaine", value: revG,  format: 'pct', score: scoreByThreshold(revG,    [0, 5, 10, 20]) },
        { label: "EBITDA projet√© pour l'ann√©e prochaine",  value: ebitdaG,format: 'pct', score: scoreByThreshold(ebitdaG, [0, 5, 15, 30]) },
    ];

    return buildCategory('Analyste', 'üî≠', metrics);
}

// ‚îÄ‚îÄ Category: √âvaluation ‚îÄ‚îÄ
function scoreEvaluation(data) {
    const r  = data.ratios        || {};
    const rh = data.ratiosHistory || [];

    const pe   = r.priceEarningsRatioTTM;
    const pfcf = r.priceToFreeCashFlowsRatioTTM;
    const ps   = r.priceToSalesRatioTTM;

    const last5 = rh.slice(0, 5);
    const safe  = (arr) => arr.filter(v => v != null && v > 0 && v < 500);
    const avg5  = (arr) => { const a = safe(arr); return a.length ? a.reduce((s, v) => s + v, 0) / a.length : null; };

    const avgPE5   = avg5(last5.map(y => y.priceEarningsRatio));
    const avgPFCF5 = avg5(last5.map(y => y.priceToFreeCashFlowsRatio));
    const avgPS5   = avg5(last5.map(y => y.priceToSalesRatio));

    const peVs5    = (pe   && avgPE5)   ? ((pe   - avgPE5)   / avgPE5)   * 100 : null;
    const pfcfVs5  = (pfcf && avgPFCF5) ? ((pfcf - avgPFCF5) / avgPFCF5) * 100 : null;
    const psVs5    = (ps   && avgPS5)   ? ((ps   - avgPS5)   / avgPS5)   * 100 : null;
    const RFREE    = 4.5;
    const fcfPrime = pfcf ? ((1 / pfcf) * 100) - RFREE : null;
    const fcfYield = pfcf ? (1 / pfcf) * 100 : null;

    const peLabel   = `Le P/E de ${pe?.toFixed(2) || '?'} est ${peVs5 != null ? (peVs5 < 0 ? 'inf√©rieur' : 'sup√©rieur') : '?'} √† la moyenne sur 5 ans de ${avgPE5?.toFixed(2) || '?'}`;
    const pfcfLabel = `Le P/FCF de ${pfcf?.toFixed(2) || '?'} est ${pfcfVs5 != null ? (pfcfVs5 < 0 ? 'inf√©rieur' : 'sup√©rieur') : '?'} √† la moyenne sur 5 ans de ${avgPFCF5?.toFixed(2) || '?'}`;
    const psLabel   = `Le P/S de ${ps?.toFixed(2) || '?'} est ${psVs5 != null ? (psVs5 < 0 ? 'inf√©rieur' : 'sup√©rieur') : '?'} √† la moyenne sur 5 ans de ${avgPS5?.toFixed(2) || '?'}`;

    const metrics = [
        { label: peLabel,            value: peVs5,    format: 'pct',   score: scoreByThreshold(peVs5,   [-30, -10, 10, 30], false) },
        { label: pfcfLabel,          value: pfcfVs5,  format: 'pct',   score: scoreByThreshold(pfcfVs5, [-30, -10, 10, 30], false) },
        { label: psLabel,            value: psVs5,    format: 'pct',   score: scoreByThreshold(psVs5,   [-30, -10, 10, 30], false) },
        { label: 'Prime de risque FCF', value: fcfPrime, format: 'pct', score: scoreByThreshold(fcfPrime, [-2, 0, 2, 5]) },
        { label: 'Rendement FCF',    value: fcfYield, format: 'pct',   score: scoreByThreshold(fcfYield, [1, 2, 4, 7]) },
    ];

    return buildCategory('√âvaluation', 'üí∞', metrics);
}

function buildCategory(name, icon, metrics) {
    const scores = metrics.filter(m => m.score != null).map(m => m.score);
    const categoryScore = scores.length ? avgArr(scores) : null;
    return { name, icon, score: categoryScore, metrics };
}

function computeAllScores(data) {
    const categories = [
        scoreRentabilite(data),
        scoreGestion(data),
        scoreCroissance(data),
        scoreSanteFinanciere(data),
        scoreAnalyste(data),
        scoreEvaluation(data),
    ];
    const valid = categories.filter(c => c.score != null);
    const globalScore = valid.length ? avgArr(valid.map(c => c.score)) : null;
    return { globalScore, categories };
}

// ‚îÄ‚îÄ Score badge color helper for top badge ‚îÄ‚îÄ
function calculateScore(metrics, ratios) {
    // kept for backward compat ‚Äî now replaced by computeAllScores
    return '‚Äî';
}

// ‚îÄ‚îÄ Pagination state ‚îÄ‚îÄ
const _scorePages = {};
const SCORE_PAGE_SIZE = 5;

function scorePageGo(id, delta) {
    if (!_scorePages[id]) return;
    const state = _scorePages[id];
    const maxPage = Math.ceil(state.metrics.length / SCORE_PAGE_SIZE) - 1;
    state.page = Math.max(0, Math.min(maxPage, state.page + delta));
    _updateScorePage(id);
}

function _updateScorePage(id) {
    const state  = _scorePages[id];
    const start  = state.page * SCORE_PAGE_SIZE;
    const end    = Math.min(start + SCORE_PAGE_SIZE, state.metrics.length);
    const total  = Math.ceil(state.metrics.length / SCORE_PAGE_SIZE);
    const tbody  = document.getElementById('stbody-' + id);
    const lbl    = document.getElementById('spglbl-' + id);
    const cnt    = document.getElementById('spcnt-'  + id);
    if (tbody) tbody.innerHTML = _buildMetricRows(state.metrics, start, SCORE_PAGE_SIZE);
    if (lbl)   lbl.textContent = `Page ${state.page + 1} sur ${total}`;
    if (cnt)   cnt.textContent = `Affichage de ${start + 1} √† ${end} sur ${state.metrics.length}`;
}

function _buildMetricRows(metrics, startIdx, pageSize) {
    return metrics.slice(startIdx, startIdx + pageSize).map(m => {
        const lbl = getScoreLabel(m.score);
        const pill = `<span class="sc-pill" style="background:${lbl.bg};color:${lbl.color};">${lbl.label}</span>`;
        const val  = m.value != null ? (m.format === 'pct' ? m.value.toFixed(2) + '%' : m.value.toFixed(2)) : 'N/A';
        return `<tr class="sc-row"><td class="sc-td-m"><span class="sc-icon">‚ìò</span>${m.label}</td><td class="sc-td-v">${val}</td><td class="sc-td-s">${pill}</td></tr>`;
    }).join('');
}

function _buildCategoryCard(cat) {
    const id  = cat.name.replace(/[^a-z]/gi, '').toLowerCase() + 'card';
    const lbl = getScoreLabel(cat.score);
    const scoreStr = cat.score != null ? cat.score.toFixed(2) : '‚Äî';
    _scorePages[id] = { page: 0, metrics: cat.metrics };

    const totalPages = Math.ceil(cat.metrics.length / SCORE_PAGE_SIZE);
    const showCount  = Math.min(SCORE_PAGE_SIZE, cat.metrics.length);

    return `
    <div class="sc-card">
        <div class="sc-card-header">
            <div>
                <div class="sc-card-title">${cat.icon} ${cat.name}</div>
                <div class="sc-card-sub">Cliquez sur n'importe quelle m√©trique pour une analyse approfondie</div>
            </div>
            <div class="sc-badge" style="background:${lbl.bg};color:${lbl.color};border-color:${lbl.color};">${scoreStr}</div>
        </div>
        <table class="sc-table">
            <thead><tr>
                <th class="sc-th sc-th-m">‚ö° M√©trique</th>
                <th class="sc-th sc-th-v">Valeur</th>
                <th class="sc-th sc-th-s">üöÄ Score de perspicacit√©</th>
            </tr></thead>
            <tbody id="stbody-${id}">${_buildMetricRows(cat.metrics, 0, SCORE_PAGE_SIZE)}</tbody>
        </table>
        <div class="sc-pagination">
            <button class="sc-pg-btn" onclick="scorePageGo('${id}',-1)">‚óÄ Pr√©c√©dent</button>
            <span id="spglbl-${id}" class="sc-pg-lbl">Page 1 sur ${totalPages}</span>
            <button class="sc-pg-btn" onclick="scorePageGo('${id}',1)">Suivant ‚ñ∂</button>
            <span id="spcnt-${id}" class="sc-pg-cnt">Affichage de 1 √† ${showCount} sur ${cat.metrics.length}</span>
        </div>
    </div>`;
}

function _buildDonutSVG(globalScore, categories) {
    const SZ = 170, CX = 85, CY = 85, R = 65;
    const count = categories.length;
    const segDeg = 360 / count;
    const GAP = 3;
    let paths = '';

    function polar(cx, cy, r, deg) {
        const rad = (deg * Math.PI) / 180;
        return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
    }
    function arc(cx, cy, r, s, e) {
        const p1 = polar(cx, cy, r, s), p2 = polar(cx, cy, r, e);
        return `M ${p1.x} ${p1.y} A ${r} ${r} 0 ${(e - s) > 180 ? 1 : 0} 1 ${p2.x} ${p2.y}`;
    }

    categories.forEach((cat, i) => {
        const lbl  = getScoreLabel(cat.score);
        const fill = cat.score != null ? (cat.score - 1) / 4 : 0.08;
        const sA   = i * segDeg - 90 + GAP / 2;
        const eA   = sA + segDeg - GAP;
        const fillEnd = sA + (segDeg - GAP) * fill;
        paths += `<path d="${arc(CX, CY, R, sA, eA)}" fill="none" stroke="var(--border-color)" stroke-width="14" stroke-linecap="butt"/>`;
        if (fill > 0.01) {
            paths += `<path d="${arc(CX, CY, R, sA, fillEnd)}" fill="none" stroke="${lbl.color}" stroke-width="14" stroke-linecap="butt"/>`;
        }
    });

    const gl = getScoreLabel(globalScore);
    const gs = globalScore != null ? globalScore.toFixed(2) : '‚Äî';
    return `<svg width="${SZ}" height="${SZ}" viewBox="0 0 ${SZ} ${SZ}">
        ${paths}
        <text x="${CX}" y="${CY - 10}" text-anchor="middle" style="fill:${gl.color};font-size:26px;font-weight:800;font-family:Inter,sans-serif;">${gs}</text>
        <text x="${CX}" y="${CY + 14}" text-anchor="middle" style="fill:${gl.color};font-size:12px;font-weight:600;font-family:Inter,sans-serif;">${gl.label}</text>
    </svg>`;
}

function renderScoresTab(result) {
    const { globalScore, categories } = result;
    const gl = getScoreLabel(globalScore);

    // Update top score badge color
    const scoreValueEl = document.getElementById('scoreValue');
    if (scoreValueEl) {
        scoreValueEl.textContent = globalScore != null ? `${globalScore.toFixed(2)}/5` : 'N/A';
        scoreValueEl.style.color = gl.color;
    }

    const donut   = _buildDonutSVG(globalScore, categories);
    const breakdown = categories.map(cat => {
        const l = getScoreLabel(cat.score);
        return `<div class="sc-breakdown-item"><span class="sc-dot" style="background:${l.color};"></span>${cat.name} ‚Äî <strong style="color:${l.color}">${cat.score != null ? cat.score.toFixed(2) : 'N/A'}</strong></div>`;
    }).join('');

    const cards = categories.map(_buildCategoryCard).join('');

    document.getElementById('scores-content').innerHTML = `
    <style>
        .sc-global { display:flex; align-items:center; gap:28px; background:var(--bg-topbar); border:1px solid var(--border-color); border-radius:14px; padding:28px 32px; margin-bottom:28px; flex-wrap:wrap; }
        .sc-breakdown { display:flex; flex-wrap:wrap; gap:10px 24px; flex:1; }
        .sc-breakdown-item { display:flex; align-items:center; gap:8px; font-size:0.9rem; font-weight:500; color:var(--text-secondary); }
        .sc-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
        .sc-global-right { text-align:right; }
        .sc-global-num { font-size:3.2rem; font-weight:800; line-height:1; }
        .sc-global-lbl { font-size:1rem; font-weight:600; margin-top:4px; }
        .sc-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
        @media(max-width:860px) { .sc-grid { grid-template-columns:1fr; } .sc-global { flex-direction:column; text-align:center; } }
        .sc-card { background:var(--bg-topbar); border:1px solid var(--border-color); border-radius:14px; padding:24px; }
        .sc-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:18px; gap:16px; }
        .sc-card-title { font-size:1.25rem; font-weight:700; color:var(--text-primary); margin-bottom:4px; }
        .sc-card-sub { font-size:0.78rem; color:var(--text-secondary); }
        .sc-badge { min-width:58px; height:58px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.45rem; font-weight:800; border-width:2px; border-style:solid; flex-shrink:0; }
        .sc-table { width:100%; border-collapse:collapse; }
        .sc-th { font-size:0.8rem; color:var(--text-secondary); font-weight:600; padding:10px 12px; border-bottom:1px solid var(--border-color); text-align:left; white-space:nowrap; }
        .sc-th-v, .sc-th-s { text-align:right; }
        .sc-row { border-bottom:1px solid var(--border-color); transition:background 0.12s; }
        .sc-row:hover { background:var(--hover-bg); cursor:pointer; }
        .sc-row:last-child { border-bottom:none; }
        .sc-td-m { padding:12px; font-size:0.86rem; color:var(--text-primary); display:flex; align-items:flex-start; gap:8px; }
        .sc-td-v { padding:12px; text-align:right; font-weight:600; font-size:0.86rem; white-space:nowrap; }
        .sc-td-s { padding:12px; text-align:right; white-space:nowrap; }
        .sc-icon { color:var(--text-secondary); font-size:0.85rem; flex-shrink:0; margin-top:1px; }
        .sc-pill { display:inline-block; padding:4px 14px; border-radius:6px; font-weight:600; font-size:0.82rem; }
        .sc-pagination { display:flex; align-items:center; gap:12px; padding-top:14px; margin-top:4px; border-top:1px solid var(--border-color); flex-wrap:wrap; }
        .sc-pg-btn { padding:6px 14px; background:var(--hover-bg); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-weight:600; font-size:0.8rem; cursor:pointer; transition:all 0.15s; }
        .sc-pg-btn:hover { background:var(--primary-orange); color:#fff; border-color:var(--primary-orange); }
        .sc-pg-lbl { font-size:0.84rem; font-weight:600; color:var(--text-primary); }
        .sc-pg-cnt { font-size:0.8rem; color:var(--text-secondary); margin-left:auto; }
    </style>

    <div class="sc-global">
        <div>${donut}</div>
        <div class="sc-breakdown">${breakdown}</div>
        <div class="sc-global-right">
            <div class="sc-global-num" style="color:${gl.color};">${globalScore != null ? globalScore.toFixed(2) : '‚Äî'}</div>
            <div class="sc-global-lbl" style="color:${gl.color};">${gl.label}</div>
            <div style="font-size:0.78rem;color:var(--text-secondary);margin-top:6px;">Score global /5</div>
        </div>
    </div>

    <div class="sc-grid">${cards}</div>`;
}



window.scorePageGo = scorePageGo;



    

</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import fmpAPI from './fmp-api.js';

    // ‚îÄ‚îÄ Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    initializeApp({ apiKey:"AIzaSyD4dkPbO1C-bZiSokalUnwNqOTpeAyrOU0", authDomain:"stockmaster-30835.firebaseapp.com", projectId:"stockmaster-30835", storageBucket:"stockmaster-30835.firebasestorage.app", messagingSenderId:"506097874613", appId:"1:506097874613:web:0d15d2bd1575a55c8ab0fc" });
    const auth = getAuth();
    onAuthStateChanged(auth, u => {
        if (!u) window.location.href = 'login.html';
        else document.getElementById('userAvatar').textContent = u.email[0].toUpperCase();
    });

    // ‚îÄ‚îÄ User menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const avatar = document.getElementById('userAvatar');
    const menu   = document.getElementById('dropdownMenu');
    avatar.addEventListener('click', e => { e.stopPropagation(); menu.classList.toggle('active'); });
    document.addEventListener('click', () => menu.classList.remove('active'));
    document.getElementById('signOutBtn').addEventListener('click', async () => { await signOut(auth); window.location.href = 'index.html'; });

    // ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const html = document.documentElement;
    const sun  = document.getElementById('sunIcon');
    const moon = document.getElementById('moonIcon');
    const applyTheme = t => { html.setAttribute('data-theme',t); sun.style.display = t==='dark'?'none':'block'; moon.style.display = t==='dark'?'block':'none'; };
    applyTheme(localStorage.getItem('theme') || 'light');
    document.getElementById('themeToggle').addEventListener('click', () => {
        const t = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        localStorage.setItem('theme', t); applyTheme(t);
    });

    // ‚îÄ‚îÄ Back button ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('backBtn').addEventListener('click', () => {
        if (document.referrer) history.back(); else window.location.href = 'stock-screener.html';
    });

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentPeriod = 'annual';
    let cachedData    = {};

    // ‚îÄ‚îÄ Init: read ?symbol= ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const sym = (new URLSearchParams(window.location.search).get('symbol') || '').toUpperCase().trim();

    if (!sym) {
        document.getElementById('loadingDiv').innerHTML = `
            <div style="text-align:center">
                <div style="font-size:3rem;margin-bottom:16px">üîç</div>
                <p style="font-weight:600;font-size:1.1rem;color:var(--text-primary)">No stock specified.</p>
                <p style="margin-top:10px"><a href="stock-screener.html" style="color:var(--primary-orange)">‚Üê Back to Screener</a></p>
            </div>`;
    } else {
        document.title = sym + ' ‚Äî StockMaster';
        document.getElementById('breadcrumb').textContent = sym;
        loadStock();
    }

    // ‚îÄ‚îÄ Load ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadStock() {
        try {
            const data = await fmpAPI.getFullScreenerData(sym);
            cachedData['annual'] = data;
            renderPage(data);
        } catch(err) {
            console.error(err);
            document.getElementById('loadingDiv').innerHTML = `
                <div style="text-align:center">
                    <div style="font-size:2rem;margin-bottom:12px">‚ö†Ô∏è</div>
                    <p>Could not load <strong>${sym}</strong>.</p>
                    <p style="margin-top:10px"><a href="stock-screener.html" style="color:var(--primary-orange)">‚Üê Back to Screener</a></p>
                </div>`;
        }
    }

    // ‚îÄ‚îÄ Render page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderPage(data) {
        const { profile={}, quote={}, ratios={} } = data;

        const scoreResult = computeAllScores(data);
        const gs = scoreResult.globalScore;
        const gsColor = gs == null ? 'var(--text-secondary)' : gs >= 4 ? '#22c55e' : gs >= 3 ? '#f59e0b' : '#ef4444';

        const change = quote.change || 0;
        const changePct = quote.changesPercentage || 0;
        const changeClass = change >= 0 ? 'positive' : 'negative';
        const changeStr = `${change>=0?'‚Üë':'‚Üì'} $${Math.abs(change).toFixed(2)} (${change>=0?'+':''}${changePct.toFixed(2)}%)`;

        const cap = v => {
            if (!v) return '‚Äî';
            if (v>=1e12) return '$'+(v/1e12).toFixed(2)+'T';
            if (v>=1e9)  return '$'+(v/1e9).toFixed(2)+'B';
            if (v>=1e6)  return '$'+(v/1e6).toFixed(0)+'M';
            return '$'+v;
        };
        const pct = v => v!=null && !isNaN(v) ? (v*100).toFixed(2)+'%' : '‚Äî';
        const num = (v,d=2) => v!=null && !isNaN(v) ? parseFloat(v).toFixed(d) : '‚Äî';

        document.getElementById('pageContent').innerHTML = `
            <div class="stock-header">
                <div class="stock-title-row">
                    <div class="stock-title">
                        <div class="stock-logo">${sym.substring(0,3)}</div>
                        <div class="stock-name">
                            <h1>${profile.companyName || sym}</h1>
                            <p>${sym} ¬∑ ${profile.sector||'‚Äî'} ¬∑ ${profile.exchangeShortName||''}</p>
                        </div>
                    </div>
                    <div class="score-badge">
                        <span class="score-label">Score</span>
                        <span class="score-value" style="color:${gsColor}">${gs!=null ? gs.toFixed(2)+'/5' : 'N/A'}</span>
                    </div>
                </div>
                <div class="stock-price-row">
                    <span class="current-price">${quote.price ? '$'+quote.price.toFixed(2) : '‚Äî'}</span>
                    <span class="price-change ${changeClass}">${changeStr}</span>
                </div>
            </div>

            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="general">General</button>
                <button class="tab-btn" data-tab="scores">Scores</button>
                <button class="tab-btn" data-tab="financials">Financials & KPIs</button>
                <button class="tab-btn" data-tab="dividends">Dividends</button>
            </div>

            <div class="tab-content active" id="tab-general">
                <div class="chart-placeholder">üìà Price Chart (coming soon)</div>
                <h3 style="margin-bottom:20px;font-size:1.2rem;font-weight:700">Key Metrics</h3>
                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-label">Market Cap</div><div class="metric-value">${cap(profile.mktCap)}</div></div>
                    <div class="metric-card"><div class="metric-label">P/E (TTM)</div><div class="metric-value">${num(ratios.peRatioTTM,1)}</div></div>
                    <div class="metric-card"><div class="metric-label">EPS (TTM)</div><div class="metric-value">${quote.eps ? '$'+num(quote.eps) : '‚Äî'}</div></div>
                    <div class="metric-card"><div class="metric-label">Dividend Yield</div><div class="metric-value">${pct(ratios.dividendYieldTTM)}</div></div>
                    <div class="metric-card"><div class="metric-label">Gross Margin</div><div class="metric-value">${pct(ratios.grossProfitMarginTTM)}</div></div>
                    <div class="metric-card"><div class="metric-label">Net Margin</div><div class="metric-value">${pct(ratios.netProfitMarginTTM)}</div></div>
                    <div class="metric-card"><div class="metric-label">ROE</div><div class="metric-value">${pct(ratios.returnOnEquityTTM)}</div></div>
                    <div class="metric-card"><div class="metric-label">Industry</div><div class="metric-value" style="font-size:1rem">${profile.industry||'‚Äî'}</div></div>
                </div>
            </div>

            <div class="tab-content" id="tab-scores">
                <div id="scores-content"></div>
            </div>

            <div class="tab-content" id="tab-financials">
                <div class="fin-toolbar">
                    <div class="fin-tabs">
                        <button class="fin-btn active" data-fin="income">Income</button>
                        <button class="fin-btn" data-fin="balance">Balance Sheet</button>
                        <button class="fin-btn" data-fin="cashflow">Cash Flow</button>
                        <button class="fin-btn" data-fin="ratios">Ratios</button>
                        <button class="fin-btn" data-fin="kpis">KPIs</button>
                    </div>
                    <div class="period-toggle">
                        <button class="period-btn active" data-period="annual">Annual</button>
                        <button class="period-btn" data-period="quarterly">Quarterly</button>
                    </div>
                </div>
                <div id="fin-income" class="fin-panel active"><div class="table-wrap"><table class="data-table" id="tIncome"><thead><tr></tr></thead><tbody></tbody></table></div></div>
                <div id="fin-balance" class="fin-panel"><div class="table-wrap"><table class="data-table" id="tBalance"><thead><tr></tr></thead><tbody></tbody></table></div></div>
                <div id="fin-cashflow" class="fin-panel"><div class="table-wrap"><table class="data-table" id="tCashflow"><thead><tr></tr></thead><tbody></tbody></table></div></div>
                <div id="fin-ratios" class="fin-panel"><div class="table-wrap"><table class="data-table" id="tRatios"><thead><tr></tr></thead><tbody></tbody></table></div></div>
                <div id="fin-kpis" class="fin-panel"><div class="table-wrap"><table class="data-table" id="tKpis"><thead><tr></tr></thead><tbody></tbody></table></div></div>
            </div>

            <div class="tab-content" id="tab-dividends">
                <h3 style="margin-bottom:20px;font-size:1.2rem;font-weight:700">Dividend Information</h3>
                <div class="metrics-grid" style="margin-bottom:28px">
                    <div class="metric-card"><div class="metric-label">Dividend Yield</div><div class="metric-value">${pct(ratios.dividendYieldTTM)}</div></div>
                    <div class="metric-card"><div class="metric-label">Annual Dividend</div><div class="metric-value">${quote.lastAnnualDividend ? '$'+num(quote.lastAnnualDividend) : '‚Äî'}</div></div>
                    <div class="metric-card"><div class="metric-label">Payout Ratio</div><div class="metric-value">${pct(ratios.payoutRatioTTM)}</div></div>
                    <div class="metric-card"><div class="metric-label">Ex-Dividend Date</div><div class="metric-value" style="font-size:1rem">${quote.exDividendDate||'‚Äî'}</div></div>
                </div>
                <div class="table-wrap">
                    <table class="data-table">
                        <thead><tr><th>Ex-Date</th><th>Amount</th><th>Record Date</th><th>Pay Date</th></tr></thead>
                        <tbody id="divTableBody"><tr><td colspan="4" style="text-align:center;color:var(--text-secondary);padding:20px">Loading...</td></tr></tbody>
                    </table>
                </div>
            </div>
        `;

        // Show content
        document.getElementById('loadingDiv').style.display = 'none';
        document.getElementById('pageContent').style.display = 'block';

        // Scores
        renderScoresTab(scoreResult);

        // Financials
        renderTables(data, 'annual');

        // Dividends async
        fmpAPI.getDividendHistory(sym).then(raw => {
            const divs = raw?.historical || [];
            const tbody = document.getElementById('divTableBody');
            if (!tbody) return;
            tbody.innerHTML = !divs.length
                ? '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);padding:24px">No dividends recorded</td></tr>'
                : divs.slice(0,20).map(d => `<tr>
                    <td>${d.date||'‚Äî'}</td>
                    <td>$${(d.dividend||0).toFixed(4)}</td>
                    <td>${d.recordDate||'‚Äî'}</td>
                    <td>${d.paymentDate||'‚Äî'}</td>
                  </tr>`).join('');
        }).catch(() => {});

        // Wire up main tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // Wire up financial sub-tabs
        document.querySelectorAll('.fin-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.fin-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.fin-panel').forEach(p => p.classList.remove('active'));
                document.getElementById('fin-' + btn.dataset.fin).classList.add('active');
            });
        });

        // Wire up period toggle
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriod = btn.dataset.period;
                if (currentPeriod === 'quarterly' && !cachedData['quarterly']) {
                    try { cachedData['quarterly'] = await fmpAPI.getFullScreenerDataQuarterly(sym); }
                    catch(e) { console.error(e); }
                }
                renderTables(cachedData[currentPeriod] || cachedData['annual'], currentPeriod);
            });
        });
    }

    // ‚îÄ‚îÄ Financial table builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderTables(data, period) {
        const inc = data.income    || [];
        const bal = data.balance   || [];
        const cf  = data.cashflow  || [];
        const rat = data.ratiosHistory || [];
        // metrics is a single object in this API, wrap it
        const met = data.metrics ? [data.metrics] : [];

        buildTable('tIncome',   incRows(),   inc, period);
        buildTable('tBalance',  balRows(),   bal, period);
        buildTable('tCashflow', cfRows(),    cf,  period);
        buildTable('tRatios',   ratRows(),   rat, period);
        buildTable('tKpis',     kpiRows(),   met, period);
    }

    function colLabel(item, period) {
        if (!item) return '';
        if (period === 'quarterly') return item.period ? `${item.period} ${item.calendarYear||''}` : (item.date||'').substring(0,7);
        return item.calendarYear || (item.date||'').substring(0,4);
    }

    function buildTable(id, rows, arr, period) {
        const t = document.getElementById(id);
        if (!t) return;
        if (!arr.length) {
            t.querySelector('tbody').innerHTML = '<tr><td colspan="2" style="text-align:center;color:var(--text-secondary);padding:24px">No data</td></tr>';
            return;
        }
        const cols = arr.slice(0,5);
        t.querySelector('thead tr').innerHTML = '<th>Metric</th>' + cols.map(c=>`<th>${colLabel(c,period)}</th>`).join('');
        t.querySelector('tbody').innerHTML = rows.map(r => {
            if (r.sep) return `<tr class="row-sep"><td colspan="${cols.length+1}">${r.label}</td></tr>`;
            const cells = cols.map(col => {
                const v = col[r.key];
                let d = '‚Äî';
                if (v!=null && !isNaN(v)) {
                    if (r.f==='pct') d = (v*100).toFixed(1)+'%';
                    else if (r.f==='big') {
                        const a=Math.abs(v), s=v<0?'-':'';
                        if(a>=1e12) d=s+'$'+(a/1e12).toFixed(2)+'T';
                        else if(a>=1e9) d=s+'$'+(a/1e9).toFixed(1)+'B';
                        else if(a>=1e6) d=s+'$'+(a/1e6).toFixed(0)+'M';
                        else d=s+'$'+a.toFixed(0);
                    }
                    else if (r.f==='x') d = v.toFixed(2)+'x';
                    else d = parseFloat(v).toFixed(2);
                }
                const cls = r.c && v!=null ? (v>=0?'pos':'neg') : '';
                return `<td class="${cls}">${d}</td>`;
            }).join('');
            return `<tr><td>${r.label}</td>${cells}</tr>`;
        }).join('');
    }

    const incRows  = () => [
        {sep:1,label:'Revenue'},
        {key:'revenue',label:'Revenue',f:'big'},
        {key:'grossProfit',label:'Gross Profit',f:'big'},
        {key:'grossProfitRatio',label:'Gross Margin',f:'pct'},
        {sep:1,label:'Expenses'},
        {key:'operatingExpenses',label:'Operating Expenses',f:'big'},
        {key:'researchAndDevelopmentExpenses',label:'R&D',f:'big'},
        {sep:1,label:'Income'},
        {key:'operatingIncome',label:'Operating Income',f:'big'},
        {key:'operatingIncomeRatio',label:'Operating Margin',f:'pct'},
        {key:'ebitda',label:'EBITDA',f:'big'},
        {key:'netIncome',label:'Net Income',f:'big',c:1},
        {key:'netIncomeRatio',label:'Net Margin',f:'pct'},
        {key:'eps',label:'EPS',f:'num'},
        {key:'epsdiluted',label:'EPS Diluted',f:'num'},
    ];
    const balRows  = () => [
        {sep:1,label:'Assets'},
        {key:'cashAndCashEquivalents',label:'Cash & Equivalents',f:'big'},
        {key:'shortTermInvestments',label:'Short-term Investments',f:'big'},
        {key:'netReceivables',label:'Net Receivables',f:'big'},
        {key:'totalCurrentAssets',label:'Total Current Assets',f:'big'},
        {key:'propertyPlantEquipmentNet',label:'PP&E Net',f:'big'},
        {key:'goodwillAndIntangibleAssets',label:'Goodwill & Intangibles',f:'big'},
        {key:'totalAssets',label:'Total Assets',f:'big'},
        {sep:1,label:'Liabilities'},
        {key:'totalCurrentLiabilities',label:'Total Current Liabilities',f:'big'},
        {key:'longTermDebt',label:'Long-term Debt',f:'big'},
        {key:'totalDebt',label:'Total Debt',f:'big'},
        {key:'totalLiabilities',label:'Total Liabilities',f:'big'},
        {sep:1,label:'Equity'},
        {key:'totalEquity',label:'Total Equity',f:'big',c:1},
        {key:'retainedEarnings',label:'Retained Earnings',f:'big'},
    ];
    const cfRows   = () => [
        {sep:1,label:'Operating'},
        {key:'operatingCashFlow',label:'Operating Cash Flow',f:'big'},
        {key:'stockBasedCompensation',label:'Stock-based Comp.',f:'big'},
        {key:'changeInWorkingCapital',label:'Working Capital Change',f:'big',c:1},
        {sep:1,label:'Investing'},
        {key:'capitalExpenditure',label:'CapEx',f:'big'},
        {key:'acquisitionsNet',label:'Acquisitions',f:'big'},
        {sep:1,label:'Free Cash Flow'},
        {key:'freeCashFlow',label:'Free Cash Flow',f:'big',c:1},
        {key:'dividendsPaid',label:'Dividends Paid',f:'big'},
        {key:'commonStockRepurchased',label:'Buybacks',f:'big'},
    ];
    const ratRows  = () => [
        {sep:1,label:'Valuation'},
        {key:'priceEarningsRatioTTM',label:'P/E',f:'x'},
        {key:'priceToBookRatioTTM',label:'P/B',f:'x'},
        {key:'priceToSalesRatioTTM',label:'P/S',f:'x'},
        {key:'priceToFreeCashFlowsRatioTTM',label:'P/FCF',f:'x'},
        {key:'enterpriseValueMultipleTTM',label:'EV/EBITDA',f:'x'},
        {sep:1,label:'Profitability'},
        {key:'returnOnEquityTTM',label:'ROE',f:'pct'},
        {key:'returnOnAssetsTTM',label:'ROA',f:'pct'},
        {key:'roicTTM',label:'ROIC',f:'pct'},
        {sep:1,label:'Debt & Liquidity'},
        {key:'debtEquityRatioTTM',label:'Debt / Equity',f:'x'},
        {key:'currentRatioTTM',label:'Current Ratio',f:'x'},
        {key:'interestCoverageTTM',label:'Interest Coverage',f:'x'},
        {sep:1,label:'Dividends'},
        {key:'dividendYieldTTM',label:'Dividend Yield',f:'pct'},
        {key:'payoutRatioTTM',label:'Payout Ratio',f:'pct'},
    ];
    const kpiRows  = () => [
        {sep:1,label:'Per Share'},
        {key:'revenuePerShareTTM',label:'Revenue / Share'},
        {key:'netIncomePerShareTTM',label:'Net Income / Share'},
        {key:'freeCashFlowPerShareTTM',label:'FCF / Share'},
        {key:'bookValuePerShareTTM',label:'Book Value / Share'},
        {sep:1,label:'Efficiency'},
        {key:'assetTurnoverTTM',label:'Asset Turnover',f:'x'},
        {key:'inventoryTurnoverTTM',label:'Inventory Turnover',f:'x'},
        {sep:1,label:'Growth'},
        {key:'revenueGrowthTTM',label:'Revenue Growth',f:'pct',c:1},
        {key:'epsgrowthTTM',label:'EPS Growth',f:'pct',c:1},
        {key:'freeCashFlowGrowthTTM',label:'FCF Growth',f:'pct',c:1},
    ];

</script>
</body>
</html>
