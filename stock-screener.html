<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Screener - StockMaster</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-orange: #FF7A00;
            --bg-main: #F9FAFB;
            --bg-topbar: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --hover-bg: #F3F4F6;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --success-color: #10B981;
            --danger-color: #EF4444;
        }
        [data-theme="dark"] {
            --bg-main: #0F172A;
            --bg-topbar: #1E293B;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border-color: #334155;
            --hover-bg: #334155;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background-color 0.3s ease;
        }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* TOPBAR */
        .topbar {
            background-color: var(--bg-topbar);
            border-bottom: 1px solid var(--border-color);
            padding: 0 30px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .topbar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--text-primary);
            text-decoration: none;
        }
        .topbar-logo img { height: 45px; width: auto; }
        .topbar-nav { display: flex; gap: 10px; flex: 1; justify-content: center; }
        .nav-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid var(--border-color);
            background: var(--bg-topbar);
            color: var(--text-secondary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .nav-btn:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
            transform: translateY(-2px);
        }
        .nav-btn.active {
            background-color: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }
        .nav-btn svg { width: 18px; height: 18px; }
        .topbar-actions { display: flex; align-items: center; gap: 15px; }
        .theme-toggle {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle svg { width: 20px; height: 20px; color: var(--text-primary); }
        .user-menu { position: relative; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), #ff9f40);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: pointer;
        }
        .dropdown-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            z-index: 1000;
        }
        .dropdown-menu.active { opacity: 1; visibility: visible; }
        .dropdown-item {
            padding: 14px 20px;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dropdown-item:hover { background-color: var(--hover-bg); }
        .dropdown-item:last-child { color: #ef4444; border-top: 1px solid var(--border-color); }
        .dropdown-item svg { width: 18px; height: 18px; }
        
        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* SEARCH SECTION */
        .search-section {
            max-width: 1000px;
            margin: 0 auto;
            text-align: center;
            padding: 60px 20px 40px;
        }
        .search-icon-header {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, var(--primary-orange), #ff9f40);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 15px 40px rgba(255, 122, 0, 0.25);
        }
        .search-icon-header svg { width: 60px; height: 60px; color: white; }
        .search-section h2 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-orange) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .search-section p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 40px;
            line-height: 1.6;
        }
        
        /* SEARCH BAR */
        .search-container {
            max-width: 700px;
            margin: 0 auto 50px;
        }
        .search-wrapper { position: relative; }
        .search-input {
            width: 100%;
            padding: 18px 60px 18px 60px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            font-size: 1.1rem;
            background-color: var(--bg-topbar);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 4px rgba(255, 122, 0, 0.1);
            transform: translateY(-2px);
        }
        .search-icon {
            position: absolute;
            left: 22px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        .search-icon svg { width: 24px; height: 24px; }
        .search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .search-results.active { display: block; }
        .search-result-item {
            padding: 14px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-result-item:hover { background-color: var(--hover-bg); }
        .result-symbol {
            font-weight: 700;
            color: var(--text-primary);
            margin-right: 12px;
        }
        .result-name {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* FILTER PRESETS */
        .filter-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }
        .preset-card {
            background: var(--bg-topbar);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        .preset-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-orange);
            box-shadow: var(--shadow-lg);
        }
        .preset-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(255, 122, 0, 0.1), rgba(255, 122, 0, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .preset-icon svg { width: 26px; height: 26px; color: var(--primary-orange); }
        .preset-card h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        .preset-card p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .preset-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .tag {
            padding: 4px 12px;
            background: var(--hover-bg);
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* STOCK DETAILS PAGE */
        .stock-details {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }
        .stock-details.active { display: block; }
        
        .stock-header {
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        .stock-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .stock-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .stock-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-orange), #ff9f40);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.5rem;
        }
        .stock-name h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .stock-name p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        .back-btn {
            padding: 12px 24px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        .back-btn:hover {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }
        .stock-price-row {
            display: flex;
            gap: 40px;
            align-items: baseline;
        }
        .current-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        .price-change {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .price-change.positive { color: var(--success-color); }
        .price-change.negative { color: var(--danger-color); }
        .score-badge {
            margin-left: auto;
            text-align: right;
        }
        .score-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .score-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-orange), #ff9f40);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* TABS */
        .tabs-container {
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 0;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            background: var(--bg-topbar);
        }
        .tab-btn {
            flex: 1;
            padding: 18px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        .tab-btn.active {
            color: var(--primary-orange);
            border-bottom-color: var(--primary-orange);
            background: var(--hover-bg);
        }
        .tab-content {
            padding: 30px;
            display: none;
        }
        .tab-content.active { display: block; }
        
        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* FINANCIALS SUB-TABS */
        .financials-sub-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .financials-sub-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 4px;
        }
        .fin-sub-btn {
            padding: 8px 18px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }
        .fin-sub-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        .fin-sub-btn.active {
            background: var(--primary-orange);
            color: white;
        }

        /* PERIOD TOGGLE (Annual / Quarterly) */
        .period-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 4px;
        }
        .period-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }
        .period-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        .period-btn.active {
            background: var(--bg-topbar);
            color: var(--primary-orange);
            border: 1px solid var(--primary-orange);
        }

        /* TABLE */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-main);
            border-radius: 12px;
            overflow: hidden;
            font-size: 0.9rem;
        }
        .data-table th {
            background: var(--hover-bg);
            padding: 12px 14px;
            text-align: right;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }
        .data-table th:first-child {
            text-align: left;
            min-width: 260px;
        }
        .data-table td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.88rem;
            text-align: right;
            white-space: nowrap;
        }
        .data-table td:first-child {
            text-align: left;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover {
            background: var(--hover-bg);
        }
        .data-table .row-bold td { font-weight: 700; background: rgba(0,0,0,0.02); }
        .data-table .row-indent td:first-child { padding-left: 28px; color: var(--text-secondary); }
        .data-table .row-section td { 
            background: var(--hover-bg); 
            font-weight: 700; 
            font-size: 0.85rem; 
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 8px 14px;
        }
        .positive { color: var(--success-color) !important; }
        .negative { color: var(--danger-color) !important; }
        
        /* TABLE WRAPPER */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        /* CHART PLACEHOLDER */
        .chart-container {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        /* RESPONSIVE */
        @media (max-width: 968px) {
            .topbar-nav { display: none; }
            .search-section h2 { font-size: 2rem; }
            .stock-price-row { flex-direction: column; gap: 15px; }
            .current-price { font-size: 2.2rem; }
            .tabs-nav { overflow-x: auto; }
            .tab-btn { white-space: nowrap; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="topbar">
            <a href="webapp.html" class="topbar-logo">
                <img src="logo.png" alt="Logo">
                StockMaster
            </a>
            <nav class="topbar-nav">
                <a href="webapp.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Home
                </a>
                <a href="stock-screener.html" class="nav-btn active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Stock Screener
                </a>
                <a href="valorisation-analysis.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Valorisation Analysis
                </a>
                <a href="dcf-calculator.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    DCF Calculator
                </a>
            </nav>
            <div class="topbar-actions">
                <button class="theme-toggle" id="themeToggle">
                    <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="moonIcon" style="display:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="settings.html" class="dropdown-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Settings
                        </a>
                        <a href="billings-plans.html" class="dropdown-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                            </svg>
                            Billings & Plans
                        </a>
                        <div class="dropdown-item" id="signOutBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Sign Out
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="search-section" id="searchView">
                <div class="search-icon-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <h2>Screener d'Actions Professionnel</h2>
                <p>Recherchez et analysez des milliers d'actions. Acc√©dez aux donn√©es financi√®res d√©taill√©es, scores et m√©triques cl√©s.</p>

                <div class="search-container">
                    <div class="search-wrapper">
                        <div class="search-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input 
                            type="text" 
                            class="search-input" 
                            id="stockSearch" 
                            placeholder="Recherchez une action √† analyser (ex: AAPL, MSFT, AJG...)"
                        >
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>

                <div class="filter-presets">
                    <div class="preset-card" data-preset="value">
                        <div class="preset-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <h3>üíé Value Stocks</h3>
                        <p>Actions sous-√©valu√©es avec fort potentiel de rebond. Id√©al pour l'investissement long terme.</p>
                        <div class="preset-tags">
                            <span class="tag">P/E < 15</span>
                            <span class="tag">P/B < 2</span>
                            <span class="tag">Div > 3%</span>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="growth">
                        <div class="preset-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                        <h3>üöÄ Growth Stocks</h3>
                        <p>Entreprises √† forte croissance avec momentum haussier. Pour les investisseurs agressifs.</p>
                        <div class="preset-tags">
                            <span class="tag">Rev +20%</span>
                            <span class="tag">EPS +25%</span>
                            <span class="tag">ROE > 15%</span>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="dividend">
                        <div class="preset-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                        </div>
                        <h3>üí∞ Dividend Kings</h3>
                        <p>Actions √† dividendes √©lev√©s et stables. Parfait pour g√©n√©rer des revenus passifs.</p>
                        <div class="preset-tags">
                            <span class="tag">Div > 4%</span>
                            <span class="tag">Payout < 60%</span>
                            <span class="tag">5y+ hist</span>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="quality">
                        <div class="preset-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                            </svg>
                        </div>
                        <h3>‚≠ê Quality Stocks</h3>
                        <p>Entreprises de qualit√© avec bilan solide et marges √©lev√©es. Le meilleur des deux mondes.</p>
                        <div class="preset-tags">
                            <span class="tag">ROE > 20%</span>
                            <span class="tag">D/E < 0.5</span>
                            <span class="tag">Margin > 15%</span>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="momentum">
                        <div class="preset-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <h3>‚ö° Momentum Play</h3>
                        <p>Actions avec forte dynamique technique. Pour le trading court/moyen terme.</p>
                        <div class="preset-tags">
                            <span class="tag">RSI 50-70</span>
                            <span class="tag">+SMA 50</span>
                            <span class="tag">Vol +20%</span>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="smallcap">
                        <div class="preset-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                        </div>
                        <h3>üåü Small Cap Gems</h3>
                        <p>Petites capitalisations avec fort potentiel. Risque √©lev√©, r√©compense √©lev√©e.</p>
                        <div class="preset-tags">
                            <span class="tag">Cap < 2B</span>
                            <span class="tag">Rev +30%</span>
                            <span class="tag">Volume OK</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="stock-details" id="stockDetailsView">
                <div class="stock-header">
                    <div class="stock-title-row">
                        <div class="stock-title">
                            <div class="stock-logo" id="stockLogo">AJG</div>
                            <div class="stock-name">
                                <h1 id="stockFullName">Arthur J. Gallagher & Co.</h1>
                                <p id="stockSymbol">AJG - Insurance</p>
                            </div>
                        </div>
                        <button class="back-btn" id="backBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:18px;height:18px">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Retour
                        </button>
                    </div>
                    <div class="stock-price-row">
                        <div class="current-price" id="currentPrice">$242.75</div>
                        <div class="price-change negative" id="priceChange">‚Üì $6.80 (-2.73%)</div>
                        <div class="score-badge">
                            <div class="score-label">Score</div>
                            <div class="score-value" id="scoreValue">3.24/5</div>
                        </div>
                    </div>
                </div>

                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-btn active" data-tab="general">General</button>
                        <button class="tab-btn" data-tab="scores">Scores</button>
                        <button class="tab-btn" data-tab="financials">Financials & KPIs</button>
                        <button class="tab-btn" data-tab="dividends">Dividends</button>
                    </div>

                    <!-- GENERAL TAB -->
                    <div class="tab-content active" id="general-tab">
                        <div class="chart-container">
                            <p>üìà Graphique du cours de l'action (int√©gration √† venir)</p>
                        </div>
                        
                        <h3 style="margin-bottom: 20px; font-size: 1.5rem;">M√©triques Cl√©s</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Market Cap</div>
                                <div class="metric-value">$62.34B</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">P/E (TTM)</div>
                                <div class="metric-value">41.73</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Dividend Yield</div>
                                <div class="metric-value">1.15%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">EPS (TTM)</div>
                                <div class="metric-value">$5.75</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Industry</div>
                                <div class="metric-value" style="font-size: 1.3rem;">Insurance</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Diluted Shares</div>
                                <div class="metric-value" style="font-size: 1.3rem;">260.26M</div>
                            </div>
                        </div>
                    </div>

                    <!-- SCORES TAB -->
                    <div class="tab-content" id="scores-tab">
                        <h3 style="margin-bottom: 20px; font-size: 1.5rem;">Analyse des Scores</h3>
                        <div class="chart-container">
                            <p>üìä Visualisation des scores par cat√©gorie (int√©gration √† venir)</p>
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Score Global</div>
                                <div class="metric-value" style="color: var(--primary-orange);">3.24/5</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Profitability Score</div>
                                <div class="metric-value">4.2/5</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Growth Score</div>
                                <div class="metric-value">3.8/5</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Valuation Score</div>
                                <div class="metric-value">2.5/5</div>
                            </div>
                        </div>
                    </div>

                    <!-- FINANCIALS & KPIs TAB -->
                    <div class="tab-content" id="financials-tab">
                        <!-- Sub-nav: Income / Balance / Cash Flow / Ratios / KPIs + Annual/Quarterly -->
                        <div class="financials-sub-nav">
                            <div class="financials-sub-tabs">
                                <button class="fin-sub-btn active" data-fin="income">Income Statement</button>
                                <button class="fin-sub-btn" data-fin="balance">Balance Sheet</button>
                                <button class="fin-sub-btn" data-fin="cashflow">Cash Flow</button>
                                <button class="fin-sub-btn" data-fin="ratios">Ratios</button>
                                <button class="fin-sub-btn" data-fin="kpis">KPIs</button>
                            </div>
                            <div class="period-toggle">
                                <button class="period-btn active" data-period="annual">Annual</button>
                                <button class="period-btn" data-period="quarterly">Quarterly</button>
                            </div>
                        </div>

                        <!-- Income Statement -->
                        <div class="fin-content active" id="fin-income">
                            <div class="table-wrapper">
                                <table class="data-table" id="incomeTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Balance Sheet -->
                        <div class="fin-content" id="fin-balance" style="display:none;">
                            <div class="table-wrapper">
                                <table class="data-table" id="balanceTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Cash Flow -->
                        <div class="fin-content" id="fin-cashflow" style="display:none;">
                            <div class="table-wrapper">
                                <table class="data-table" id="cashflowTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Ratios -->
                        <div class="fin-content" id="fin-ratios" style="display:none;">
                            <div class="table-wrapper">
                                <table class="data-table" id="ratiosTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- KPIs -->
                        <div class="fin-content" id="fin-kpis" style="display:none;">
                            <div class="table-wrapper">
                                <table class="data-table" id="kpisTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- DIVIDENDS TAB -->
                    <div class="tab-content" id="dividends-tab">
                        <h3 style="margin-bottom: 20px; font-size: 1.5rem;">Informations sur les Dividendes</h3>
                        <div class="metrics-grid" style="margin-bottom: 30px;">
                            <div class="metric-card">
                                <div class="metric-label">Dividend Yield</div>
                                <div class="metric-value">1.15%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Annual Dividend</div>
                                <div class="metric-value">$2.80</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Payout Ratio</div>
                                <div class="metric-value">46.17%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Dividend Growth</div>
                                <div class="metric-value" style="color: var(--success-color);">8.16%</div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 20px; font-size: 1.3rem;">Historique des Dividendes</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ex-Dividend Date</th>
                                    <th>Cash Amount</th>
                                    <th>Record Date</th>
                                    <th>Pay Date</th>
                                </tr>
                            </thead>
                            <tbody id="dividendsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import fmpAPI from './fmp-api.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD4dkPbO1C-bZiSokalUnwNqOTpeAyrOU0",
            authDomain: "stockmaster-30835.firebaseapp.com",
            projectId: "stockmaster-30835",
            storageBucket: "stockmaster-30835.firebasestorage.app",
            messagingSenderId: "506097874613",
            appId: "1:506097874613:web:0d15d2bd1575a55c8ab0fc",
            measurementId: "G-2PG7Q471TR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                document.querySelector('.user-avatar').textContent = user.email.charAt(0).toUpperCase();
            }
        });

        // User menu
        const userAvatar = document.getElementById('userAvatar');
        const dropdownMenu = document.getElementById('dropdownMenu');
        userAvatar.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            if (!userAvatar.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.remove('active');
            }
        });

        document.getElementById('signOutBtn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = "index.html";
        });

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const html = document.documentElement;
        const currentTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', currentTheme);
        if (currentTheme === 'dark') {
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
        }
        themeToggle.addEventListener('click', () => {
            const newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (newTheme === 'dark') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        });

        // ============================================================
        // STATE
        // ============================================================
        let currentSymbol = null;
        let currentPeriod = 'annual'; // annual | quarterly | ttm
        let currentFinTab = 'income';
        let cachedData = {}; // { annual: {...}, quarterly: {...} }

        // ============================================================
        // SEARCH
        // ============================================================
        const stockSearch = document.getElementById('stockSearch');
        const searchResults = document.getElementById('searchResults');
        const searchView = document.getElementById('searchView');
        const stockDetailsView = document.getElementById('stockDetailsView');
        const backBtn = document.getElementById('backBtn');
        let searchTimeout;

        stockSearch.addEventListener('input', async (e) => {
            const query = e.target.value.trim().toUpperCase();
            if (query.length < 1) { searchResults.classList.remove('active'); return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    searchResults.innerHTML = '<div class="search-result-item"><span class="result-symbol">Recherche...</span></div>';
                    searchResults.classList.add('active');
                    const results = await fmpAPI.searchStocks(query);
                    if (results && results.length > 0) {
                        const stocks = results.filter(r => {
                            const exch = (r.exchangeShortName || r.exchange || '').toUpperCase();
                            return exch.includes('NASDAQ') || exch.includes('NYSE') || exch.includes('AMEX');
                        }).slice(0, 8);
                        if (stocks.length > 0) {
                            const symbols = stocks.map(s => s.symbol).join(',');
                            const quotes = await fmpAPI.getQuote(symbols);
                            const quotesMap = {};
                            if (quotes) quotes.forEach(q => quotesMap[q.symbol] = q);
                            searchResults.innerHTML = stocks.map(stock => {
                                const quote = quotesMap[stock.symbol];
                                const price = quote?.price || 'N/A';
                                const priceDisplay = typeof price === 'number' ? `$${price.toFixed(2)}` : price;
                                return `<div class="search-result-item" data-symbol="${stock.symbol}">
                                    <div><span class="result-symbol">${stock.symbol}</span><span class="result-name">${stock.name || stock.companyName || ''}</span></div>
                                    <span style="font-weight:700;">${priceDisplay}</span>
                                </div>`;
                            }).join('');
                            searchResults.classList.add('active');
                            document.querySelectorAll('.search-result-item').forEach(item => {
                                item.addEventListener('click', async () => {
                                    const symbol = item.dataset.symbol;
                                    await showStockDetails(symbol);
                                    searchResults.classList.remove('active');
                                    stockSearch.value = '';
                                });
                            });
                        } else {
                            searchResults.innerHTML = '<div class="search-result-item">Aucune action trouv√©e</div>';
                        }
                    } else {
                        searchResults.innerHTML = '<div class="search-result-item">Aucun r√©sultat</div>';
                    }
                } catch (error) {
                    searchResults.innerHTML = '<div class="search-result-item">Erreur de recherche</div>';
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!stockSearch.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // ============================================================
        // SHOW STOCK DETAILS
        // ============================================================
        async function showStockDetails(symbol) {
            try {
                currentSymbol = symbol;
                cachedData = {};
                searchView.style.display = 'none';
                stockDetailsView.classList.add('active');
                document.getElementById('stockLogo').textContent = symbol.substring(0, 3);
                document.getElementById('stockFullName').textContent = 'Chargement...';

                // Single batch call ‚Äî fetches everything needed (quote, ratios, metrics, income, balance, cashflow, ratiosHistory)
                const data = await fmpAPI.getFullScreenerData(symbol);
                cachedData['annual'] = data;

                if (data.profile) {
                    document.getElementById('stockLogo').textContent = data.profile.symbol.substring(0, 3);
                    document.getElementById('stockFullName').textContent = data.profile.companyName || symbol;
                    document.getElementById('stockSymbol').textContent = `${data.profile.symbol} - ${data.profile.sector || 'N/A'}`;
                }
                if (data.quote) {
                    document.getElementById('currentPrice').textContent = `$${data.quote.price.toFixed(2)}`;
                    const change = data.quote.change || 0;
                    const changePercent = data.quote.changesPercentage || 0;
                    const priceChangeEl = document.getElementById('priceChange');
                    if (change >= 0) {
                        priceChangeEl.className = 'price-change positive';
                        priceChangeEl.textContent = `‚Üë $${Math.abs(change).toFixed(2)} (+${Math.abs(changePercent).toFixed(2)}%)`;
                    } else {
                        priceChangeEl.className = 'price-change negative';
                        priceChangeEl.textContent = `‚Üì $${Math.abs(change).toFixed(2)} (-${Math.abs(changePercent).toFixed(2)}%)`;
                    }
                }
                if (data.metrics) {
                    const score = calculateScore(data.metrics, data.ratios);
                    document.getElementById('scoreValue').textContent = `${score}/5`;
                }

                updateGeneralTab(data);
                renderAllFinancialTables(data, 'annual');
                updateDividendsTab(data);

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading stock details:', error);
                alert('Erreur lors du chargement des donn√©es.');
                backBtn.click();
            }
        }

        // ============================================================
        // PERIOD TOGGLE LOGIC
        // ============================================================
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const period = btn.dataset.period;
                if (period === currentPeriod) return;
                currentPeriod = period;

                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (!currentSymbol) return;

                if (!cachedData[period]) {
                    // Show loading state on current visible table
                    const activeTable = document.querySelector(`#fin-${currentFinTab} tbody`);
                    if (activeTable) activeTable.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-secondary);">‚è≥ Chargement...</td></tr>';

                    try {
                        // One single batch call ‚Äî all quarterly data at once
                        cachedData[period] = await fmpAPI.getFullScreenerDataQuarterly(currentSymbol);
                    } catch(e) {
                        console.error('Error fetching quarterly data:', e);
                        if (activeTable) activeTable.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--danger-color);">Erreur de chargement</td></tr>';
                        return;
                    }
                }

                renderAllFinancialTables(cachedData[period], period);
            });
        });

        // ============================================================
        // FINANCIALS SUB-TABS
        // ============================================================
        document.querySelectorAll('.fin-sub-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const fin = btn.dataset.fin;
                currentFinTab = fin;

                document.querySelectorAll('.fin-sub-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.querySelectorAll('.fin-content').forEach(c => c.style.display = 'none');
                document.getElementById(`fin-${fin}`).style.display = 'block';
            });
        });

        // ============================================================
        // RENDER ALL FINANCIAL TABLES
        // ============================================================
        function renderAllFinancialTables(data, period) {
            renderIncomeTable(data, period);
            renderBalanceTable(data, period);
            renderCashflowTable(data, period);
            renderRatiosTable(data, period);
            renderKPIsTable(data, period);
        }

        function periodLabel(item, period) {
            if (!item?.date) return 'N/A';
            const d = new Date(item.date);
            if (period === 'quarterly') {
                const q = Math.floor(d.getMonth() / 3) + 1;
                return `Q${q} ${d.getFullYear()}`;
            }
            return 'FY ' + d.getFullYear();
        }

        // ============================================================
        // INCOME STATEMENT
        // ============================================================
        function renderIncomeTable(data, period) {
            if (!data.income || data.income.length === 0) {
                document.querySelector('#incomeTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-secondary);">Donn√©es non disponibles</td></tr>';
                return;
            }
            const limit = period === 'quarterly' ? 8 : 5;
            const years = data.income.slice(0, limit);
            const thead = document.querySelector('#incomeTable thead tr');
            const tbody = document.querySelector('#incomeTable tbody');
            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;

            const rows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: 'Revenue', key: 'revenue', bold: true },
                { label: 'Revenue Growth (YoY)', key: '_revGrowth', isGrowth: true, indent: true },
                { label: 'Cost of Revenue', key: 'costOfRevenue' },
                { label: 'Gross Profit', key: 'grossProfit', bold: true },
                { label: 'Selling, General & Admin', key: 'sellingGeneralAndAdministrativeExpenses', indent: true },
                { label: 'Research & Development', key: 'researchAndDevelopmentExpenses', indent: true },
                { label: 'Other Operating Expenses', key: 'otherExpenses', indent: true },
                { label: 'Operating Expenses', key: 'operatingExpenses', bold: true },
                { label: 'Operating Income', key: 'operatingIncome', bold: true },
                { label: 'Interest Expense', key: 'interestExpense' },
                { label: 'Interest & Investment Income', key: 'interestIncome' },
                { label: 'Currency Exchange Gain (Loss)', key: 'otherNonOperatingIncome' },
                { label: 'EBT Excluding Unusual Items', key: 'incomeBeforeTax', bold: true },
                { label: 'Pretax Income', key: 'incomeBeforeTax', bold: true },
                { label: 'Income Tax Expense', key: 'incomeTaxExpense' },
                { label: 'Net Income', key: 'netIncome', bold: true },
                { label: 'Net Income Growth', key: '_netIncGrowth', isGrowth: true, indent: true },
                { label: 'Shares Outstanding (Basic)', key: 'weightedAverageSharesOut' },
                { label: 'Shares Outstanding (Diluted)', key: 'weightedAverageSharesOutDil', bold: true },
                { label: 'Shares Change (YoY)', key: '_sharesGrowth', isGrowth: true, indent: true },
                { label: 'EPS (Basic)', key: 'eps' },
                { label: 'EPS (Diluted)', key: 'epsdiluted', bold: true },
                { label: 'EPS Growth', key: '_epsGrowth', isGrowth: true, indent: true },
                { label: 'Free Cash Flow', key: '_fcf' },
                { label: 'Free Cash Flow Per Share', key: '_fcfPerShare' },
                { label: 'Gross Margin', key: '_grossMargin', isPercent: true },
                { label: 'Operating Margin', key: '_opMargin', isPercent: true },
                { label: 'Profit Margin', key: '_netMargin', isPercent: true },
                { label: 'EBITDA', key: 'ebitda', bold: true },
                { label: 'EBITDA Margin', key: '_ebitdaMargin', isPercent: true, indent: true },
                { label: 'D&A For EBITDA', key: 'depreciationAndAmortization', indent: true },
                { label: 'EBIT', key: 'operatingIncome', bold: true },
                { label: 'Effective Tax Rate', key: '_taxRate', isPercent: true },
            ];

            tbody.innerHTML = buildTableRows(rows, years, data.cashflow);
        }

        // ============================================================
        // BALANCE SHEET
        // ============================================================
        function renderBalanceTable(data, period) {
            if (!data.balance || data.balance.length === 0) {
                document.querySelector('#balanceTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-secondary);">Donn√©es non disponibles</td></tr>';
                return;
            }
            const limit = period === 'quarterly' ? 8 : 5;
            const years = data.balance.slice(0, limit);
            const thead = document.querySelector('#balanceTable thead tr');
            const tbody = document.querySelector('#balanceTable tbody');
            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;

            const rows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: '‚Äî ASSETS ‚Äî', isSection: true },
                { label: 'Cash & Equivalents', key: 'cashAndCashEquivalents' },
                { label: 'Short-Term Investments', key: 'shortTermInvestments' },
                { label: 'Cash & Short-Term Investments', key: 'cashAndShortTermInvestments', bold: true },
                { label: 'Cash Growth', key: '_cashGrowth', isGrowth: true, indent: true },
                { label: 'Accounts Receivable', key: 'netReceivables' },
                { label: 'Receivables', key: 'netReceivables', bold: true },
                { label: 'Inventory', key: 'inventory' },
                { label: 'Prepaid Expenses', key: 'otherCurrentAssets' },
                { label: 'Total Current Assets', key: 'totalCurrentAssets', bold: true },
                { label: 'Property, Plant & Equipment', key: 'propertyPlantEquipmentNet' },
                { label: 'Long-Term Investments', key: 'longTermInvestments' },
                { label: 'Goodwill', key: 'goodwill' },
                { label: 'Other Intangible Assets', key: 'intangibleAssets' },
                { label: 'Other Long-Term Assets', key: 'otherNonCurrentAssets' },
                { label: 'Total Assets', key: 'totalAssets', bold: true },
                { label: '‚Äî LIABILITIES ‚Äî', isSection: true },
                { label: 'Accounts Payable', key: 'accountPayables' },
                { label: 'Accrued Expenses', key: 'otherCurrentLiabilities' },
                { label: 'Short-Term Debt', key: 'shortTermDebt' },
                { label: 'Current Portion of Long-Term Debt', key: 'shortTermDebt' },
                { label: 'Total Current Liabilities', key: 'totalCurrentLiabilities', bold: true },
                { label: 'Long-Term Debt', key: 'longTermDebt' },
                { label: 'Other Long-Term Liabilities', key: 'otherNonCurrentLiabilities' },
                { label: 'Total Liabilities', key: 'totalLiabilities', bold: true },
                { label: '‚Äî EQUITY ‚Äî', isSection: true },
                { label: 'Additional Paid-In Capital', key: 'additionalPaidInCapital' },
                { label: 'Retained Earnings', key: 'retainedEarnings' },
                { label: 'Treasury Stock', key: 'treasuryStock' },
                { label: 'Total Common Equity', key: 'totalStockholdersEquity', bold: true },
                { label: "Shareholders' Equity", key: 'totalStockholdersEquity', bold: true },
                { label: 'Total Liabilities & Equity', key: 'totalLiabilitiesAndStockholdersEquity' },
                { label: 'Total Debt', key: 'totalDebt' },
                { label: 'Net Cash (Debt)', key: '_netCash', bold: true },
                { label: 'Net Cash Per Share', key: '_netCashPerShare' },
                { label: 'Filing Date Shares Outstanding', key: '_shares' },
                { label: 'Total Common Shares Outstanding', key: '_shares', bold: true },
                { label: 'Working Capital', key: '_workingCapital' },
                { label: 'Book Value Per Share', key: '_bookValuePS' },
                { label: 'Tangible Book Value', key: '_tangibleBV' },
                { label: 'Tangible Book Value Per Share', key: '_tangibleBVPS' },
            ];

            tbody.innerHTML = buildTableRows(rows, years, null);
        }

        // ============================================================
        // CASH FLOW
        // ============================================================
        function renderCashflowTable(data, period) {
            if (!data.cashflow || data.cashflow.length === 0) {
                document.querySelector('#cashflowTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-secondary);">Donn√©es non disponibles</td></tr>';
                return;
            }
            const limit = period === 'quarterly' ? 8 : 5;
            const years = data.cashflow.slice(0, limit);
            const thead = document.querySelector('#cashflowTable thead tr');
            const tbody = document.querySelector('#cashflowTable tbody');
            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;

            const rows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: '‚Äî OPERATING ACTIVITIES ‚Äî', isSection: true },
                { label: 'Net Income', key: 'netIncome' },
                { label: 'Depreciation & Amortization', key: 'depreciationAndAmortization' },
                { label: 'Loss (Gain) on Equity Investments', key: 'deferredIncomeTax' },
                { label: 'Stock-Based Compensation', key: 'stockBasedCompensation' },
                { label: 'Provision & Write-off of Bad Debts', key: 'otherWorkingCapital' },
                { label: 'Other Operating Activities', key: 'otherNonCashItems' },
                { label: 'Change in Accounts Receivable', key: 'changeInWorkingCapital' },
                { label: 'Change in Inventory', key: 'inventory' },
                { label: 'Change in Accounts Payable', key: 'accountsPayables' },
                { label: 'Change in Other Net Operating Assets', key: 'otherWorkingCapital' },
                { label: 'Operating Cash Flow', key: 'operatingCashFlow', bold: true },
                { label: 'Operating Cash Flow Growth', key: '_ocfGrowth', isGrowth: true, indent: true },
                { label: '‚Äî INVESTING ACTIVITIES ‚Äî', isSection: true },
                { label: 'Capital Expenditures', key: 'capitalExpenditure' },
                { label: 'Cash Acquisitions', key: 'acquisitionsNet' },
                { label: 'Sale (Purchase) of Intangibles', key: 'salePurchaseOfStock' },
                { label: 'Investment in Securities', key: 'purchasesOfInvestments' },
                { label: 'Other Investing Activities', key: 'otherInvestingActivites' },
                { label: 'Investing Cash Flow', key: 'investingCashFlow', bold: true },
                { label: '‚Äî FINANCING ACTIVITIES ‚Äî', isSection: true },
                { label: 'Long-Term Debt Issued', key: 'longTermDebtIssued' },
                { label: 'Long-Term Debt Repaid', key: 'longTermDebtRepaid' },
                { label: 'Net Debt Issued (Repaid)', key: 'debtRepayment' },
                { label: 'Issuance of Common Stock', key: 'commonStockIssued' },
                { label: 'Repurchase of Common Stock', key: 'commonStockRepurchased' },
                { label: 'Other Financing Activities', key: 'otherFinancingActivites' },
                { label: 'Financing Cash Flow', key: 'financingCashFlow', bold: true },
                { label: 'Foreign Exchange Rate Adjustment', key: 'effectOfForexChangesOnCash' },
                { label: 'Net Cash Flow', key: 'netChangeInCash', bold: true },
                { label: 'Free Cash Flow', key: 'freeCashFlow', bold: true },
                { label: 'Free Cash Flow Growth', key: '_fcfGrowth', isGrowth: true, indent: true },
                { label: 'Free Cash Flow Margin', key: '_fcfMargin', isPercent: true, indent: true },
                { label: 'Free Cash Flow Per Share', key: '_fcfPerShare', indent: true },
                { label: 'Cash Interest Paid', key: 'interestPaid' },
                { label: 'Cash Income Tax Paid', key: 'incomeTaxesPaid' },
                { label: 'Levered Free Cash Flow', key: '_fcf' },
                { label: 'Change in Working Capital', key: 'changeInWorkingCapital' },
            ];

            tbody.innerHTML = buildTableRows(rows, years, null, data.income || []);
        }

        // ============================================================
        // RATIOS
        // ============================================================
        function renderRatiosTable(data, period) {
            // For ratios we use ratiosHistory (annual) or ratios (TTM fallback)
            const ratiosData = data.ratiosHistory || [];
            const limit = period === 'quarterly' ? 8 : 5;
            const years = ratiosData.slice(0, limit);
            const thead = document.querySelector('#ratiosTable thead tr');
            const tbody = document.querySelector('#ratiosTable tbody');

            if (years.length === 0) {
                // Fallback: single TTM column from ratios-ttm
                const r = data.ratios || {};
                const q = data.quote || {};
                const p = data.profile || {};
                thead.innerHTML = `<th>Metric</th><th>Current</th>`;
                const rows = [
                    ['Market Capitalization', formatLarge(p.mktCap)],
                    ['Last Close Price', q.price ? `$${q.price.toFixed(2)}` : 'N/A'],
                    ['PE Ratio', r.priceEarningsRatioTTM?.toFixed(2) || 'N/A'],
                    ['Forward PE', 'N/A'],
                    ['PS Ratio', r.priceToSalesRatioTTM?.toFixed(2) || 'N/A'],
                    ['PB Ratio', r.priceToBookRatioTTM?.toFixed(2) || 'N/A'],
                    ['P/FCF Ratio', r.priceToFreeCashFlowsRatioTTM?.toFixed(2) || 'N/A'],
                    ['P/OCF Ratio', r.priceToOperatingCashFlowsRatioTTM?.toFixed(2) || 'N/A'],
                    ['PEG Ratio', r.priceEarningsToGrowthRatioTTM?.toFixed(2) || 'N/A'],
                    ['EV/Sales Ratio', r.enterpriseValueOverEBITDATTM?.toFixed(2) || 'N/A'],
                    ['EV/EBITDA Ratio', r.enterpriseValueMultipleTTM?.toFixed(2) || 'N/A'],
                    ['Debt / Equity Ratio', r.debtEquityRatioTTM?.toFixed(2) || 'N/A'],
                    ['Debt / EBITDA Ratio', r.debtToEquityTTM?.toFixed(2) || 'N/A'],
                    ['Net Debt / Equity Ratio', 'N/A'],
                    ['Net Debt / EBITDA Ratio', 'N/A'],
                    ['Asset Turnover', r.assetTurnoverTTM?.toFixed(2) || 'N/A'],
                    ['Inventory Turnover', r.inventoryTurnoverTTM?.toFixed(2) || 'N/A'],
                    ['Quick Ratio', r.quickRatioTTM?.toFixed(2) || 'N/A'],
                    ['Current Ratio', r.currentRatioTTM?.toFixed(2) || 'N/A'],
                    ['Return on Equity (ROE)', r.returnOnEquityTTM ? (r.returnOnEquityTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['Return on Assets (ROA)', r.returnOnAssetsTTM ? (r.returnOnAssetsTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['Return on Invested Capital (ROIC)', r.roicTTM ? (r.roicTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['Return on Capital Employed (ROCE)', 'N/A'],
                    ['Earnings Yield', r.earningsYieldTTM ? (r.earningsYieldTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['FCF Yield', r.freeCashFlowYieldTTM ? (r.freeCashFlowYieldTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['Buyback Yield / Dilution', 'N/A'],
                    ['Total Shareholder Return', 'N/A'],
                ];
                tbody.innerHTML = rows.map(([label, value]) => `<tr><td>${label}</td><td>${value}</td></tr>`).join('');
                return;
            }

            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;
            const ratioRows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: 'Market Capitalization', key: 'marketCapitalization' },
                { label: 'Last Close Price', key: 'stockPrice' },
                { label: 'PE Ratio', key: 'priceEarningsRatio', bold: true },
                { label: 'Forward PE', key: 'priceEarningsRatio' },
                { label: 'PS Ratio', key: 'priceToSalesRatio' },
                { label: 'PB Ratio', key: 'priceToBookRatio' },
                { label: 'P/FCF Ratio', key: 'priceToFreeCashFlowsRatio' },
                { label: 'P/OCF Ratio', key: 'priceToOperatingCashFlowsRatio' },
                { label: 'PEG Ratio', key: 'priceEarningsToGrowthRatio' },
                { label: 'EV/Sales Ratio', key: 'enterpriseValueOverEBITDA' },
                { label: 'EV/EBITDA Ratio', key: 'enterpriseValueMultiple' },
                { label: 'Debt / Equity Ratio', key: 'debtEquityRatio' },
                { label: 'Debt / EBITDA Ratio', key: 'debtToEquity' },
                { label: 'Net Debt / Equity Ratio', key: 'netDebtToEquity' },
                { label: 'Net Debt / EBITDA Ratio', key: 'netDebtToEBITDA' },
                { label: 'Asset Turnover', key: 'assetTurnover' },
                { label: 'Inventory Turnover', key: 'inventoryTurnover' },
                { label: 'Quick Ratio', key: 'quickRatio' },
                { label: 'Current Ratio', key: 'currentRatio' },
                { label: 'Return on Equity (ROE)', key: 'returnOnEquity', isPercent: true },
                { label: 'Return on Assets (ROA)', key: 'returnOnAssets', isPercent: true },
                { label: 'Return on Invested Capital (ROIC)', key: 'returnOnCapitalEmployed', isPercent: true },
                { label: 'Earnings Yield', key: 'earningsYield', isPercent: true },
                { label: 'FCF Yield', key: 'freeCashFlowYield', isPercent: true },
            ];
            tbody.innerHTML = buildTableRows(ratioRows, years, null);
        }

        // ============================================================
        // KPIs
        // ============================================================
        function renderKPIsTable(data, period) {
            const limit = period === 'quarterly' ? 8 : 5;
            const years = (data.income || []).slice(0, limit);
            const thead = document.querySelector('#kpisTable thead tr');
            const tbody = document.querySelector('#kpisTable tbody');
            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;

            const rows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: 'Shares Outstanding (Diluted)', key: 'weightedAverageSharesOutDil', bold: true },
                { label: 'Shares Change (YoY)', key: '_sharesGrowth', isGrowth: true, indent: true },
                { label: 'EPS (Basic)', key: 'eps' },
                { label: 'EPS (Diluted)', key: 'epsdiluted', bold: true },
                { label: 'EPS Growth', key: '_epsGrowth', isGrowth: true, indent: true },
                { label: 'Free Cash Flow', key: '_fcf', bold: true },
                { label: 'Free Cash Flow Per Share', key: '_fcfPerShare', indent: true },
                { label: 'Gross Margin', key: '_grossMargin', isPercent: true },
                { label: 'Operating Margin', key: '_opMargin', isPercent: true },
                { label: 'Profit Margin', key: '_netMargin', isPercent: true },
                { label: 'Free Cash Flow Margin', key: '_fcfMarginIncome', isPercent: true },
                { label: 'EBITDA', key: 'ebitda', bold: true },
                { label: 'EBITDA Margin', key: '_ebitdaMargin', isPercent: true, indent: true },
                { label: 'D&A For EBITDA', key: 'depreciationAndAmortization', indent: true },
                { label: 'EBIT', key: 'operatingIncome', bold: true },
                { label: 'EBIT Margin', key: '_opMargin', isPercent: true, indent: true },
                { label: 'Effective Tax Rate', key: '_taxRate', isPercent: true },
                { label: 'Revenue as Reported', key: 'revenue' },
                { label: 'Advertising Expenses', key: 'sellingGeneralAndAdministrativeExpenses' },
            ];

            tbody.innerHTML = buildTableRows(rows, years, data.cashflow);
        }

        // ============================================================
        // GENERIC TABLE ROW BUILDER
        // ============================================================
        function buildTableRows(rowsConfig, years, cashflowData, incomeDataAux) {
            let html = '';
            const incomeRef = years; // years is income or balance or cashflow data

            rowsConfig.forEach(row => {
                if (row.isSection) {
                    html += `<tr class="row-section"><td colspan="${years.length + 1}">${row.label}</td></tr>`;
                    return;
                }

                let trClass = '';
                if (row.bold) trClass += ' row-bold';
                if (row.indent) trClass += ' row-indent';

                let firstTdStyle = '';
                if (row.indent) firstTdStyle = '';

                html += `<tr class="${trClass}"><td>${row.label}</td>`;

                years.forEach((yearData, index) => {
                    let displayVal = 'N/A';
                    let colorClass = '';

                    if (row.key === '_date') {
                        displayVal = `<strong>${new Date(yearData.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</strong>`;
                    } else if (row.key === '_revGrowth' || row.key === '_netIncGrowth' || row.key === '_epsGrowth' || row.key === '_ocfGrowth' || row.key === '_fcfGrowth' || row.key === '_cashGrowth' || row.key === '_sharesGrowth') {
                        if (index < years.length - 1) {
                            const keyMap = {
                                '_revGrowth': 'revenue', '_netIncGrowth': 'netIncome', '_epsGrowth': 'epsdiluted',
                                '_ocfGrowth': 'operatingCashFlow', '_fcfGrowth': 'freeCashFlow',
                                '_cashGrowth': 'cashAndShortTermInvestments', '_sharesGrowth': 'weightedAverageSharesOutDil'
                            };
                            const k = keyMap[row.key];
                            const curr = yearData[k];
                            const prev = years[index + 1][k];
                            if (curr != null && prev != null && prev !== 0) {
                                const pct = ((curr - prev) / Math.abs(prev)) * 100;
                                displayVal = pct.toFixed(2) + '%';
                                colorClass = pct >= 0 ? 'positive' : 'negative';
                            }
                        }
                    } else if (row.key === '_grossMargin') {
                        const v = yearData.revenue ? (yearData.grossProfit / yearData.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_opMargin') {
                        const v = yearData.revenue ? (yearData.operatingIncome / yearData.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_netMargin') {
                        const v = yearData.revenue ? (yearData.netIncome / yearData.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_ebitdaMargin') {
                        const v = yearData.revenue && yearData.ebitda ? (yearData.ebitda / yearData.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_taxRate') {
                        const v = yearData.incomeBeforeTax ? (yearData.incomeTaxExpense / yearData.incomeBeforeTax) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_fcf') {
                        // From cashflow if available
                        const cf = cashflowData ? cashflowData[index] : yearData;
                        const v = cf?.freeCashFlow;
                        if (v != null) displayVal = formatMillion(v);
                    } else if (row.key === '_fcfPerShare') {
                        const cf = cashflowData ? cashflowData[index] : yearData;
                        const incRef = incomeDataAux ? incomeDataAux[index] : yearData;
                        const shares = (incRef?.weightedAverageSharesOutDil || yearData.weightedAverageSharesOutDil || 0);
                        const fcf = cf?.freeCashFlow;
                        if (fcf != null && shares > 0) displayVal = '$' + (fcf / shares).toFixed(2);
                    } else if (row.key === '_fcfMargin' || row.key === '_fcfMarginIncome') {
                        const cf = cashflowData ? cashflowData[index] : yearData;
                        const incRef = incomeDataAux ? incomeDataAux[index] : yearData;
                        const v = cf?.freeCashFlow && incRef?.revenue ? (cf.freeCashFlow / incRef.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_netCash') {
                        const cash = yearData.cashAndShortTermInvestments;
                        const debt = yearData.totalDebt;
                        if (cash != null && debt != null) {
                            const v = cash - debt;
                            displayVal = formatMillion(v);
                            colorClass = v >= 0 ? 'positive' : 'negative';
                        }
                    } else if (row.key === '_netCashPerShare') {
                        const cash = yearData.cashAndShortTermInvestments;
                        const debt = yearData.totalDebt;
                        const shares = yearData.commonStock || yearData.totalCommonShares || 0;
                        if (cash != null && debt != null && shares > 0) {
                            const v = (cash - debt) / shares;
                            displayVal = '$' + v.toFixed(2);
                        }
                    } else if (row.key === '_shares') {
                        // FMP balance sheet uses commonStock or totalCommonShares
                        const v = yearData.commonStock || yearData.totalCommonShares || yearData.weightedAverageSharesOutDil;
                        if (v != null) displayVal = (v / 1_000_000).toFixed(2);
                    } else if (row.key === '_workingCapital') {
                        const v = yearData.totalCurrentAssets && yearData.totalCurrentLiabilities
                            ? yearData.totalCurrentAssets - yearData.totalCurrentLiabilities : null;
                        if (v != null) displayVal = formatMillion(v);
                    } else if (row.key === '_bookValuePS') {
                        const bv = yearData.totalStockholdersEquity;
                        const shares = (yearData.commonStock || yearData.totalCommonShares || 0);
                        if (bv != null && shares > 0) displayVal = '$' + (bv / shares).toFixed(2);
                    } else if (row.key === '_tangibleBV') {
                        const gi = (yearData.goodwillAndIntangibleAssets || yearData.goodwill || 0) + (yearData.intangibleAssets || 0);
                        const v = yearData.totalStockholdersEquity != null ? yearData.totalStockholdersEquity - gi : null;
                        if (v != null) displayVal = formatMillion(v);
                    } else if (row.key === '_tangibleBVPS') {
                        const bv = yearData.totalStockholdersEquity;
                        const gi = (yearData.goodwillAndIntangibleAssets || yearData.goodwill || 0) + (yearData.intangibleAssets || 0);
                        const shares = yearData.commonStock || yearData.totalCommonShares || 0;
                        if (bv != null && shares > 0) displayVal = '$' + ((bv - gi) / shares).toFixed(2);
                    } else if (row.isGrowth) {
                        if (index < years.length - 1) {
                            const curr = yearData[row.key];
                            const prev = years[index + 1][row.key];
                            if (curr != null && prev != null && prev !== 0) {
                                const pct = ((curr - prev) / Math.abs(prev)) * 100;
                                displayVal = pct.toFixed(2) + '%';
                                colorClass = pct >= 0 ? 'positive' : 'negative';
                            }
                        }
                    } else if (row.isPercent) {
                        const v = yearData[row.key];
                        if (v != null) displayVal = (v * 100).toFixed(2) + '%';
                    } else {
                        const v = yearData[row.key];
                        if (v != null) {
                            if (row.key === 'eps' || row.key === 'epsdiluted') {
                                displayVal = '$' + v.toFixed(2);
                            } else if (Math.abs(v) < 100) {
                                displayVal = v.toFixed(2);
                            } else {
                                displayVal = formatMillion(v);
                            }
                        }
                    }

                    html += `<td class="${colorClass}">${displayVal}</td>`;
                });

                html += '</tr>';
            });

            return html;
        }

        // ============================================================
        // HELPERS
        // ============================================================
        function formatMillion(v) {
            if (v == null) return 'N/A';
            return (v / 1_000_000).toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function formatLarge(v) {
            if (!v) return 'N/A';
            if (v >= 1e12) return `$${(v / 1e12).toFixed(2)}T`;
            if (v >= 1e9) return `$${(v / 1e9).toFixed(2)}B`;
            if (v >= 1e6) return `$${(v / 1e6).toFixed(2)}M`;
            return `$${v.toFixed(2)}`;
        }

        function calculateScore(metrics, ratios) {
            let score = 2.5;
            if (metrics && ratios) {
                if (metrics.returnOnEquityTTM > 0.15) score += 0.5;
                if (metrics.returnOnEquityTTM > 0.25) score += 0.3;
                if (ratios.priceEarningsRatioTTM < 20) score += 0.3;
                if (ratios.priceEarningsRatioTTM > 40) score -= 0.3;
                if (metrics.debtToEquityTTM < 0.5) score += 0.4;
                if (metrics.netProfitMarginTTM > 0.15) score += 0.3;
            }
            return Math.min(Math.max(score, 1), 5).toFixed(2);
        }

        function updateGeneralTab(data) {
            const generalTab = document.getElementById('general-tab');
            const metricsGrid = generalTab.querySelector('.metrics-grid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Market Cap</div>
                    <div class="metric-value">${formatLarge(data.profile?.mktCap)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">P/E (TTM)</div>
                    <div class="metric-value">${data.ratios?.priceEarningsRatioTTM?.toFixed(2) || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Dividend Yield</div>
                    <div class="metric-value">${(data.profile?.lastDiv || 0).toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">EPS (TTM)</div>
                    <div class="metric-value">$${data.metrics?.earningsPerShareTTM?.toFixed(2) || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Industry</div>
                    <div class="metric-value" style="font-size: 1.3rem;">${data.profile?.industry || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Shares Outstanding</div>
                    <div class="metric-value" style="font-size: 1.3rem;">${data.metrics?.sharesMilTTM ? data.metrics.sharesMilTTM.toFixed(2) + 'M' : 'N/A'}</div>
                </div>
            `;
        }

        async function updateDividendsTab(data) {
            try {
                const dividendData = await fmpAPI.getDividendHistory(data.profile.symbol);
                if (!dividendData || !dividendData.historical || dividendData.historical.length === 0) {
                    document.getElementById('dividendsTableBody').innerHTML = '<tr><td colspan="4">Aucun dividende</td></tr>';
                    return;
                }
                const recent = dividendData.historical.slice(0, 5);
                document.getElementById('dividendsTableBody').innerHTML = recent.map(div => `
                    <tr>
                        <td>${new Date(div.date).toLocaleDateString('fr-FR', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td>$${div.dividend?.toFixed(3) || 'N/A'}</td>
                        <td>${new Date(div.recordDate || div.date).toLocaleDateString('fr-FR', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td>${new Date(div.paymentDate || div.date).toLocaleDateString('fr-FR', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading dividends:', error);
            }
        }

        // Back button
        backBtn.addEventListener('click', () => {
            searchView.style.display = 'block';
            stockDetailsView.classList.remove('active');
            currentSymbol = null;
            cachedData = {};
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Main tab switching
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // Preset cards
        document.querySelectorAll('.preset-card').forEach(card => {
            card.addEventListener('click', () => {
                const preset = card.dataset.preset;
                alert(`Screener "${preset}" sera bient√¥t disponible !`);
            });
        });

        console.log('üìä FMP Cache Stats:', fmpAPI.getCacheStats());
    </script>
</body>
</html>
