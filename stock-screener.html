<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Screener - StockMaster</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-orange: #FF7A00;
            --bg-main: #F9FAFB;
            --bg-topbar: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --hover-bg: #F3F4F6;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            --success-color: #10B981;
            --danger-color: #EF4444;
        }
        [data-theme="dark"] {
            --bg-main: #0F172A;
            --bg-topbar: #1E293B;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --border-color: #334155;
            --hover-bg: #334155;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background-color 0.3s ease;
        }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        
        /* TOPBAR */
        .topbar {
            background-color: var(--bg-topbar);
            border-bottom: 1px solid var(--border-color);
            padding: 0 30px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .topbar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--text-primary);
            text-decoration: none;
        }
        .topbar-logo img { height: 45px; width: auto; }
        .topbar-nav { display: flex; gap: 10px; flex: 1; justify-content: center; }
        .nav-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid var(--border-color);
            background: var(--bg-topbar);
            color: var(--text-secondary);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .nav-btn:hover {
            background-color: var(--hover-bg);
            color: var(--text-primary);
            transform: translateY(-2px);
        }
        .nav-btn.active {
            background-color: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }
        .nav-btn svg { width: 18px; height: 18px; }
        .topbar-actions { display: flex; align-items: center; gap: 15px; }
        .theme-toggle {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .theme-toggle svg { width: 20px; height: 20px; color: var(--text-primary); }
        .user-menu { position: relative; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-orange), #ff9f40);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: pointer;
        }
        .dropdown-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            opacity: 0;
            visibility: hidden;
            z-index: 1000;
        }
        .dropdown-menu.active { opacity: 1; visibility: visible; }
        .dropdown-item {
            padding: 14px 20px;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .dropdown-item:hover { background-color: var(--hover-bg); }
        .dropdown-item:last-child { color: #ef4444; border-top: 1px solid var(--border-color); }
        .dropdown-item svg { width: 18px; height: 18px; }
        
        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* SCREENER HOME */
        .screener-home {
            max-width: 1200px;
            margin: 0 auto;
            padding: 48px 24px 60px;
        }

        /* HERO ROW */
        .screener-hero {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 40px;
            margin-bottom: 48px;
        }
        .screener-hero-left { flex: 1; }
        .screener-eyebrow {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,122,0,0.1);
            border: 1px solid rgba(255,122,0,0.25);
            color: var(--primary-orange);
            font-size: 0.78rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 5px 14px;
            border-radius: 100px;
            margin-bottom: 20px;
        }
        .screener-hero h1 {
            font-size: 2.8rem;
            font-weight: 800;
            line-height: 1.15;
            color: var(--text-primary);
            margin-bottom: 16px;
            letter-spacing: -0.03em;
        }
        .screener-hero h1 span { color: var(--primary-orange); }
        .screener-hero-desc {
            font-size: 1.05rem;
            color: var(--text-secondary);
            line-height: 1.65;
            max-width: 480px;
            margin-bottom: 32px;
        }
        .screener-stats {
            display: flex;
            gap: 32px;
        }
        .screener-stat { }
        .screener-stat-value {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }
        .screener-stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        /* SEARCH BAR */
        .search-bar-wrap {
            position: relative;
            max-width: 700px;
        }
        .search-bar-inner {
            display: flex;
            align-items: center;
            background: var(--bg-topbar);
            border: 1.5px solid var(--border-color);
            border-radius: 12px;
            padding: 0 16px;
            gap: 12px;
            transition: all 0.2s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }
        .search-bar-inner:focus-within {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 3px rgba(255,122,0,0.12);
        }
        .search-bar-icon { color: var(--text-secondary); display:flex; flex-shrink:0; }
        .search-bar-icon svg { width: 20px; height: 20px; }
        .search-input {
            flex: 1;
            padding: 15px 0;
            border: none;
            background: transparent;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: inherit;
        }
        .search-input:focus { outline: none; }
        .search-input::placeholder { color: var(--text-secondary); }
        .search-kbd {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 3px 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .search-results {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-height: 320px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        .search-results.active { display: block; }
        .search-result-item {
            padding: 12px 18px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.15s;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: var(--hover-bg); }
        .result-symbol {
            font-weight: 700;
            color: var(--primary-orange);
            font-size: 0.95rem;
            min-width: 60px;
        }
        .result-name { color: var(--text-secondary); font-size: 0.88rem; flex:1; margin-left: 12px; }
        .result-exchange {
            font-size: 0.75rem;
            color: var(--text-secondary);
            background: var(--hover-bg);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* SECTION LABEL */
        .section-label {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-color);
        }

        /* FILTER PRESETS GRID */
        .filter-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            margin-bottom: 48px;
        }
        @media (max-width: 900px) { .filter-presets { grid-template-columns: repeat(2,1fr); } }
        @media (max-width: 580px) { .filter-presets { grid-template-columns: 1fr; } }

        .preset-card {
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            gap: 16px;
            align-items: flex-start;
            text-align: left;
        }
        .preset-card:hover {
            border-color: var(--primary-orange);
            background: rgba(255,122,0,0.03);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255,122,0,0.1);
        }
        .preset-icon {
            width: 42px;
            height: 42px;
            min-width: 42px;
            background: rgba(255,122,0,0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .preset-body { flex: 1; min-width: 0; }
        .preset-card h3 {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        .preset-card p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .preset-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .tag {
            padding: 2px 8px;
            background: var(--hover-bg);
            border-radius: 4px;
            font-size: 0.73rem;
            font-weight: 600;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        /* POPULAR STOCKS TABLE */
        .popular-section { margin-bottom: 48px; }
        .popular-table-wrap {
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        .popular-table {
            width: 100%;
            border-collapse: collapse;
        }
        .popular-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-color);
            background: var(--hover-bg);
        }
        .popular-table th:not(:first-child) { text-align: right; }
        .popular-table td {
            padding: 13px 16px;
            font-size: 0.88rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .popular-table td:not(:first-child) { text-align: right; }
        .popular-table tr:last-child td { border-bottom: none; }
        .popular-table tr { transition: background 0.15s; cursor: pointer; }
        .popular-table tr:hover td { background: var(--hover-bg); }
        .pop-symbol {
            font-weight: 700;
            color: var(--primary-orange);
            font-size: 0.9rem;
        }
        .pop-name { color: var(--text-secondary); font-size: 0.82rem; margin-top: 1px; }
        .pop-change-pos { color: #10b981; font-weight: 600; }
        .pop-change-neg { color: #ef4444; font-weight: 600; }
        .pop-mktcap { color: var(--text-secondary); }

                /* FILTER PRESETS */
        .filter-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }
        .preset-card {
            background: var(--bg-topbar);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        .preset-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary-orange);
            box-shadow: var(--shadow-lg);
        }
        .preset-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(255, 122, 0, 0.1), rgba(255, 122, 0, 0.2));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }
        .preset-icon svg { width: 26px; height: 26px; color: var(--primary-orange); }
        .preset-card h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        .preset-card p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 16px;
        }
        .preset-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .tag {
            padding: 4px 12px;
            background: var(--hover-bg);
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        /* STOCK DETAILS PAGE */
        .stock-details {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
        }
        .stock-details.active { display: block; }
        
        .stock-header {
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        .stock-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .stock-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .stock-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-orange), #ff9f40);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.5rem;
        }
        .stock-name h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        .stock-name p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        .back-btn {
            padding: 12px 24px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        .back-btn:hover {
            background: var(--primary-orange);
            color: white;
            border-color: var(--primary-orange);
        }
        .stock-price-row {
            display: flex;
            gap: 40px;
            align-items: baseline;
        }
        .current-price {
            font-size: 3rem;
            font-weight: 800;
            color: var(--text-primary);
        }
        .price-change {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .price-change.positive { color: var(--success-color); }
        .price-change.negative { color: var(--danger-color); }
        .score-badge {
            margin-left: auto;
            text-align: right;
        }
        .score-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .score-value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-orange), #ff9f40);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* TABS */
        .tabs-container {
            background: var(--bg-topbar);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 0;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .tabs-nav {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            background: var(--bg-topbar);
        }
        .tab-btn {
            flex: 1;
            padding: 18px 24px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        .tab-btn.active {
            color: var(--primary-orange);
            border-bottom-color: var(--primary-orange);
            background: var(--hover-bg);
        }
        .tab-content {
            padding: 30px;
            display: none;
        }
        .tab-content.active { display: block; }
        
        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* FINANCIALS SUB-TABS */
        .financials-sub-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .financials-sub-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 4px;
        }
        .fin-sub-btn {
            padding: 8px 18px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }
        .fin-sub-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        .fin-sub-btn.active {
            background: var(--primary-orange);
            color: white;
        }

        /* PERIOD TOGGLE (Annual / Quarterly) */
        .period-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 4px;
        }
        .period-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: transparent;
            color: var(--text-secondary);
        }
        .period-btn:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }
        .period-btn.active {
            background: var(--bg-topbar);
            color: var(--primary-orange);
            border: 1px solid var(--primary-orange);
        }

        /* TABLE */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-main);
            border-radius: 12px;
            overflow: hidden;
            font-size: 0.9rem;
        }
        .data-table th {
            background: var(--hover-bg);
            padding: 12px 14px;
            text-align: right;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }
        .data-table th:first-child {
            text-align: left;
            min-width: 260px;
        }
        .data-table td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.88rem;
            text-align: right;
            white-space: nowrap;
        }
        .data-table td:first-child {
            text-align: left;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tr:hover {
            background: var(--hover-bg);
        }
        .data-table .row-bold td { font-weight: 700; background: rgba(0,0,0,0.02); }
        .data-table .row-indent td:first-child { padding-left: 28px; color: var(--text-secondary); }
        .data-table .row-section td { 
            background: var(--hover-bg); 
            font-weight: 700; 
            font-size: 0.85rem; 
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 8px 14px;
        }
        .positive { color: var(--success-color) !important; }
        .negative { color: var(--danger-color) !important; }
        
        /* TABLE WRAPPER */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        /* CHART PLACEHOLDER */
        .chart-container {
            background: var(--bg-main);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        /* RESPONSIVE */
        @media (max-width: 968px) {
            .topbar-nav { display: none; }
            .search-section h2 { font-size: 2rem; }
            .stock-price-row { flex-direction: column; gap: 15px; }
            .current-price { font-size: 2.2rem; }
            .tabs-nav { overflow-x: auto; }
            .tab-btn { white-space: nowrap; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="topbar">
            <a href="webapp.html" class="topbar-logo">
                <img src="logo.png" alt="Logo">
                StockMaster
            </a>
            <nav class="topbar-nav">
                <a href="webapp.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Home
                </a>
                <a href="stock-screener.html" class="nav-btn active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    Stock Screener
                </a>
                <a href="valorisation-analysis.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Valorisation Analysis
                </a>
                <a href="dcf-calculator.html" class="nav-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    DCF Calculator
                </a>
            </nav>
            <div class="topbar-actions">
                <button class="theme-toggle" id="themeToggle">
                    <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="moonIcon" style="display:none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <a href="settings.html" class="dropdown-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Settings
                        </a>
                        <a href="billings-plans.html" class="dropdown-item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                            </svg>
                            Billings & Plans
                        </a>
                        <div class="dropdown-item" id="signOutBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Sign Out
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="screener-home" id="searchView">

                <!-- HERO -->
                <div class="screener-hero">
                    <div class="screener-hero-left">
                        <div class="screener-eyebrow">
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor"><circle cx="6" cy="6" r="6"/></svg>
                            Professional Stock Screener
                        </div>
                        <h1>Find your next<br><span>great investment</span></h1>
                        <p class="screener-hero-desc">Search and analyze thousands of stocks. Access detailed financial data, insight scores and key metrics ‚Äî all in one place.</p>
                        <div class="screener-stats">
                            <div class="screener-stat">
                                <div class="screener-stat-value">172K+</div>
                                <div class="screener-stat-label">Stocks & ETFs</div>
                            </div>
                            <div class="screener-stat">
                                <div class="screener-stat-value">6</div>
                                <div class="screener-stat-label">Score categories</div>
                            </div>
                            <div class="screener-stat">
                                <div class="screener-stat-value">Real-time</div>
                                <div class="screener-stat-label">Market data</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SEARCH BAR -->
                <div class="search-bar-wrap" style="margin-bottom:48px;">
                    <div class="search-bar-inner">
                        <div class="search-bar-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input 
                            type="text" 
                            class="search-input" 
                            id="stockSearch" 
                            placeholder="Search a stock to analyze (e.g. AAPL, MSFT, NVDA...)"
                            autocomplete="off"
                        >
                        <span class="search-kbd">/ to focus</span>
                    </div>
                    <div class="search-results" id="searchResults"></div>
                </div>

                <!-- POPULAR SCREENS -->
                <div class="section-label">Popular Screens</div>
                <div class="filter-presets">
                    <div class="preset-card" data-preset="value">
                        <div class="preset-icon">üíé</div>
                        <div class="preset-body">
                            <h3>Value Stocks</h3>
                            <p>Undervalued companies with strong fundamentals and recovery potential.</p>
                            <div class="preset-tags">
                                <span class="tag">P/E &lt; 15</span>
                                <span class="tag">P/B &lt; 2</span>
                                <span class="tag">Div &gt; 3%</span>
                            </div>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="growth">
                        <div class="preset-icon">üöÄ</div>
                        <div class="preset-body">
                            <h3>Growth Stocks</h3>
                            <p>High-growth companies with strong revenue and earnings momentum.</p>
                            <div class="preset-tags">
                                <span class="tag">Rev +20%</span>
                                <span class="tag">EPS +25%</span>
                                <span class="tag">ROE &gt; 15%</span>
                            </div>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="dividend">
                        <div class="preset-icon">üí∞</div>
                        <div class="preset-body">
                            <h3>Dividend Kings</h3>
                            <p>High and consistent dividend payers, ideal for passive income.</p>
                            <div class="preset-tags">
                                <span class="tag">Yield &gt; 4%</span>
                                <span class="tag">Payout &lt; 60%</span>
                                <span class="tag">5yr+ history</span>
                            </div>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="quality">
                        <div class="preset-icon">‚≠ê</div>
                        <div class="preset-body">
                            <h3>Quality Stocks</h3>
                            <p>Strong balance sheets, high margins, and durable competitive moats.</p>
                            <div class="preset-tags">
                                <span class="tag">ROE &gt; 20%</span>
                                <span class="tag">D/E &lt; 0.5</span>
                                <span class="tag">Margin &gt; 15%</span>
                            </div>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="momentum">
                        <div class="preset-icon">‚ö°</div>
                        <div class="preset-body">
                            <h3>Momentum</h3>
                            <p>Stocks with strong technical and fundamental upward momentum.</p>
                            <div class="preset-tags">
                                <span class="tag">Above SMA50</span>
                                <span class="tag">Vol +20%</span>
                                <span class="tag">RSI 50‚Äì70</span>
                            </div>
                        </div>
                    </div>

                    <div class="preset-card" data-preset="smallcap">
                        <div class="preset-icon">üåü</div>
                        <div class="preset-body">
                            <h3>Small Cap Gems</h3>
                            <p>High-growth small caps with significant upside and manageable risk.</p>
                            <div class="preset-tags">
                                <span class="tag">Cap &lt; 2B</span>
                                <span class="tag">Rev +30%</span>
                                <span class="tag">Profitable</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- POPULAR STOCKS TABLE -->
                <div class="popular-section">
                    <div class="section-label">Most Searched Stocks</div>
                    <div class="popular-table-wrap">
                        <table class="popular-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Sector</th>
                                    <th>Market Cap</th>
                                    <th>P/E Ratio</th>
                                    <th>Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr onclick="showStockDetails('AAPL')">
                                    <td><div class="pop-symbol">AAPL</div><div class="pop-name">Apple Inc.</div></td>
                                    <td><span style="color:var(--text-secondary)">Technology</span></td>
                                    <td class="pop-mktcap">3.48T</td>
                                    <td>33.2</td>
                                    <td class="pop-change-pos">+0.82%</td>
                                </tr>
                                <tr onclick="showStockDetails('MSFT')">
                                    <td><div class="pop-symbol">MSFT</div><div class="pop-name">Microsoft Corporation</div></td>
                                    <td><span style="color:var(--text-secondary)">Technology</span></td>
                                    <td class="pop-mktcap">3.02T</td>
                                    <td>37.8</td>
                                    <td class="pop-change-neg">-0.34%</td>
                                </tr>
                                <tr onclick="showStockDetails('NVDA')">
                                    <td><div class="pop-symbol">NVDA</div><div class="pop-name">NVIDIA Corporation</div></td>
                                    <td><span style="color:var(--text-secondary)">Semiconductors</span></td>
                                    <td class="pop-mktcap">2.74T</td>
                                    <td>52.1</td>
                                    <td class="pop-change-pos">+1.47%</td>
                                </tr>
                                <tr onclick="showStockDetails('AMZN')">
                                    <td><div class="pop-symbol">AMZN</div><div class="pop-name">Amazon.com Inc.</div></td>
                                    <td><span style="color:var(--text-secondary)">Consumer Cyclical</span></td>
                                    <td class="pop-mktcap">2.21T</td>
                                    <td>44.6</td>
                                    <td class="pop-change-pos">+0.61%</td>
                                </tr>
                                <tr onclick="showStockDetails('META')">
                                    <td><div class="pop-symbol">META</div><div class="pop-name">Meta Platforms Inc.</div></td>
                                    <td><span style="color:var(--text-secondary)">Communication</span></td>
                                    <td class="pop-mktcap">1.49T</td>
                                    <td>28.3</td>
                                    <td class="pop-change-neg">-0.21%</td>
                                </tr>
                                <tr onclick="showStockDetails('GOOGL')">
                                    <td><div class="pop-symbol">GOOGL</div><div class="pop-name">Alphabet Inc.</div></td>
                                    <td><span style="color:var(--text-secondary)">Communication</span></td>
                                    <td class="pop-mktcap">2.08T</td>
                                    <td>24.1</td>
                                    <td class="pop-change-pos">+0.33%</td>
                                </tr>
                                <tr onclick="showStockDetails('BRK-B')">
                                    <td><div class="pop-symbol">BRK-B</div><div class="pop-name">Berkshire Hathaway</div></td>
                                    <td><span style="color:var(--text-secondary)">Financials</span></td>
                                    <td class="pop-mktcap">1.07T</td>
                                    <td>21.8</td>
                                    <td class="pop-change-pos">+0.15%</td>
                                </tr>
                                <tr onclick="showStockDetails('JPM')">
                                    <td><div class="pop-symbol">JPM</div><div class="pop-name">JPMorgan Chase & Co.</div></td>
                                    <td><span style="color:var(--text-secondary)">Financials</span></td>
                                    <td class="pop-mktcap">764B</td>
                                    <td>13.4</td>
                                    <td class="pop-change-neg">-0.44%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

            <div class="stock-details" id="stockDetailsView">
                <div class="stock-header">
                    <div class="stock-title-row">
                        <div class="stock-title">
                            <div class="stock-logo" id="stockLogo">AJG</div>
                            <div class="stock-name">
                                <h1 id="stockFullName">Arthur J. Gallagher & Co.</h1>
                                <p id="stockSymbol">AJG - Insurance</p>
                            </div>
                        </div>
                        <button class="back-btn" id="backBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:18px;height:18px">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Back
                        </button>
                    </div>
                    <div class="stock-price-row">
                        <div class="current-price" id="currentPrice">$242.75</div>
                        <div class="price-change negative" id="priceChange">‚Üì $6.80 (-2.73%)</div>
                        <div class="score-badge">
                            <div class="score-label">Score</div>
                            <div class="score-value" id="scoreValue">3.24/5</div>
                        </div>
                    </div>
                </div>

                <div class="tabs-container">
                    <div class="tabs-nav">
                        <button class="tab-btn active" data-tab="general">General</button>
                        <button class="tab-btn" data-tab="scores">Scores</button>
                        <button class="tab-btn" data-tab="financials">Financials & KPIs</button>
                        <button class="tab-btn" data-tab="dividends">Dividends</button>
                    </div>

                    <!-- GENERAL TAB -->
                    <div class="tab-content active" id="general-tab">
                        <div class="chart-container">
                            <p>üìà Price Chart de l'action (coming soon)</p>
                        </div>
                        
                        <h3 style="margin-bottom: 20px; font-size: 1.5rem;">Key Metrics</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Market Cap</div>
                                <div class="metric-value">$62.34B</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">P/E (TTM)</div>
                                <div class="metric-value">41.73</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Dividend Yield</div>
                                <div class="metric-value">1.15%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">EPS (TTM)</div>
                                <div class="metric-value">$5.75</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Industry</div>
                                <div class="metric-value" style="font-size: 1.3rem;">Insurance</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Diluted Shares</div>
                                <div class="metric-value" style="font-size: 1.3rem;">260.26M</div>
                            </div>
                        </div>
                    </div>

                    <!-- SCORES TAB -->
                    <div class="tab-content" id="scores-tab">
                        <div id="scores-content">
                            <div style="text-align:center;padding:60px 20px;color:var(--text-secondary);">
                                <div style="font-size:2rem;margin-bottom:12px;">üìä</div>
                                <div>Load a stock to view the score analysis</div>
                            </div>
                        </div>
                    </div>

                    <!-- FINANCIALS & KPIs TAB -->
                    <div class="tab-content" id="financials-tab">
                        <!-- Sub-nav: Income / Balance / Cash Flow / Ratios / KPIs + Annual/Quarterly -->
                        <div class="financials-sub-nav">
                            <div class="financials-sub-tabs">
                                <button class="fin-sub-btn active" data-fin="income">Income Statement</button>
                                <button class="fin-sub-btn" data-fin="balance">Balance Sheet</button>
                                <button class="fin-sub-btn" data-fin="cashflow">Cash Flow</button>
                                <button class="fin-sub-btn" data-fin="ratios">Ratios</button>
                                <button class="fin-sub-btn" data-fin="kpis">KPIs</button>
                            </div>
                            <div class="period-toggle">
                                <button class="period-btn active" data-period="annual">Annual</button>
                                <button class="period-btn" data-period="quarterly">Quarterly</button>
                            </div>
                        </div>

                        <!-- Income Statement -->
                        <div class="fin-content active" id="fin-income">
                            <div class="table-wrapper">
                                <table class="data-table" id="incomeTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Balance Sheet -->
                        <div class="fin-content" id="fin-balance" style="display:none;">
                            <div class="table-wrapper">
                                <table class="data-table" id="balanceTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Cash Flow -->
                        <div class="fin-content" id="fin-cashflow" style="display:none;">
                            <div class="table-wrapper">
                                <table class="data-table" id="cashflowTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Ratios -->
                        <div class="fin-content" id="fin-ratios" style="display:none;">
                            <div class="table-wrapper">
                                <table class="data-table" id="ratiosTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- KPIs -->
                        <div class="fin-content" id="fin-kpis" style="display:none;">
                            <div class="table-wrapper">
                                <table class="data-table" id="kpisTable">
                                    <thead><tr></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- DIVIDENDS TAB -->
                    <div class="tab-content" id="dividends-tab">
                        <h3 style="margin-bottom: 20px; font-size: 1.5rem;">Informations sur les Dividendes</h3>
                        <div class="metrics-grid" style="margin-bottom: 30px;">
                            <div class="metric-card">
                                <div class="metric-label">Dividend Yield</div>
                                <div class="metric-value">1.15%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Annual Dividend</div>
                                <div class="metric-value">$2.80</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Payout Ratio</div>
                                <div class="metric-value">46.17%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Dividend Growth</div>
                                <div class="metric-value" style="color: var(--success-color);">8.16%</div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 20px; font-size: 1.3rem;">Dividend History</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ex-Dividend Date</th>
                                    <th>Cash Amount</th>
                                    <th>Record Date</th>
                                    <th>Pay Date</th>
                                </tr>
                            </thead>
                            <tbody id="dividendsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
// score-engine.js
// Syst√®me de scoring StockUnlock ‚Äî 6 cat√©gories, 26 m√©triques
// Import dans stock-screener.html via: import { computeAllScores, renderScoresTab } from './score-engine.js';

// ============================================================
// SCORE ENGINE ‚Äî Full StockUnlock-style scoring system
// ============================================================

const SCORE_LABELS = {
    5: { label: 'Tr√®s bien',    color: '#22c55e', bg: 'rgba(34,197,94,0.15)' },
    4: { label: 'Bien',         color: '#86efac', bg: 'rgba(134,239,172,0.15)' },
    3: { label: 'Moyenne',      color: '#f59e0b', bg: 'rgba(245,158,11,0.15)' },
    2: { label: 'Mauvais',      color: '#f97316', bg: 'rgba(249,115,22,0.15)' },
    1: { label: 'Tr√®s mauvais', color: '#ef4444', bg: 'rgba(239,68,68,0.15)' },
};

function getScoreLabel(score) {
    if (score == null) return { label: 'N/A', color: 'var(--text-secondary)', bg: 'var(--hover-bg)' };
    return SCORE_LABELS[Math.round(Math.max(1, Math.min(5, score)))];
}

function scoreByThreshold(value, [t1, t2, t3, t4], higherIsBetter = true) {
    if (value == null || isNaN(value)) return null;
    if (higherIsBetter) {
        if (value >= t4) return 5;
        if (value >= t3) return 4;
        if (value >= t2) return 3;
        if (value >= t1) return 2;
        return 1;
    } else {
        if (value <= t1) return 5;
        if (value <= t2) return 4;
        if (value <= t3) return 3;
        if (value <= t4) return 2;
        return 1;
    }
}

function pctVal(v) { return v != null ? v * 100 : null; }

function growthPct(curr, prev) {
    if (curr == null || prev == null || prev === 0) return null;
    return ((curr - prev) / Math.abs(prev)) * 100;
}

function avgArr(arr) {
    const v = arr.filter(x => x != null);
    return v.length ? v.reduce((a, b) => a + b, 0) / v.length : null;
}

// ‚îÄ‚îÄ Category: Rentabilit√© ‚îÄ‚îÄ
function scoreRentabilite(data) {
    const r   = data.ratios   || {};
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const rev = inc[0]?.revenue;
    const gp  = inc[0]?.grossProfit;
    const op  = inc[0]?.operatingIncome;
    const ni  = inc[0]?.netIncome;
    const fcf = cf[0]?.freeCashFlow;
    const ocf = cf[0]?.operatingCashFlow;

    const grossM = rev ? (gp  / rev) * 100 : pctVal(r.grossProfitMarginTTM);
    const opM    = rev ? (op  / rev) * 100 : pctVal(r.operatingProfitMarginTTM);
    const netM   = rev ? (ni  / rev) * 100 : pctVal(r.netProfitMarginTTM);
    const fcfM   = (fcf != null && rev) ? (fcf / rev) * 100 : null;
    const cashConv = (fcf != null && ni && ni !== 0) ? (fcf / ni) * 100 : null;

    const metrics = [
        { label: 'Marge brute',           value: grossM,   format: 'pct', score: scoreByThreshold(grossM,   [20, 35, 50, 65]) },
        { label: 'Marge op√©rationnelle',   value: opM,      format: 'pct', score: scoreByThreshold(opM,      [5, 10, 15, 25]) },
        { label: 'Marge nette',            value: netM,     format: 'pct', score: scoreByThreshold(netM,     [3, 7, 12, 20]) },
        { label: 'Marge FCF',              value: fcfM,     format: 'pct', score: scoreByThreshold(fcfM,     [2, 5, 10, 18]) },
        { label: 'Conversion tr√©sorerie',  value: cashConv, format: 'pct', score: scoreByThreshold(cashConv, [20, 40, 60, 80]) },
    ];

    return buildCategory('Rentabilit√©', 'üìà', metrics);
}

// ‚îÄ‚îÄ Category: Gestion ‚îÄ‚îÄ
function scoreGestion(data) {
    const r   = data.ratios   || {};
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const rev = inc[0]?.revenue;
    const ocf = cf[0]?.operatingCashFlow;
    const fcf = cf[0]?.freeCashFlow;
    const sbc = cf[0]?.stockBasedCompensation;

    const sbcRev = (sbc != null && rev) ? (sbc / rev) * 100 : null;
    const sbcOcf = (sbc != null && ocf && ocf > 0) ? (sbc / ocf) * 100 : null;
    const sbcFcf = (sbc != null && fcf && fcf > 0) ? (sbc / fcf) * 100 : null;
    const roic   = pctVal(r.roicTTM);
    const roce   = pctVal(r.returnOnCapitalEmployedTTM);

    const metrics = [
        { label: "SBC en % du chiffre d'affaires",                   value: sbcRev, format: 'pct', score: scoreByThreshold(sbcRev, [1, 3, 5, 10],   false) },
        { label: "SBC en % du flux de tr√©sorerie d'exploitation",    value: sbcOcf, format: 'pct', score: scoreByThreshold(sbcOcf, [5, 10, 20, 35],  false) },
        { label: "SBC en % du flux de tr√©sorerie disponible",        value: sbcFcf, format: 'pct', score: scoreByThreshold(sbcFcf, [10, 25, 50, 100], false) },
        { label: 'ROIC',                                              value: roic,   format: 'pct', score: scoreByThreshold(roic,   [5, 10, 15, 25]) },
        { label: 'ROCE',                                              value: roce,   format: 'pct', score: scoreByThreshold(roce,   [5, 10, 15, 25]) },
    ];

    return buildCategory('Gestion', '‚öôÔ∏è', metrics);
}

// ‚îÄ‚îÄ Category: Croissance ‚îÄ‚îÄ
function scoreCroissance(data) {
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const revG  = growthPct(inc[0]?.revenue,        inc[1]?.revenue);
    const gpG   = growthPct(inc[0]?.grossProfit,    inc[1]?.grossProfit);
    const opG   = growthPct(inc[0]?.operatingIncome,inc[1]?.operatingIncome);
    const niG   = growthPct(inc[0]?.netIncome,      inc[1]?.netIncome);
    const ocfG  = growthPct(cf[0]?.operatingCashFlow, cf[1]?.operatingCashFlow);

    const metrics = [
        { label: 'Augmentation des revenus',                           value: revG, format: 'pct', score: scoreByThreshold(revG, [0, 5, 10, 20]) },
        { label: 'Augmentation du b√©n√©fice brut',                      value: gpG,  format: 'pct', score: scoreByThreshold(gpG,  [0, 5, 10, 20]) },
        { label: "Augmentation du r√©sultat d'exploitation",            value: opG,  format: 'pct', score: scoreByThreshold(opG,  [0, 5, 15, 30]) },
        { label: 'Augmentation du revenu net',                         value: niG,  format: 'pct', score: scoreByThreshold(niG,  [0, 5, 15, 30]) },
        { label: "Augmentation des flux de tr√©sorerie d'exploitation", value: ocfG, format: 'pct', score: scoreByThreshold(ocfG, [-5, 0, 10, 25]) },
    ];

    return buildCategory('Croissance', 'üöÄ', metrics);
}

// ‚îÄ‚îÄ Category: Sant√© financi√®re ‚îÄ‚îÄ
function scoreSanteFinanciere(data) {
    const r   = data.ratios   || {};
    const b   = data.balance  || [];
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const curRatio = r.currentRatioTTM ?? (b[0] ? (b[0].totalCurrentAssets || 0) / Math.max(b[0].totalCurrentLiabilities || 1, 1) : null);
    const intang   = b[0] ? ((b[0].goodwill || 0) + (b[0].intangibleAssets || 0)) : null;
    const totA     = b[0]?.totalAssets;
    const intangPct = (intang != null && totA) ? (intang / totA) * 100 : null;
    const shareG   = growthPct(inc[0]?.weightedAverageSharesOutDil, inc[1]?.weightedAverageSharesOutDil);
    const ebitda   = inc[0]?.ebitda;
    const debt     = b[0]?.totalDebt;
    const debtEbitda = (debt != null && ebitda && ebitda > 0) ? debt / ebitda : null;

    const metrics = [
        { label: 'Ratio actuel',                              value: curRatio,   format: 'ratio', score: scoreByThreshold(curRatio,   [0.5, 0.8, 1.2, 2.0]) },
        { label: 'Actifs incorporels en % du total des actifs', value: intangPct, format: 'pct',   score: scoreByThreshold(intangPct,  [5, 15, 30, 50], false) },
        { label: 'Les actions augmentent',                    value: shareG,     format: 'pct',   score: scoreByThreshold(shareG,     [-2, 0, 1, 3], false) },
        { label: 'Ratio dette/EBITDA',                        value: debtEbitda, format: 'ratio', score: scoreByThreshold(debtEbitda, [0.5, 1.0, 2.0, 4.0], false) },
    ];

    return buildCategory('Sant√© financi√®re', 'üè¶', metrics);
}

// ‚îÄ‚îÄ Category: Analyste (proxy via croissance historique) ‚îÄ‚îÄ
function scoreAnalyste(data) {
    const inc = data.income   || [];
    const cf  = data.cashflow || [];

    const epsG    = growthPct(inc[0]?.epsdiluted,  inc[1]?.epsdiluted);
    const revG    = growthPct(inc[0]?.revenue,     inc[1]?.revenue);
    const ebitdaG = growthPct(inc[0]?.ebitda,      inc[1]?.ebitda);

    const metrics = [
        { label: "BPA projet√© pour l'ann√©e prochaine",    value: epsG,    format: 'pct', score: scoreByThreshold(epsG,    [0, 5, 15, 30]) },
        { label: "Revenus projet√©s pour l'ann√©e prochaine", value: revG,  format: 'pct', score: scoreByThreshold(revG,    [0, 5, 10, 20]) },
        { label: "EBITDA projet√© pour l'ann√©e prochaine",  value: ebitdaG,format: 'pct', score: scoreByThreshold(ebitdaG, [0, 5, 15, 30]) },
    ];

    return buildCategory('Analyste', 'üî≠', metrics);
}

// ‚îÄ‚îÄ Category: √âvaluation ‚îÄ‚îÄ
function scoreEvaluation(data) {
    const r  = data.ratios        || {};
    const rh = data.ratiosHistory || [];

    const pe   = r.priceEarningsRatioTTM;
    const pfcf = r.priceToFreeCashFlowsRatioTTM;
    const ps   = r.priceToSalesRatioTTM;

    const last5 = rh.slice(0, 5);
    const safe  = (arr) => arr.filter(v => v != null && v > 0 && v < 500);
    const avg5  = (arr) => { const a = safe(arr); return a.length ? a.reduce((s, v) => s + v, 0) / a.length : null; };

    const avgPE5   = avg5(last5.map(y => y.priceEarningsRatio));
    const avgPFCF5 = avg5(last5.map(y => y.priceToFreeCashFlowsRatio));
    const avgPS5   = avg5(last5.map(y => y.priceToSalesRatio));

    const peVs5    = (pe   && avgPE5)   ? ((pe   - avgPE5)   / avgPE5)   * 100 : null;
    const pfcfVs5  = (pfcf && avgPFCF5) ? ((pfcf - avgPFCF5) / avgPFCF5) * 100 : null;
    const psVs5    = (ps   && avgPS5)   ? ((ps   - avgPS5)   / avgPS5)   * 100 : null;
    const RFREE    = 4.5;
    const fcfPrime = pfcf ? ((1 / pfcf) * 100) - RFREE : null;
    const fcfYield = pfcf ? (1 / pfcf) * 100 : null;

    const peLabel   = `Le P/E de ${pe?.toFixed(2) || '?'} est ${peVs5 != null ? (peVs5 < 0 ? 'inf√©rieur' : 'sup√©rieur') : '?'} √† la moyenne sur 5 ans de ${avgPE5?.toFixed(2) || '?'}`;
    const pfcfLabel = `Le P/FCF de ${pfcf?.toFixed(2) || '?'} est ${pfcfVs5 != null ? (pfcfVs5 < 0 ? 'inf√©rieur' : 'sup√©rieur') : '?'} √† la moyenne sur 5 ans de ${avgPFCF5?.toFixed(2) || '?'}`;
    const psLabel   = `Le P/S de ${ps?.toFixed(2) || '?'} est ${psVs5 != null ? (psVs5 < 0 ? 'inf√©rieur' : 'sup√©rieur') : '?'} √† la moyenne sur 5 ans de ${avgPS5?.toFixed(2) || '?'}`;

    const metrics = [
        { label: peLabel,            value: peVs5,    format: 'pct',   score: scoreByThreshold(peVs5,   [-30, -10, 10, 30], false) },
        { label: pfcfLabel,          value: pfcfVs5,  format: 'pct',   score: scoreByThreshold(pfcfVs5, [-30, -10, 10, 30], false) },
        { label: psLabel,            value: psVs5,    format: 'pct',   score: scoreByThreshold(psVs5,   [-30, -10, 10, 30], false) },
        { label: 'Prime de risque FCF', value: fcfPrime, format: 'pct', score: scoreByThreshold(fcfPrime, [-2, 0, 2, 5]) },
        { label: 'Rendement FCF',    value: fcfYield, format: 'pct',   score: scoreByThreshold(fcfYield, [1, 2, 4, 7]) },
    ];

    return buildCategory('√âvaluation', 'üí∞', metrics);
}

function buildCategory(name, icon, metrics) {
    const scores = metrics.filter(m => m.score != null).map(m => m.score);
    const categoryScore = scores.length ? avgArr(scores) : null;
    return { name, icon, score: categoryScore, metrics };
}

function computeAllScores(data) {
    const categories = [
        scoreRentabilite(data),
        scoreGestion(data),
        scoreCroissance(data),
        scoreSanteFinanciere(data),
        scoreAnalyste(data),
        scoreEvaluation(data),
    ];
    const valid = categories.filter(c => c.score != null);
    const globalScore = valid.length ? avgArr(valid.map(c => c.score)) : null;
    return { globalScore, categories };
}

// ‚îÄ‚îÄ Score badge color helper for top badge ‚îÄ‚îÄ
function calculateScore(metrics, ratios) {
    // kept for backward compat ‚Äî now replaced by computeAllScores
    return '‚Äî';
}

// ‚îÄ‚îÄ Pagination state ‚îÄ‚îÄ
const _scorePages = {};
const SCORE_PAGE_SIZE = 5;

function scorePageGo(id, delta) {
    if (!_scorePages[id]) return;
    const state = _scorePages[id];
    const maxPage = Math.ceil(state.metrics.length / SCORE_PAGE_SIZE) - 1;
    state.page = Math.max(0, Math.min(maxPage, state.page + delta));
    _updateScorePage(id);
}

function _updateScorePage(id) {
    const state  = _scorePages[id];
    const start  = state.page * SCORE_PAGE_SIZE;
    const end    = Math.min(start + SCORE_PAGE_SIZE, state.metrics.length);
    const total  = Math.ceil(state.metrics.length / SCORE_PAGE_SIZE);
    const tbody  = document.getElementById('stbody-' + id);
    const lbl    = document.getElementById('spglbl-' + id);
    const cnt    = document.getElementById('spcnt-'  + id);
    if (tbody) tbody.innerHTML = _buildMetricRows(state.metrics, start, SCORE_PAGE_SIZE);
    if (lbl)   lbl.textContent = `Page ${state.page + 1} sur ${total}`;
    if (cnt)   cnt.textContent = `Affichage de ${start + 1} √† ${end} sur ${state.metrics.length}`;
}

function _buildMetricRows(metrics, startIdx, pageSize) {
    return metrics.slice(startIdx, startIdx + pageSize).map(m => {
        const lbl = getScoreLabel(m.score);
        const pill = `<span class="sc-pill" style="background:${lbl.bg};color:${lbl.color};">${lbl.label}</span>`;
        const val  = m.value != null ? (m.format === 'pct' ? m.value.toFixed(2) + '%' : m.value.toFixed(2)) : 'N/A';
        return `<tr class="sc-row"><td class="sc-td-m"><span class="sc-icon">‚ìò</span>${m.label}</td><td class="sc-td-v">${val}</td><td class="sc-td-s">${pill}</td></tr>`;
    }).join('');
}

function _buildCategoryCard(cat) {
    const id  = cat.name.replace(/[^a-z]/gi, '').toLowerCase() + 'card';
    const lbl = getScoreLabel(cat.score);
    const scoreStr = cat.score != null ? cat.score.toFixed(2) : '‚Äî';
    _scorePages[id] = { page: 0, metrics: cat.metrics };

    const totalPages = Math.ceil(cat.metrics.length / SCORE_PAGE_SIZE);
    const showCount  = Math.min(SCORE_PAGE_SIZE, cat.metrics.length);

    return `
    <div class="sc-card">
        <div class="sc-card-header">
            <div>
                <div class="sc-card-title">${cat.icon} ${cat.name}</div>
                <div class="sc-card-sub">Cliquez sur n'importe quelle m√©trique pour une analyse approfondie</div>
            </div>
            <div class="sc-badge" style="background:${lbl.bg};color:${lbl.color};border-color:${lbl.color};">${scoreStr}</div>
        </div>
        <table class="sc-table">
            <thead><tr>
                <th class="sc-th sc-th-m">‚ö° M√©trique</th>
                <th class="sc-th sc-th-v">Valeur</th>
                <th class="sc-th sc-th-s">üöÄ Score de perspicacit√©</th>
            </tr></thead>
            <tbody id="stbody-${id}">${_buildMetricRows(cat.metrics, 0, SCORE_PAGE_SIZE)}</tbody>
        </table>
        <div class="sc-pagination">
            <button class="sc-pg-btn" onclick="scorePageGo('${id}',-1)">‚óÄ Pr√©c√©dent</button>
            <span id="spglbl-${id}" class="sc-pg-lbl">Page 1 sur ${totalPages}</span>
            <button class="sc-pg-btn" onclick="scorePageGo('${id}',1)">Suivant ‚ñ∂</button>
            <span id="spcnt-${id}" class="sc-pg-cnt">Affichage de 1 √† ${showCount} sur ${cat.metrics.length}</span>
        </div>
    </div>`;
}

function _buildDonutSVG(globalScore, categories) {
    const SZ = 170, CX = 85, CY = 85, R = 65;
    const count = categories.length;
    const segDeg = 360 / count;
    const GAP = 3;
    let paths = '';

    function polar(cx, cy, r, deg) {
        const rad = (deg * Math.PI) / 180;
        return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
    }
    function arc(cx, cy, r, s, e) {
        const p1 = polar(cx, cy, r, s), p2 = polar(cx, cy, r, e);
        return `M ${p1.x} ${p1.y} A ${r} ${r} 0 ${(e - s) > 180 ? 1 : 0} 1 ${p2.x} ${p2.y}`;
    }

    categories.forEach((cat, i) => {
        const lbl  = getScoreLabel(cat.score);
        const fill = cat.score != null ? (cat.score - 1) / 4 : 0.08;
        const sA   = i * segDeg - 90 + GAP / 2;
        const eA   = sA + segDeg - GAP;
        const fillEnd = sA + (segDeg - GAP) * fill;
        paths += `<path d="${arc(CX, CY, R, sA, eA)}" fill="none" stroke="var(--border-color)" stroke-width="14" stroke-linecap="butt"/>`;
        if (fill > 0.01) {
            paths += `<path d="${arc(CX, CY, R, sA, fillEnd)}" fill="none" stroke="${lbl.color}" stroke-width="14" stroke-linecap="butt"/>`;
        }
    });

    const gl = getScoreLabel(globalScore);
    const gs = globalScore != null ? globalScore.toFixed(2) : '‚Äî';
    return `<svg width="${SZ}" height="${SZ}" viewBox="0 0 ${SZ} ${SZ}">
        ${paths}
        <text x="${CX}" y="${CY - 10}" text-anchor="middle" style="fill:${gl.color};font-size:26px;font-weight:800;font-family:Inter,sans-serif;">${gs}</text>
        <text x="${CX}" y="${CY + 14}" text-anchor="middle" style="fill:${gl.color};font-size:12px;font-weight:600;font-family:Inter,sans-serif;">${gl.label}</text>
    </svg>`;
}

function renderScoresTab(result) {
    const { globalScore, categories } = result;
    const gl = getScoreLabel(globalScore);

    // Update top score badge color
    const scoreValueEl = document.getElementById('scoreValue');
    if (scoreValueEl) {
        scoreValueEl.textContent = globalScore != null ? `${globalScore.toFixed(2)}/5` : 'N/A';
        scoreValueEl.style.color = gl.color;
    }

    const donut   = _buildDonutSVG(globalScore, categories);
    const breakdown = categories.map(cat => {
        const l = getScoreLabel(cat.score);
        return `<div class="sc-breakdown-item"><span class="sc-dot" style="background:${l.color};"></span>${cat.name} ‚Äî <strong style="color:${l.color}">${cat.score != null ? cat.score.toFixed(2) : 'N/A'}</strong></div>`;
    }).join('');

    const cards = categories.map(_buildCategoryCard).join('');

    document.getElementById('scores-content').innerHTML = `
    <style>
        .sc-global { display:flex; align-items:center; gap:28px; background:var(--bg-topbar); border:1px solid var(--border-color); border-radius:14px; padding:28px 32px; margin-bottom:28px; flex-wrap:wrap; }
        .sc-breakdown { display:flex; flex-wrap:wrap; gap:10px 24px; flex:1; }
        .sc-breakdown-item { display:flex; align-items:center; gap:8px; font-size:0.9rem; font-weight:500; color:var(--text-secondary); }
        .sc-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
        .sc-global-right { text-align:right; }
        .sc-global-num { font-size:3.2rem; font-weight:800; line-height:1; }
        .sc-global-lbl { font-size:1rem; font-weight:600; margin-top:4px; }
        .sc-grid { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
        @media(max-width:860px) { .sc-grid { grid-template-columns:1fr; } .sc-global { flex-direction:column; text-align:center; } }
        .sc-card { background:var(--bg-topbar); border:1px solid var(--border-color); border-radius:14px; padding:24px; }
        .sc-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:18px; gap:16px; }
        .sc-card-title { font-size:1.25rem; font-weight:700; color:var(--text-primary); margin-bottom:4px; }
        .sc-card-sub { font-size:0.78rem; color:var(--text-secondary); }
        .sc-badge { min-width:58px; height:58px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:1.45rem; font-weight:800; border-width:2px; border-style:solid; flex-shrink:0; }
        .sc-table { width:100%; border-collapse:collapse; }
        .sc-th { font-size:0.8rem; color:var(--text-secondary); font-weight:600; padding:10px 12px; border-bottom:1px solid var(--border-color); text-align:left; white-space:nowrap; }
        .sc-th-v, .sc-th-s { text-align:right; }
        .sc-row { border-bottom:1px solid var(--border-color); transition:background 0.12s; }
        .sc-row:hover { background:var(--hover-bg); cursor:pointer; }
        .sc-row:last-child { border-bottom:none; }
        .sc-td-m { padding:12px; font-size:0.86rem; color:var(--text-primary); display:flex; align-items:flex-start; gap:8px; }
        .sc-td-v { padding:12px; text-align:right; font-weight:600; font-size:0.86rem; white-space:nowrap; }
        .sc-td-s { padding:12px; text-align:right; white-space:nowrap; }
        .sc-icon { color:var(--text-secondary); font-size:0.85rem; flex-shrink:0; margin-top:1px; }
        .sc-pill { display:inline-block; padding:4px 14px; border-radius:6px; font-weight:600; font-size:0.82rem; }
        .sc-pagination { display:flex; align-items:center; gap:12px; padding-top:14px; margin-top:4px; border-top:1px solid var(--border-color); flex-wrap:wrap; }
        .sc-pg-btn { padding:6px 14px; background:var(--hover-bg); border:1px solid var(--border-color); border-radius:8px; color:var(--text-primary); font-weight:600; font-size:0.8rem; cursor:pointer; transition:all 0.15s; }
        .sc-pg-btn:hover { background:var(--primary-orange); color:#fff; border-color:var(--primary-orange); }
        .sc-pg-lbl { font-size:0.84rem; font-weight:600; color:var(--text-primary); }
        .sc-pg-cnt { font-size:0.8rem; color:var(--text-secondary); margin-left:auto; }
    </style>

    <div class="sc-global">
        <div>${donut}</div>
        <div class="sc-breakdown">${breakdown}</div>
        <div class="sc-global-right">
            <div class="sc-global-num" style="color:${gl.color};">${globalScore != null ? globalScore.toFixed(2) : '‚Äî'}</div>
            <div class="sc-global-lbl" style="color:${gl.color};">${gl.label}</div>
            <div style="font-size:0.78rem;color:var(--text-secondary);margin-top:6px;">Score global /5</div>
        </div>
    </div>

    <div class="sc-grid">${cards}</div>`;
}



window.scorePageGo = scorePageGo;



    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import fmpAPI from './fmp-api.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD4dkPbO1C-bZiSokalUnwNqOTpeAyrOU0",
            authDomain: "stockmaster-30835.firebaseapp.com",
            projectId: "stockmaster-30835",
            storageBucket: "stockmaster-30835.firebasestorage.app",
            messagingSenderId: "506097874613",
            appId: "1:506097874613:web:0d15d2bd1575a55c8ab0fc",
            measurementId: "G-2PG7Q471TR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                document.querySelector('.user-avatar').textContent = user.email.charAt(0).toUpperCase();
            }
        });

        // User menu
        const userAvatar = document.getElementById('userAvatar');
        const dropdownMenu = document.getElementById('dropdownMenu');
        userAvatar.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('active');
        });
        document.addEventListener('click', (e) => {
            if (!userAvatar.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.remove('active');
            }
        });

        document.getElementById('signOutBtn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = "index.html";
        });

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const html = document.documentElement;
        const currentTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', currentTheme);
        if (currentTheme === 'dark') {
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
        }
        themeToggle.addEventListener('click', () => {
            const newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (newTheme === 'dark') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        });

        // ============================================================
        // STATE
        // ============================================================
        let currentSymbol = null;
        let currentPeriod = 'annual'; // annual | quarterly | ttm
        let currentFinTab = 'income';
        let cachedData = {}; // { annual: {...}, quarterly: {...} }

        // ============================================================
        // SEARCH
        // ============================================================
        const stockSearch = document.getElementById('stockSearch');
        const searchResults = document.getElementById('searchResults');
        const searchView = document.getElementById('searchView');
        const stockDetailsView = document.getElementById('stockDetailsView');
        const backBtn = document.getElementById('backBtn');
        let searchTimeout;

        stockSearch.addEventListener('input', async (e) => {
            const query = e.target.value.trim().toUpperCase();
            if (query.length < 1) { searchResults.classList.remove('active'); return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    searchResults.innerHTML = '<div class="search-result-item"><span class="result-symbol">Searching...</span></div>';
                    searchResults.classList.add('active');
                    const results = await fmpAPI.searchStocks(query);
                    if (results && results.length > 0) {
                        const stocks = results.filter(r => {
                            const exch = (r.exchangeShortName || r.exchange || '').toUpperCase();
                            return exch.includes('NASDAQ') || exch.includes('NYSE') || exch.includes('AMEX');
                        }).slice(0, 8);
                        if (stocks.length > 0) {
                            const symbols = stocks.map(s => s.symbol).join(',');
                            const quotes = await fmpAPI.getQuote(symbols);
                            const quotesMap = {};
                            if (quotes) quotes.forEach(q => quotesMap[q.symbol] = q);
                            searchResults.innerHTML = stocks.map(stock => {
                                const quote = quotesMap[stock.symbol];
                                const price = quote?.price || 'N/A';
                                const priceDisplay = typeof price === 'number' ? `$${price.toFixed(2)}` : price;
                                return `<div class="search-result-item" data-symbol="${stock.symbol}">
                                    <div><span class="result-symbol">${stock.symbol}</span><span class="result-name">${stock.name || stock.companyName || ''}</span></div>
                                    <span style="font-weight:700;">${priceDisplay}</span>
                                </div>`;
                            }).join('');
                            searchResults.classList.add('active');
                            document.querySelectorAll('.search-result-item').forEach(item => {
                                item.addEventListener('click', async () => {
                                    const symbol = item.dataset.symbol;
                                    await showStockDetails(symbol);
                                    searchResults.classList.remove('active');
                                    stockSearch.value = '';
                                });
                            });
                        } else {
                            searchResults.innerHTML = '<div class="search-result-item">No stocks found</div>';
                        }
                    } else {
                        searchResults.innerHTML = '<div class="search-result-item">No results</div>';
                    }
                } catch (error) {
                    searchResults.innerHTML = '<div class="search-result-item">Search error</div>';
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!stockSearch.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.remove('active');
            }
        });

        // ============================================================
        // SHOW STOCK DETAILS
        // ============================================================
        async function showStockDetails(symbol) {
            try {
                currentSymbol = symbol;
                cachedData = {};
                searchView.style.display = 'none';
                stockDetailsView.classList.add('active');
                document.getElementById('stockLogo').textContent = symbol.substring(0, 3);
                document.getElementById('stockFullName').textContent = 'Loading...';

                // Single batch call ‚Äî fetches everything needed (quote, ratios, metrics, income, balance, cashflow, ratiosHistory)
                const data = await fmpAPI.getFullScreenerData(symbol);
                cachedData['annual'] = data;

                if (data.profile) {
                    document.getElementById('stockLogo').textContent = data.profile.symbol.substring(0, 3);
                    document.getElementById('stockFullName').textContent = data.profile.companyName || symbol;
                    document.getElementById('stockSymbol').textContent = `${data.profile.symbol} - ${data.profile.sector || 'N/A'}`;
                }
                if (data.quote) {
                    document.getElementById('currentPrice').textContent = `$${data.quote.price.toFixed(2)}`;
                    const change = data.quote.change || 0;
                    const changePercent = data.quote.changesPercentage || 0;
                    const priceChangeEl = document.getElementById('priceChange');
                    if (change >= 0) {
                        priceChangeEl.className = 'price-change positive';
                        priceChangeEl.textContent = `‚Üë $${Math.abs(change).toFixed(2)} (+${Math.abs(changePercent).toFixed(2)}%)`;
                    } else {
                        priceChangeEl.className = 'price-change negative';
                        priceChangeEl.textContent = `‚Üì $${Math.abs(change).toFixed(2)} (-${Math.abs(changePercent).toFixed(2)}%)`;
                    }
                }
                // Compute full scores
                const scoreResult = computeAllScores(data);
                const globalScore = scoreResult.globalScore;
                document.getElementById('scoreValue').textContent = globalScore != null ? `${globalScore.toFixed(2)}/5` : 'N/A';
                renderScoresTab(scoreResult);

                updateGeneralTab(data);
                renderAllFinancialTables(data, 'annual');
                updateDividendsTab(data);

                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading stock details:', error);
                alert('Error loading data.');
                backBtn.click();
            }
        }

        // ============================================================
        // PERIOD TOGGLE LOGIC
        // ============================================================
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const period = btn.dataset.period;
                if (period === currentPeriod) return;
                currentPeriod = period;

                document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (!currentSymbol) return;

                if (!cachedData[period]) {
                    // Show loading state on current visible table
                    const activeTable = document.querySelector(`#fin-${currentFinTab} tbody`);
                    if (activeTable) activeTable.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-secondary);">‚è≥ Loading...</td></tr>';

                    try {
                        // One single batch call ‚Äî all quarterly data at once
                        cachedData[period] = await fmpAPI.getFullScreenerDataQuarterly(currentSymbol);
                    } catch(e) {
                        console.error('Error fetching quarterly data:', e);
                        if (activeTable) activeTable.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--danger-color);">Loading error</td></tr>';
                        return;
                    }
                }

                renderAllFinancialTables(cachedData[period], period);
            });
        });

        // ============================================================
        // FINANCIALS SUB-TABS
        // ============================================================
        document.querySelectorAll('.fin-sub-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const fin = btn.dataset.fin;
                currentFinTab = fin;

                document.querySelectorAll('.fin-sub-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.querySelectorAll('.fin-content').forEach(c => c.style.display = 'none');
                document.getElementById(`fin-${fin}`).style.display = 'block';
            });
        });

        // ============================================================
        // RENDER ALL FINANCIAL TABLES
        // ============================================================
        function renderAllFinancialTables(data, period) {
            renderIncomeTable(data, period);
            renderBalanceTable(data, period);
            renderCashflowTable(data, period);
            renderRatiosTable(data, period);
            renderKPIsTable(data, period);
        }

        function periodLabel(item, period) {
            if (!item?.date) return 'N/A';
            const d = new Date(item.date);
            if (period === 'quarterly') {
                const q = Math.floor(d.getMonth() / 3) + 1;
                return `Q${q} ${d.getFullYear()}`;
            }
            return 'FY ' + d.getFullYear();
        }

        // ============================================================
        // INCOME STATEMENT
        // ============================================================
        function renderIncomeTable(data, period) {
            if (!data.income || data.income.length === 0) {
                document.querySelector('#incomeTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-secondary);">Data unavailable</td></tr>';
                return;
            }
            const limit = period === 'quarterly' ? 8 : 5;
            const years = data.income.slice(0, limit);
            const thead = document.querySelector('#incomeTable thead tr');
            const tbody = document.querySelector('#incomeTable tbody');
            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;

            const rows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: 'Revenue', key: 'revenue', bold: true },
                { label: 'Revenue Growth (YoY)', key: '_revGrowth', isGrowth: true, indent: true },
                { label: 'Cost of Revenue', key: 'costOfRevenue' },
                { label: 'Gross Profit', key: 'grossProfit', bold: true },
                { label: 'Selling, General & Admin', key: 'sellingGeneralAndAdministrativeExpenses', indent: true },
                { label: 'Research & Development', key: 'researchAndDevelopmentExpenses', indent: true },
                { label: 'Other Operating Expenses', key: 'otherExpenses', indent: true },
                { label: 'Operating Expenses', key: 'operatingExpenses', bold: true },
                { label: 'Operating Income', key: 'operatingIncome', bold: true },
                { label: 'Interest Expense', key: 'interestExpense' },
                { label: 'Interest & Investment Income', key: 'interestIncome' },
                { label: 'Currency Exchange Gain (Loss)', key: 'otherNonOperatingIncome' },
                { label: 'EBT Excluding Unusual Items', key: 'incomeBeforeTax', bold: true },
                { label: 'Pretax Income', key: 'incomeBeforeTax', bold: true },
                { label: 'Income Tax Expense', key: 'incomeTaxExpense' },
                { label: 'Net Income', key: 'netIncome', bold: true },
                { label: 'Net Income Growth', key: '_netIncGrowth', isGrowth: true, indent: true },
                { label: 'Shares Outstanding (Basic)', key: 'weightedAverageSharesOut' },
                { label: 'Shares Outstanding (Diluted)', key: 'weightedAverageSharesOutDil', bold: true },
                { label: 'Shares Change (YoY)', key: '_sharesGrowth', isGrowth: true, indent: true },
                { label: 'EPS (Basic)', key: 'eps' },
                { label: 'EPS (Diluted)', key: 'epsdiluted', bold: true },
                { label: 'EPS Growth', key: '_epsGrowth', isGrowth: true, indent: true },
                { label: 'Free Cash Flow', key: '_fcf' },
                { label: 'Free Cash Flow Per Share', key: '_fcfPerShare' },
                { label: 'Gross Margin', key: '_grossMargin', isPercent: true },
                { label: 'Operating Margin', key: '_opMargin', isPercent: true },
                { label: 'Profit Margin', key: '_netMargin', isPercent: true },
                { label: 'EBITDA', key: 'ebitda', bold: true },
                { label: 'EBITDA Margin', key: '_ebitdaMargin', isPercent: true, indent: true },
                { label: 'D&A For EBITDA', key: 'depreciationAndAmortization', indent: true },
                { label: 'EBIT', key: 'operatingIncome', bold: true },
                { label: 'Effective Tax Rate', key: '_taxRate', isPercent: true },
            ];

            tbody.innerHTML = buildTableRows(rows, years, data.cashflow);
        }

        // ============================================================
        // BALANCE SHEET
        // ============================================================
        function renderBalanceTable(data, period) {
            if (!data.balance || data.balance.length === 0) {
                document.querySelector('#balanceTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-secondary);">Data unavailable</td></tr>';
                return;
            }
            const limit = period === 'quarterly' ? 8 : 5;
            const years = data.balance.slice(0, limit);
            const thead = document.querySelector('#balanceTable thead tr');
            const tbody = document.querySelector('#balanceTable tbody');
            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;

            const rows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: '‚Äî ASSETS ‚Äî', isSection: true },
                { label: 'Cash & Equivalents', key: 'cashAndCashEquivalents' },
                { label: 'Short-Term Investments', key: 'shortTermInvestments' },
                { label: 'Cash & Short-Term Investments', key: 'cashAndShortTermInvestments', bold: true },
                { label: 'Cash Growth', key: '_cashGrowth', isGrowth: true, indent: true },
                { label: 'Accounts Receivable', key: 'netReceivables' },
                { label: 'Receivables', key: 'netReceivables', bold: true },
                { label: 'Inventory', key: 'inventory' },
                { label: 'Prepaid Expenses', key: 'otherCurrentAssets' },
                { label: 'Total Current Assets', key: 'totalCurrentAssets', bold: true },
                { label: 'Property, Plant & Equipment', key: 'propertyPlantEquipmentNet' },
                { label: 'Long-Term Investments', key: 'longTermInvestments' },
                { label: 'Goodwill', key: 'goodwill' },
                { label: 'Other Intangible Assets', key: 'intangibleAssets' },
                { label: 'Other Long-Term Assets', key: 'otherNonCurrentAssets' },
                { label: 'Total Assets', key: 'totalAssets', bold: true },
                { label: '‚Äî LIABILITIES ‚Äî', isSection: true },
                { label: 'Accounts Payable', key: 'accountPayables' },
                { label: 'Accrued Expenses', key: 'otherCurrentLiabilities' },
                { label: 'Short-Term Debt', key: 'shortTermDebt' },
                { label: 'Current Portion of Long-Term Debt', key: 'shortTermDebt' },
                { label: 'Total Current Liabilities', key: 'totalCurrentLiabilities', bold: true },
                { label: 'Long-Term Debt', key: 'longTermDebt' },
                { label: 'Other Long-Term Liabilities', key: 'otherNonCurrentLiabilities' },
                { label: 'Total Liabilities', key: 'totalLiabilities', bold: true },
                { label: '‚Äî EQUITY ‚Äî', isSection: true },
                { label: 'Additional Paid-In Capital', key: 'additionalPaidInCapital' },
                { label: 'Retained Earnings', key: 'retainedEarnings' },
                { label: 'Treasury Stock', key: 'treasuryStock' },
                { label: 'Total Common Equity', key: 'totalStockholdersEquity', bold: true },
                { label: "Shareholders' Equity", key: 'totalStockholdersEquity', bold: true },
                { label: 'Total Liabilities & Equity', key: 'totalLiabilitiesAndStockholdersEquity' },
                { label: 'Total Debt', key: 'totalDebt' },
                { label: 'Net Cash (Debt)', key: '_netCash', bold: true },
                { label: 'Net Cash Per Share', key: '_netCashPerShare' },
                { label: 'Filing Date Shares Outstanding', key: '_shares' },
                { label: 'Total Common Shares Outstanding', key: '_shares', bold: true },
                { label: 'Working Capital', key: '_workingCapital' },
                { label: 'Book Value Per Share', key: '_bookValuePS' },
                { label: 'Tangible Book Value', key: '_tangibleBV' },
                { label: 'Tangible Book Value Per Share', key: '_tangibleBVPS' },
            ];

            tbody.innerHTML = buildTableRows(rows, years, null);
        }

        // ============================================================
        // CASH FLOW
        // ============================================================
        function renderCashflowTable(data, period) {
            if (!data.cashflow || data.cashflow.length === 0) {
                document.querySelector('#cashflowTable tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-secondary);">Data unavailable</td></tr>';
                return;
            }
            const limit = period === 'quarterly' ? 8 : 5;
            const years = data.cashflow.slice(0, limit);
            const thead = document.querySelector('#cashflowTable thead tr');
            const tbody = document.querySelector('#cashflowTable tbody');
            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;

            const rows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: '‚Äî OPERATING ACTIVITIES ‚Äî', isSection: true },
                { label: 'Net Income', key: 'netIncome' },
                { label: 'Depreciation & Amortization', key: 'depreciationAndAmortization' },
                { label: 'Loss (Gain) on Equity Investments', key: 'deferredIncomeTax' },
                { label: 'Stock-Based Compensation', key: 'stockBasedCompensation' },
                { label: 'Provision & Write-off of Bad Debts', key: 'otherWorkingCapital' },
                { label: 'Other Operating Activities', key: 'otherNonCashItems' },
                { label: 'Change in Accounts Receivable', key: 'changeInWorkingCapital' },
                { label: 'Change in Inventory', key: 'inventory' },
                { label: 'Change in Accounts Payable', key: 'accountsPayables' },
                { label: 'Change in Other Net Operating Assets', key: 'otherWorkingCapital' },
                { label: 'Operating Cash Flow', key: 'operatingCashFlow', bold: true },
                { label: 'Operating Cash Flow Growth', key: '_ocfGrowth', isGrowth: true, indent: true },
                { label: '‚Äî INVESTING ACTIVITIES ‚Äî', isSection: true },
                { label: 'Capital Expenditures', key: 'capitalExpenditure' },
                { label: 'Cash Acquisitions', key: 'acquisitionsNet' },
                { label: 'Sale (Purchase) of Intangibles', key: 'salePurchaseOfStock' },
                { label: 'Investment in Securities', key: 'purchasesOfInvestments' },
                { label: 'Other Investing Activities', key: 'otherInvestingActivites' },
                { label: 'Investing Cash Flow', key: 'investingCashFlow', bold: true },
                { label: '‚Äî FINANCING ACTIVITIES ‚Äî', isSection: true },
                { label: 'Long-Term Debt Issued', key: 'longTermDebtIssued' },
                { label: 'Long-Term Debt Repaid', key: 'longTermDebtRepaid' },
                { label: 'Net Debt Issued (Repaid)', key: 'debtRepayment' },
                { label: 'Issuance of Common Stock', key: 'commonStockIssued' },
                { label: 'Repurchase of Common Stock', key: 'commonStockRepurchased' },
                { label: 'Other Financing Activities', key: 'otherFinancingActivites' },
                { label: 'Financing Cash Flow', key: 'financingCashFlow', bold: true },
                { label: 'Foreign Exchange Rate Adjustment', key: 'effectOfForexChangesOnCash' },
                { label: 'Net Cash Flow', key: 'netChangeInCash', bold: true },
                { label: 'Free Cash Flow', key: 'freeCashFlow', bold: true },
                { label: 'Free Cash Flow Growth', key: '_fcfGrowth', isGrowth: true, indent: true },
                { label: 'Free Cash Flow Margin', key: '_fcfMargin', isPercent: true, indent: true },
                { label: 'Free Cash Flow Per Share', key: '_fcfPerShare', indent: true },
                { label: 'Cash Interest Paid', key: 'interestPaid' },
                { label: 'Cash Income Tax Paid', key: 'incomeTaxesPaid' },
                { label: 'Levered Free Cash Flow', key: '_fcf' },
                { label: 'Change in Working Capital', key: 'changeInWorkingCapital' },
            ];

            tbody.innerHTML = buildTableRows(rows, years, null, data.income || []);
        }

        // ============================================================
        // RATIOS
        // ============================================================
        function renderRatiosTable(data, period) {
            // For ratios we use ratiosHistory (annual) or ratios (TTM fallback)
            const ratiosData = data.ratiosHistory || [];
            const limit = period === 'quarterly' ? 8 : 5;
            const years = ratiosData.slice(0, limit);
            const thead = document.querySelector('#ratiosTable thead tr');
            const tbody = document.querySelector('#ratiosTable tbody');

            if (years.length === 0) {
                // Fallback: single TTM column from ratios-ttm
                const r = data.ratios || {};
                const q = data.quote || {};
                const p = data.profile || {};
                thead.innerHTML = `<th>Metric</th><th>Current</th>`;
                const rows = [
                    ['Market Capitalization', formatLarge(p.mktCap)],
                    ['Last Close Price', q.price ? `$${q.price.toFixed(2)}` : 'N/A'],
                    ['PE Ratio', r.priceEarningsRatioTTM?.toFixed(2) || 'N/A'],
                    ['Forward PE', 'N/A'],
                    ['PS Ratio', r.priceToSalesRatioTTM?.toFixed(2) || 'N/A'],
                    ['PB Ratio', r.priceToBookRatioTTM?.toFixed(2) || 'N/A'],
                    ['P/FCF Ratio', r.priceToFreeCashFlowsRatioTTM?.toFixed(2) || 'N/A'],
                    ['P/OCF Ratio', r.priceToOperatingCashFlowsRatioTTM?.toFixed(2) || 'N/A'],
                    ['PEG Ratio', r.priceEarningsToGrowthRatioTTM?.toFixed(2) || 'N/A'],
                    ['EV/Sales Ratio', r.enterpriseValueOverEBITDATTM?.toFixed(2) || 'N/A'],
                    ['EV/EBITDA Ratio', r.enterpriseValueMultipleTTM?.toFixed(2) || 'N/A'],
                    ['Debt / Equity Ratio', r.debtEquityRatioTTM?.toFixed(2) || 'N/A'],
                    ['Debt / EBITDA Ratio', r.debtToEquityTTM?.toFixed(2) || 'N/A'],
                    ['Net Debt / Equity Ratio', 'N/A'],
                    ['Net Debt / EBITDA Ratio', 'N/A'],
                    ['Asset Turnover', r.assetTurnoverTTM?.toFixed(2) || 'N/A'],
                    ['Inventory Turnover', r.inventoryTurnoverTTM?.toFixed(2) || 'N/A'],
                    ['Quick Ratio', r.quickRatioTTM?.toFixed(2) || 'N/A'],
                    ['Current Ratio', r.currentRatioTTM?.toFixed(2) || 'N/A'],
                    ['Return on Equity (ROE)', r.returnOnEquityTTM ? (r.returnOnEquityTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['Return on Assets (ROA)', r.returnOnAssetsTTM ? (r.returnOnAssetsTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['Return on Invested Capital (ROIC)', r.roicTTM ? (r.roicTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['Return on Capital Employed (ROCE)', 'N/A'],
                    ['Earnings Yield', r.earningsYieldTTM ? (r.earningsYieldTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['FCF Yield', r.freeCashFlowYieldTTM ? (r.freeCashFlowYieldTTM * 100).toFixed(2) + '%' : 'N/A'],
                    ['Buyback Yield / Dilution', 'N/A'],
                    ['Total Shareholder Return', 'N/A'],
                ];
                tbody.innerHTML = rows.map(([label, value]) => `<tr><td>${label}</td><td>${value}</td></tr>`).join('');
                return;
            }

            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;
            const ratioRows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: 'Market Capitalization', key: 'marketCapitalization' },
                { label: 'Last Close Price', key: 'stockPrice' },
                { label: 'PE Ratio', key: 'priceEarningsRatio', bold: true },
                { label: 'Forward PE', key: 'priceEarningsRatio' },
                { label: 'PS Ratio', key: 'priceToSalesRatio' },
                { label: 'PB Ratio', key: 'priceToBookRatio' },
                { label: 'P/FCF Ratio', key: 'priceToFreeCashFlowsRatio' },
                { label: 'P/OCF Ratio', key: 'priceToOperatingCashFlowsRatio' },
                { label: 'PEG Ratio', key: 'priceEarningsToGrowthRatio' },
                { label: 'EV/Sales Ratio', key: 'enterpriseValueOverEBITDA' },
                { label: 'EV/EBITDA Ratio', key: 'enterpriseValueMultiple' },
                { label: 'Debt / Equity Ratio', key: 'debtEquityRatio' },
                { label: 'Debt / EBITDA Ratio', key: 'debtToEquity' },
                { label: 'Net Debt / Equity Ratio', key: 'netDebtToEquity' },
                { label: 'Net Debt / EBITDA Ratio', key: 'netDebtToEBITDA' },
                { label: 'Asset Turnover', key: 'assetTurnover' },
                { label: 'Inventory Turnover', key: 'inventoryTurnover' },
                { label: 'Quick Ratio', key: 'quickRatio' },
                { label: 'Current Ratio', key: 'currentRatio' },
                { label: 'Return on Equity (ROE)', key: 'returnOnEquity', isPercent: true },
                { label: 'Return on Assets (ROA)', key: 'returnOnAssets', isPercent: true },
                { label: 'Return on Invested Capital (ROIC)', key: 'returnOnCapitalEmployed', isPercent: true },
                { label: 'Earnings Yield', key: 'earningsYield', isPercent: true },
                { label: 'FCF Yield', key: 'freeCashFlowYield', isPercent: true },
            ];
            tbody.innerHTML = buildTableRows(ratioRows, years, null);
        }

        // ============================================================
        // KPIs
        // ============================================================
        function renderKPIsTable(data, period) {
            const limit = period === 'quarterly' ? 8 : 5;
            const years = (data.income || []).slice(0, limit);
            const thead = document.querySelector('#kpisTable thead tr');
            const tbody = document.querySelector('#kpisTable tbody');
            thead.innerHTML = `<th>Fiscal Year</th>${years.map(y => `<th>${periodLabel(y, period)}</th>`).join('')}`;

            const rows = [
                { label: 'Period Ending', key: '_date', bold: true },
                { label: 'Shares Outstanding (Diluted)', key: 'weightedAverageSharesOutDil', bold: true },
                { label: 'Shares Change (YoY)', key: '_sharesGrowth', isGrowth: true, indent: true },
                { label: 'EPS (Basic)', key: 'eps' },
                { label: 'EPS (Diluted)', key: 'epsdiluted', bold: true },
                { label: 'EPS Growth', key: '_epsGrowth', isGrowth: true, indent: true },
                { label: 'Free Cash Flow', key: '_fcf', bold: true },
                { label: 'Free Cash Flow Per Share', key: '_fcfPerShare', indent: true },
                { label: 'Gross Margin', key: '_grossMargin', isPercent: true },
                { label: 'Operating Margin', key: '_opMargin', isPercent: true },
                { label: 'Profit Margin', key: '_netMargin', isPercent: true },
                { label: 'Free Cash Flow Margin', key: '_fcfMarginIncome', isPercent: true },
                { label: 'EBITDA', key: 'ebitda', bold: true },
                { label: 'EBITDA Margin', key: '_ebitdaMargin', isPercent: true, indent: true },
                { label: 'D&A For EBITDA', key: 'depreciationAndAmortization', indent: true },
                { label: 'EBIT', key: 'operatingIncome', bold: true },
                { label: 'EBIT Margin', key: '_opMargin', isPercent: true, indent: true },
                { label: 'Effective Tax Rate', key: '_taxRate', isPercent: true },
                { label: 'Revenue as Reported', key: 'revenue' },
                { label: 'Advertising Expenses', key: 'sellingGeneralAndAdministrativeExpenses' },
            ];

            tbody.innerHTML = buildTableRows(rows, years, data.cashflow);
        }

        // ============================================================
        // GENERIC TABLE ROW BUILDER
        // ============================================================
        function buildTableRows(rowsConfig, years, cashflowData, incomeDataAux) {
            let html = '';
            const incomeRef = years; // years is income or balance or cashflow data

            rowsConfig.forEach(row => {
                if (row.isSection) {
                    html += `<tr class="row-section"><td colspan="${years.length + 1}">${row.label}</td></tr>`;
                    return;
                }

                let trClass = '';
                if (row.bold) trClass += ' row-bold';
                if (row.indent) trClass += ' row-indent';

                let firstTdStyle = '';
                if (row.indent) firstTdStyle = '';

                html += `<tr class="${trClass}"><td>${row.label}</td>`;

                years.forEach((yearData, index) => {
                    let displayVal = 'N/A';
                    let colorClass = '';

                    if (row.key === '_date') {
                        displayVal = `<strong>${new Date(yearData.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</strong>`;
                    } else if (row.key === '_revGrowth' || row.key === '_netIncGrowth' || row.key === '_epsGrowth' || row.key === '_ocfGrowth' || row.key === '_fcfGrowth' || row.key === '_cashGrowth' || row.key === '_sharesGrowth') {
                        if (index < years.length - 1) {
                            const keyMap = {
                                '_revGrowth': 'revenue', '_netIncGrowth': 'netIncome', '_epsGrowth': 'epsdiluted',
                                '_ocfGrowth': 'operatingCashFlow', '_fcfGrowth': 'freeCashFlow',
                                '_cashGrowth': 'cashAndShortTermInvestments', '_sharesGrowth': 'weightedAverageSharesOutDil'
                            };
                            const k = keyMap[row.key];
                            const curr = yearData[k];
                            const prev = years[index + 1][k];
                            if (curr != null && prev != null && prev !== 0) {
                                const pct = ((curr - prev) / Math.abs(prev)) * 100;
                                displayVal = pct.toFixed(2) + '%';
                                colorClass = pct >= 0 ? 'positive' : 'negative';
                            }
                        }
                    } else if (row.key === '_grossMargin') {
                        const v = yearData.revenue ? (yearData.grossProfit / yearData.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_opMargin') {
                        const v = yearData.revenue ? (yearData.operatingIncome / yearData.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_netMargin') {
                        const v = yearData.revenue ? (yearData.netIncome / yearData.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_ebitdaMargin') {
                        const v = yearData.revenue && yearData.ebitda ? (yearData.ebitda / yearData.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_taxRate') {
                        const v = yearData.incomeBeforeTax ? (yearData.incomeTaxExpense / yearData.incomeBeforeTax) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_fcf') {
                        // From cashflow if available
                        const cf = cashflowData ? cashflowData[index] : yearData;
                        const v = cf?.freeCashFlow;
                        if (v != null) displayVal = formatMillion(v);
                    } else if (row.key === '_fcfPerShare') {
                        const cf = cashflowData ? cashflowData[index] : yearData;
                        const incRef = incomeDataAux ? incomeDataAux[index] : yearData;
                        const shares = (incRef?.weightedAverageSharesOutDil || yearData.weightedAverageSharesOutDil || 0);
                        const fcf = cf?.freeCashFlow;
                        if (fcf != null && shares > 0) displayVal = '$' + (fcf / shares).toFixed(2);
                    } else if (row.key === '_fcfMargin' || row.key === '_fcfMarginIncome') {
                        const cf = cashflowData ? cashflowData[index] : yearData;
                        const incRef = incomeDataAux ? incomeDataAux[index] : yearData;
                        const v = cf?.freeCashFlow && incRef?.revenue ? (cf.freeCashFlow / incRef.revenue) * 100 : null;
                        if (v != null) displayVal = v.toFixed(2) + '%';
                    } else if (row.key === '_netCash') {
                        const cash = yearData.cashAndShortTermInvestments;
                        const debt = yearData.totalDebt;
                        if (cash != null && debt != null) {
                            const v = cash - debt;
                            displayVal = formatMillion(v);
                            colorClass = v >= 0 ? 'positive' : 'negative';
                        }
                    } else if (row.key === '_netCashPerShare') {
                        const cash = yearData.cashAndShortTermInvestments;
                        const debt = yearData.totalDebt;
                        const shares = yearData.commonStock || yearData.totalCommonShares || 0;
                        if (cash != null && debt != null && shares > 0) {
                            const v = (cash - debt) / shares;
                            displayVal = '$' + v.toFixed(2);
                        }
                    } else if (row.key === '_shares') {
                        // FMP balance sheet uses commonStock or totalCommonShares
                        const v = yearData.commonStock || yearData.totalCommonShares || yearData.weightedAverageSharesOutDil;
                        if (v != null) displayVal = (v / 1_000_000).toFixed(2);
                    } else if (row.key === '_workingCapital') {
                        const v = yearData.totalCurrentAssets && yearData.totalCurrentLiabilities
                            ? yearData.totalCurrentAssets - yearData.totalCurrentLiabilities : null;
                        if (v != null) displayVal = formatMillion(v);
                    } else if (row.key === '_bookValuePS') {
                        const bv = yearData.totalStockholdersEquity;
                        const shares = (yearData.commonStock || yearData.totalCommonShares || 0);
                        if (bv != null && shares > 0) displayVal = '$' + (bv / shares).toFixed(2);
                    } else if (row.key === '_tangibleBV') {
                        const gi = (yearData.goodwillAndIntangibleAssets || yearData.goodwill || 0) + (yearData.intangibleAssets || 0);
                        const v = yearData.totalStockholdersEquity != null ? yearData.totalStockholdersEquity - gi : null;
                        if (v != null) displayVal = formatMillion(v);
                    } else if (row.key === '_tangibleBVPS') {
                        const bv = yearData.totalStockholdersEquity;
                        const gi = (yearData.goodwillAndIntangibleAssets || yearData.goodwill || 0) + (yearData.intangibleAssets || 0);
                        const shares = yearData.commonStock || yearData.totalCommonShares || 0;
                        if (bv != null && shares > 0) displayVal = '$' + ((bv - gi) / shares).toFixed(2);
                    } else if (row.isGrowth) {
                        if (index < years.length - 1) {
                            const curr = yearData[row.key];
                            const prev = years[index + 1][row.key];
                            if (curr != null && prev != null && prev !== 0) {
                                const pct = ((curr - prev) / Math.abs(prev)) * 100;
                                displayVal = pct.toFixed(2) + '%';
                                colorClass = pct >= 0 ? 'positive' : 'negative';
                            }
                        }
                    } else if (row.isPercent) {
                        const v = yearData[row.key];
                        if (v != null) displayVal = (v * 100).toFixed(2) + '%';
                    } else {
                        const v = yearData[row.key];
                        if (v != null) {
                            if (row.key === 'eps' || row.key === 'epsdiluted') {
                                displayVal = '$' + v.toFixed(2);
                            } else if (Math.abs(v) < 100) {
                                displayVal = v.toFixed(2);
                            } else {
                                displayVal = formatMillion(v);
                            }
                        }
                    }

                    html += `<td class="${colorClass}">${displayVal}</td>`;
                });

                html += '</tr>';
            });

            return html;
        }

        // ============================================================
        // HELPERS
        // ============================================================
        function formatMillion(v) {
            if (v == null) return 'N/A';
            return (v / 1_000_000).toLocaleString('en-US', { maximumFractionDigits: 0 });
        }

        function formatLarge(v) {
            if (!v) return 'N/A';
            if (v >= 1e12) return `$${(v / 1e12).toFixed(2)}T`;
            if (v >= 1e9) return `$${(v / 1e9).toFixed(2)}B`;
            if (v >= 1e6) return `$${(v / 1e6).toFixed(2)}M`;
            return `$${v.toFixed(2)}`;
        }


        function updateGeneralTab(data) {
            const generalTab = document.getElementById('general-tab');
            const metricsGrid = generalTab.querySelector('.metrics-grid');
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-label">Market Cap</div>
                    <div class="metric-value">${formatLarge(data.profile?.mktCap)}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">P/E (TTM)</div>
                    <div class="metric-value">${data.ratios?.priceEarningsRatioTTM?.toFixed(2) || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Dividend Yield</div>
                    <div class="metric-value">${(data.profile?.lastDiv || 0).toFixed(2)}%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">EPS (TTM)</div>
                    <div class="metric-value">$${data.metrics?.earningsPerShareTTM?.toFixed(2) || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Industry</div>
                    <div class="metric-value" style="font-size: 1.3rem;">${data.profile?.industry || 'N/A'}</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Shares Outstanding</div>
                    <div class="metric-value" style="font-size: 1.3rem;">${data.metrics?.sharesMilTTM ? data.metrics.sharesMilTTM.toFixed(2) + 'M' : 'N/A'}</div>
                </div>
            `;
        }

        async function updateDividendsTab(data) {
            try {
                const dividendData = await fmpAPI.getDividendHistory(data.profile.symbol);
                if (!dividendData || !dividendData.historical || dividendData.historical.length === 0) {
                    document.getElementById('dividendsTableBody').innerHTML = '<tr><td colspan="4">Aucun dividende</td></tr>';
                    return;
                }
                const recent = dividendData.historical.slice(0, 5);
                document.getElementById('dividendsTableBody').innerHTML = recent.map(div => `
                    <tr>
                        <td>${new Date(div.date).toLocaleDateString('fr-FR', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td>$${div.dividend?.toFixed(3) || 'N/A'}</td>
                        <td>${new Date(div.recordDate || div.date).toLocaleDateString('fr-FR', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                        <td>${new Date(div.paymentDate || div.date).toLocaleDateString('fr-FR', { month: 'short', day: 'numeric', year: 'numeric' })}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading dividends:', error);
            }
        }

        // Back button
        backBtn.addEventListener('click', () => {
            searchView.style.display = 'block';
            stockDetailsView.classList.remove('active');
            currentSymbol = null;
            cachedData = {};
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Main tab switching
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // Preset cards
        document.querySelectorAll('.preset-card').forEach(card => {
            card.addEventListener('click', () => {
                const preset = card.dataset.preset;
                alert(`Screener "${preset}" sera bient√¥t disponible !`);
            });
        });

        console.log('üìä FMP Cache Stats:', fmpAPI.getCacheStats());
    </script>
</body>
</html>
